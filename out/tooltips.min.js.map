{"version":3,"file":"tooltips.min.js","sources":["../src/TUtilsV2.ts","../src/API.ts","../src/APICache.ts","../src/FactsProcessor.ts","../src/Collect.ts","../src/Inflators.ts","../src/TooltipsV2.ts"],"sourcesContent":["type HTMLElementMap = HTMLElementTagNameMap & {\r\n\t[k in string] : HTMLElement // just so we can produce arbitrary tags\r\n};\r\n\r\n/** @param spec expected to be of shape tagname[.class1[.class2[...]]] */\r\nexport function newElm<T extends keyof HTMLElementMap>(spec : T, ...inner : (string | Node)[]) : HTMLElementMap[T] {\r\n\tconst [tag, ...classes] = spec.split('.');\r\n\tconst el = document.createElement(tag);\r\n\tif(classes.length) el.classList.add(...classes);\r\n\tif(inner.length) el.append(...inner);\r\n\treturn el as HTMLElementMap[T]\r\n}\r\n\r\nexport const IMAGE_CDN = 'https://assets.gw2dat.com/'\r\nconst missingImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHEAAABuCAIAAACfnGvJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAMCSURBVHhe7ZjpkeowEAaJywERD9GQDMGwumyPLj+2XssH+/UPyjMjjVBjUWXf3oJGTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSU51inr8d0u02PVwp/xf/MHQvt9Hm/Be7PlMgIHhyzCjn9hNlpc7ebxe9hhNPp8QifpTdfuz9Oe3thjHH6Cndkfv7DWb0/syNbnN8QJuzkZr5q5K+Xk2C6BtbCTDEAZJDTuIfKi0tUKuZgHhBx89P1Zj5rtK4YQzspL43z6RnltFBR5DMVKVhGFPTy3UYBO6vo0GuIMcxpvs1O2gbhei0tbOazRusvmCe+x6nddDtbBA4/LmEFNfN1o57TOD0F5ZIDGOh0CbL91SrqDYZ07iiQ5etGdrxNpGkz9XowQ53GG2Sa7H5rFc095n1W1nzdqOPUXzbXGMVYp1FqlqlVxMCNXEd9kG806t2n87cw2KE4g53mO/fUKrJgxkzp5Ou5Paf//E4wtNPzUelupki+32k8+cZgMDpQ6V9w6ij+UAeee8/fcLovcsojpzxyyiOnPHLKI6c8csqDOx39MH0B5JRHTnmGO00v2uKLi0B8e7E8ghf+7aP5RimyDrC1ga9HPmIXp2ajy95tvEhwUaHJlpaouUandgD7OF3MpHijbrAlf13MmsOwoulQxruzu9NfGLClvtO6QTF2d87mNISWuWT7ZGtUMwJy2nLVKK2YBcqGx3Mmp+XUomQqGUcf9YpT3afZ2BBUoWFpElqYnm7ooY5P9n8a9QRcDz83lfylFdVcJnGoUAfudAjlD+FopM7CNZy27/aTKr2KU4c93Y6jD/gG13F6HeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklOb9/gEv6oxxwmIw6QAAAABJRU5ErkJggg==';\r\nexport function newImg(src? : string | number, className? : string, alt? : string) : HTMLImageElement {\r\n\tif(typeof src == 'number') src = src + '.png'\r\n\t\r\n\tconst img = document.createElement('img')\r\n\t//NOTE(Rennorb): Full urls specify a protocol which is delilited by a colon. Not perferct but good enough for now.  https_:_ , data_:_image\r\n\timg.src = src ? (src.includes(':') ? src : IMAGE_CDN + src) : missingImage;\r\n\tif(className) img.classList.add(className)\r\n\timg.alt = alt ? alt+' icon' : 'icon';\r\n\treturn img;\r\n}\r\n\r\nexport function fromHTML(html : string) : DocumentFragment {\r\n\tconst dummy = document.createElement('template');\r\n\tdummy.innerHTML = html;\r\n\treturn dummy.content;\r\n}\r\n\r\nexport const GW2Text2HTML = (text? : string, ...formatArgs : string[]) => text\r\n\t? text\r\n\t\t.replaceAll(/<c=(#.*?)>(.*?)<\\/c>/g, `<span style=\"color: $1;\">$2</span>`)\r\n\t\t.replaceAll(/<c=@(.*?)>(.*?)<\\/c>/g, `<span class=\"gw2-color-$1\">$2</span>`)\r\n\t\t.replaceAll('[lbracket]', '[').replaceAll('[rbracket]', ']')\r\n\t\t.replaceAll('[null]', '')\r\n\t\t.replaceAll('\\n', '<br />')\r\n\t\t.replaceAll(/%str\\d%/g, (_, i) => formatArgs[+i - 1] || '')\r\n\t\t.replaceAll('%%', '%')\r\n\t: '';\r\n\r\nexport const resolveInflections = (text : string, count : number, character : Character) => text\r\n\t.replaceAll('[s]', count > 1 ? 's' : '')\r\n\t.replaceAll(/(\\S+)\\[pl:\"(.+?)\"]/g, count > 1 ? '$2' : '$1')\r\n\t.replaceAll(/(\\S+)\\[f:\"(.+?)\"]/g, character.sex == \"Female\" ? '$2' : '$1');\r\n\r\nexport function n3(v : number) { return withUpToNDigits(v, 3); }\r\nexport function withUpToNDigits(x : number, digits : number) {\r\n\tlet str = x.toFixed(digits);\r\n\twhile(str.charAt(str.length - 1) === '0') str = str.slice(0, -1);\r\n\tif(str.charAt(str.length - 1) === '.') str = str.slice(0, -1);\r\n\treturn str;\r\n}\r\n\r\n//TODO(Rennorb) @cleanup @rename\r\nexport function drawFractional(value : number, config : Config) {\r\n\tif (!config.showPreciseAbilityTimings) {\r\n\t\tconst sign = value < 0 ? '-' : '';\r\n\t\tvalue = Math.abs(value);\r\n\t\tconst index = (Math.min(Math.round((value % 1) * 4), 4));\r\n\t\tlet fraction = '';\r\n\t\tswitch (index) {\r\n\t\t\tcase 0: \r\n\t\t\tcase 4:\r\n\t\t\t{\r\n\t\t\t\tvalue = Math.round(value);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase 1: {\r\n\t\t\t\tvalue = Math.floor(value);\r\n\t\t\t\tfraction = '¼';\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase 2: {\r\n\t\t\t\tvalue = Math.floor(value);\r\n\t\t\t\tfraction = '½';\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase 3: {\r\n\t\t\t\tvalue = Math.floor(value);\r\n\t\t\t\tfraction = '¾';\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(value == 0 && fraction == '') {\r\n\t\t\treturn '0';\r\n\t\t}\r\n\t\treturn `${sign}${value > 0 ? value : ''}${fraction}`;\r\n\t} else {\r\n\t\treturn withUpToNDigits(value, 3);\r\n\t}\r\n}\r\n\r\n//TODO(rennorb) @cleanup: rename\r\nexport function mapLocale<T_ extends string>(type : BaseAttribute | ComputedAttribute | API.ComboFinisherType | API.ComboFieldType | API.Palette['weapon_type'] | T_) {\r\n\tswitch (type) {\r\n\t\tcase 'ConditionDuration': return 'Condition Duration';\r\n\t\tcase 'ConditionDamage'  : return 'Condition Damage';\r\n\t\tcase 'HealingPower'     : return 'Healing Power';\r\n\t\tcase 'BowLong'          : return 'Longbow';\r\n\t\tcase 'BowShort'         : return 'Shortbow';\r\n\t\tcase 'Projectile20'     : return 'Projectile (20% Chance)';\r\n\t\tcase 'MagicFind'        : return 'Magic Find';\r\n\t\tcase 'CritChance'       : return 'Critical Chance';\r\n\t\tcase 'CritDamage'       : return 'Critical Damage';\r\n\t\tcase 'BoonDuration'     : return 'Boon Duration';\r\n\t\tdefault: return type;\r\n\t}\r\n}\r\n\r\nexport function findSelfOrParent(self : Element, selector : string, depth = 10) : Element | null {\r\n\tlet current : Element | null = self;\r\n\twhile(current && depth-- > 0 && !current.matches(selector)) current = current.parentElement;\r\n\tif(depth == 0) return null;\r\n\treturn current;\r\n}\r\n\r\nexport function joinWordList(words : string[], quoteWords = false) {\r\n\tif(quoteWords) words = words.map(w => `'${w}'`);\r\n\tswitch(words.length) {\r\n\t\tcase 0: return '';\r\n\t\tcase 1: return words[0];\r\n\t\tdefault:\r\n\t\t\tconst last = words[words.length - 1];\r\n\t\t\treturn words.slice(0, -1).join(', ') + last;\r\n\t}\r\n}\r\n","//NOTE(Rennorb): The different API implementations exist to easily swap out the data source for a local one, or even the official api in theory.\r\n// If the API is not set on APICache it will set it to HSAPI on the first request to the cache.\r\n// This can be done by specifying the apiImpl config option.\r\n//TODO(Rennorb): readme\r\n\r\nexport class FakeAPI implements APIImplementation {\r\n\thsApi    = new HSAPI('http://127.0.0.1:3000');\r\n\tfallback = new HSAPI(); // since we now have a public api running we can jsut fall back to that\r\n\r\n\tasync bulkRequest<T extends keyof APIResponseTypeMap>(endpoint: T, ids: number[]): Promise<APIResponseTypeMap[T][]> {\r\n\t\ttry {\r\n\t\t\treturn await this.hsApi.bulkRequest(endpoint, ids);\r\n\t\t}\r\n\t\tcatch(ex) {\r\n\t\t\tconsole.warn(`[gw2-tooltips] [FakeAPI] error trying to get ep '${endpoint}' from localhost, will try to use the fallback API.\\n${ex}`);\r\n\t\t\treturn await this.fallback.bulkRequest(endpoint, ids);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class HSAPI implements APIImplementation {\r\n\tbaseUrl : string;\r\n\r\n\tpublic constructor(baseUrl : string = 'https://api-v0.hardstuck.gg') {\r\n\t\tthis.baseUrl = baseUrl;\r\n\t}\r\n\r\n\tasync bulkRequest<T extends keyof APIResponseTypeMap>(endpoint : T, ids : number[]) : Promise<APIResponseTypeMap[T][]> {\r\n\t\treturn fetch(`${this.baseUrl}/${endpoint}?ids=${ids.join(',')}`).then(r => r.json());\r\n\t}\r\n}\r\n","export default class APICache {\r\n\tstatic storage : ObjectDataStorage = {\r\n\t\tskills         : new Map<number, API.Skill>(),\r\n\t\titems          : new Map<number, API.Item>(),\r\n\t\ttraits         : new Map<number, API.Trait>(),\r\n\t\tpets           : new Map<number, OfficialAPI.Pet>(),\r\n\t\t'pvp/amulets'  : new Map<number, API.ItemAmulet>(),\r\n\t\tspecializations: new Map<number, OfficialAPI.Specialization>(),\r\n\t\titemstats      : new Map<number, API.AttributeSet>(),\r\n\t}\r\n\r\n\tstatic apiImpl : APIImplementation\r\n\r\n\t//TODO(Rennorb): add option to api to send hybrid request to get all related information for a page\r\n\t/** This might actually fetch more data than just the ids specified and ensures that all data required to display the ids is available */\r\n\tstatic async ensureExistence<T extends Endpoints>(endpoint : T, initialIds : IterableIterator<number>) : Promise<void> {\r\n\t\tif(!this.apiImpl) {\r\n\t\t\tthis.apiImpl = new HSAPI()\r\n\t\t}\r\n\r\n\t\tlet additionalIds : { [k in Endpoints] : Set<number> } = Object.assign({\r\n\t\t\tskills         : new Set<number>(),\r\n\t\t\titems          : new Set<number>(),\r\n\t\t\ttraits         : new Set<number>(),\r\n\t\t\tpets           : new Set<number>(),\r\n\t\t\t'pvp/amulets'  : new Set<number>(),\r\n\t\t\tspecializations: new Set<number>(),\r\n\t\t\titemstats      : new Set<number>(),\r\n\t\t}, { [endpoint]: new Set(initialIds) })\r\n\r\n\t\tconst findNextRelevantEndpoint = () => {\r\n\t\t\tfor(const [endpoint, ids] of Object.entries(additionalIds))\r\n\t\t\t\tif(ids.size > 0)\r\n\t\t\t\t\treturn endpoint\r\n\t\t\treturn undefined\r\n\t\t}\r\n\r\n\t\tlet currentEndpoint : Endpoints | undefined = endpoint\r\n\t\tlet i = 0\r\n\t\tdo {\r\n\r\n\t\t\tconst storageSet = this.storage[currentEndpoint]\r\n\t\t\t//TODO(Rennorb): i really don't like this but it seems to be the most sensible way for now\r\n\t\t\tconst request = Array.from(additionalIds[currentEndpoint].values())\r\n\t\t\tadditionalIds[currentEndpoint].clear()\r\n\r\n\t\t\tconsole.info(`[gw2-tooltips] [API cache] round #${i++} for a ${endpoint} request, currently fetching ${currentEndpoint}. Ids: `, request)\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst response = await this.apiImpl.bulkRequest(currentEndpoint, request)\r\n\t\t\t\t//TODO(Rennorb) @perf: provide option to disable this\r\n\t\t\t\tconst unobtainable = request.filter(id => !response.some(obj => obj.id == id))\r\n\t\t\t\tif(unobtainable.length) console.warn(`[gw2-tooltips] [API cache] Did not receive all requested ${currentEndpoint} ids. missing: `, unobtainable);\r\n\r\n\t\t\t\tfor(const datum of response) {\r\n\t\t\t\t\tif(storageSet.has(datum.id)) continue\r\n\r\n\t\t\t\t\tstorageSet.set(datum.id, datum as any) //TODO\r\n\t\t\t\t\tthis.collectConnectedIds({ endpoint: currentEndpoint, datum } as any, additionalIds)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tcatch(ex) {\r\n\t\t\t\tconsole.error(ex)\r\n\t\t\t}\r\n\t\t} while((currentEndpoint = findNextRelevantEndpoint()) && i < 100)\r\n\t}\r\n\r\n\tstatic collectConnectedIds({ endpoint, datum } : ConnectedIdDatum, connectedIdsStorage : { [k in Endpoints] : Set<number> }) : void {\r\n\t\tconst addFacts = (facts : API.Fact[]) => {\r\n\t\t\tfor(const fact of facts) {\r\n\t\t\t\tif(fact.type == 'Buff' || fact.type == 'BuffBrief') {\r\n\t\t\t\t\tif(!this.storage.skills.has(fact.buff))\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(fact.buff) // TODO(Rennorb) @correctness: are we sure about using the skill endpoint for this?\r\n\t\t\t\t}\r\n\t\t\t\tif(fact.type === 'PrefixedBuffBrief' || fact.type === 'PrefixedBuff') {\r\n\t\t\t\t\tif(!this.storage.skills.has(fact.prefix))\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(fact.prefix)\r\n\t\t\t\t\tif(!this.storage.skills.has(fact.buff))\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(fact.buff)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif('palettes' in datum) {\r\n\t\t\tfor(const palette of datum.palettes) {\r\n\t\t\t\tfor(const slot of palette.slots) {\r\n\t\t\t\t\tif(slot.profession !== 'None' && slot.next_chain && !this.storage.items.has(slot.next_chain)) {\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(slot.next_chain)\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//TODO(Rennorb) @perf: This could be improved if we knew if th corresponding class is actually set on the source object to even do the replacement that we fetch these for.\r\n\t\t\t\t\tif(slot.traited_alternatives) for(const [_, skillId] of slot.traited_alternatives) {\r\n\t\t\t\t\t\tif(!this.storage.skills.has(skillId))\r\n\t\t\t\t\t\t\tconnectedIdsStorage.skills.add(skillId);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif('related_skills' in datum) {\r\n\t\t\tfor(const subSkill of datum.related_skills!)\r\n\t\t\t\tif(!this.storage.skills.has(subSkill))\r\n\t\t\t\t\tconnectedIdsStorage.skills.add(subSkill);\r\n\t\t}\r\n\r\n\t\tif('blocks' in datum) for(const block of datum.blocks!) {\r\n\t\t\tif(block.facts)\r\n\t\t\t\taddFacts(block.facts);\r\n\t\t}\r\n\r\n\t\tif('override_groups' in datum) {\r\n\t\t\tfor(const { blocks } of datum.override_groups!)\r\n\t\t\t\tif(blocks) for(const block of blocks!)\r\n\t\t\t\t\tif(block.facts)\r\n\t\t\t\t\t\taddFacts(block.facts);\r\n\t\t}\r\n\r\n\t\tif('attribute_set' in datum) {\r\n\t\t\tif(!this.storage.itemstats.has(datum.attribute_set!))\r\n\t\t\t\tconnectedIdsStorage.itemstats.add(datum.attribute_set!);\r\n\t\t}\r\n\r\n\t\tif('skills' in datum) for(const { id: subSkillId } of datum.skills) {\r\n\t\t\tif(!this.storage.skills.has(subSkillId))\r\n\t\t\t\tconnectedIdsStorage.skills.add(subSkillId);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb) @cleanup: disgusting\r\ntype ConnectedIdDatum = {\r\n\tendpoint : 'skills'\r\n\tdatum    : APIResponseTypeMap['skills']\r\n} | {\r\n\tendpoint : 'traits'\r\n\tdatum    : APIResponseTypeMap['traits']\r\n} | {\r\n\tendpoint : 'items'\r\n\tdatum    : APIResponseTypeMap['items']\r\n} | {\r\n\tendpoint : 'specializations'\r\n\tdatum    : APIResponseTypeMap['specializations']\r\n} | {\r\n\tendpoint : 'pets'\r\n\tdatum    : APIResponseTypeMap['pets']\r\n} | {\r\n\tendpoint : 'pvp/amulets'\r\n\tdatum    : APIResponseTypeMap['pvp/amulets']\r\n} | {\r\n\tendpoint : 'itemstats'\r\n\tdatum    : APIResponseTypeMap['itemstats']\r\n}\r\n\r\n(window as any).APICache = APICache; //@debug\r\n\r\nimport { HSAPI } from './API';\r\n","export function calculateModifier(\r\n\t{ formula, base_amount, formula_param1: level_scaling, formula_param2 } : API.Modifier,\r\n\t{ level, stats: { Power, ConditionDamage, HealingPower }} : Character,\r\n) {\r\n\t//TODO(Rennorb): this is **screaming** tabledrive me\r\n\t//TODO(Rennorb) @correctness: attribute conversion e.g. Bountiful Maintenance Oil\r\n\tswitch (formula) {\r\n\t\tcase 'BuffLevelLinear':\r\n\t\t\treturn         level * level_scaling + base_amount\r\n\t\tcase 'ConditionDamage':\r\n\t\t\treturn         level * level_scaling + base_amount + ConditionDamage * formula_param2\r\n\t\tcase 'ConditionDamageSquared':\r\n\t\t\treturn level * level * level_scaling + base_amount + ConditionDamage * formula_param2\r\n\t\tcase 'NoScaling':\r\n\t\t\treturn                                 base_amount\r\n\t\tcase 'Regeneration':\r\n\t\t\treturn         level * level_scaling + base_amount + HealingPower * formula_param2\r\n\t\tcase 'RegenerationSquared':\r\n\t\t\treturn level * level * level_scaling + base_amount + HealingPower * formula_param2\r\n\t\tcase 'SpawnScaleLinear':\r\n\t\tcase 'TargetLevelLinear':\r\n\t\t\treturn         level * level_scaling + base_amount\r\n\t\tcase 'BuffFormulaType11':\r\n\t\t\treturn         level * level_scaling + base_amount - formula_param2\r\n\t\tcase 'Power':\r\n\t\t\treturn         level * level_scaling + base_amount + Power * formula_param2\r\n\t\tcase 'PowerSquared':\r\n\t\t\treturn level * level * level_scaling + base_amount + Power * formula_param2\r\n\t}\r\n\r\n\tconsole.warn('[gw2-tooltips] [facts processor] Could not find formula #', formula, ', using base amount for now!')\r\n\treturn base_amount; //TODO(Rennorb) @correctness\r\n}\r\n\r\n/** @param facts should already be context resolved */\r\nexport function generateFacts(blocks : API.FactBlock[], weaponStrength : number, context : Context) : HTMLElement[] {\r\n\tconst [looseBlock, ...remainingBlocks] = blocks;\r\n\tlet totalDefianceBreak = 0\r\n\r\n\tconst makeFactElements = (facts : API.Fact[] | undefined) => (!facts ? [] : facts\r\n\t\t.sort((a, b) => a.order - b.order)\r\n\t\t.map(fact => {\r\n\t\t\tconst { wrapper, defiance_break } = generateFact(fact, weaponStrength, context);\r\n\t\t\ttotalDefianceBreak += defiance_break;\r\n\t\t\treturn wrapper;\r\n\t\t})\r\n\t\t.filter(d => d) as HTMLElement[] // ts doesn't understand what the predicate does\r\n\t);\r\n\r\n\tconst elements = [];\r\n\tfor(const block of remainingBlocks) {\r\n\t\tconst wrapper = newElm('div.fact-block');\r\n\t\tif(block.trait_requirements) {\r\n\t\t\t//NOTE(Rennorb): If the trait is manually set on the object then we don't have it cached, so we just use the id if we don't have a name.\r\n\t\t\tconst trait_names = joinWordList(block.trait_requirements.map(id => `'<span class=\"gw2-color-traited-fact\">${APICache.storage.traits.get(id)?.name || id}</span>'`))\r\n\t\t\twrapper.append(fromHTML(`<span class=\"detail\">Block exists because of trait${block.trait_requirements.length == 1 ? '' : 's'} ${trait_names}</span>`));\r\n\t\t}\r\n\t\tif(block.description) wrapper.append(newElm('p.description', fromHTML(GW2Text2HTML(block.description))));\r\n\r\n\t\tconst blockFacts = makeFactElements(block.facts);\r\n\t\twrapper.append(...blockFacts);\r\n\r\n\t\telements.push(wrapper);\r\n\t}\r\n\r\n\tif(looseBlock) elements.push(...makeFactElements(looseBlock.facts));\r\n\r\n\t//TODO(Rennorb): This should use order 1003\r\n\tif(totalDefianceBreak > 0) {\r\n\t\tconst defianceWrap = newElm('div.fact',\r\n\t\t\tnewImg(ICONS.DEFIANCE_BREAK, 'iconmed'),\r\n\t\t\tnewElm('div.gw2-color-defiance-fact', `Defiance Break: ${withUpToNDigits(totalDefianceBreak, 2)}`)\r\n\t\t);\r\n\t\telements.push(defianceWrap);\r\n\t}\r\n\r\n\treturn elements\r\n}\r\n\r\n/** @param fact should already be context resolved */\r\nexport function generateFact(fact : API.Fact, weapon_strength : number, context : Context) : { wrapper? : HTMLElement, defiance_break : number } {\r\n\tlet iconSlug : Parameters<typeof newImg>[0] = fact.icon;\r\n\tlet buffStackSize = 1;\r\n\tlet buffDuration = (fact as API.BuffFact).duration;\r\n\r\n\tconst generateBuffDescription = (buff : API.Skill, fact : API.BuffFact | API.PrefixedBuffFact, duration : Milliseconds, valueMod : number  /* TODO(Rennorb): kindof a weird hack for now. maybe merge the two export functions? */) => {\r\n\t\tlet modsArray: string[] = []\r\n\t\tif(buff.modifiers && !buff.description_brief) { // early bail to not have to do the work if we use the description anyways\r\n\t\t\t//TODO(Rennorb) @consistency: gamemode splitting for mods (?)\r\n\t\t\tconst relevantModifiers = buff.modifiers.filter(modifier => (\r\n\t\t\t\t\t\t(!modifier.trait_req || context.character.traits.includes(modifier.trait_req))\r\n\t\t\t\t&& (!modifier.mode || modifier.mode === context.gameMode)\r\n\t\t\t));\r\n\r\n\t\t\t//NOTE(Rennorb): Modifiers can 'stack'. For that reason we need to first collect the values and then create text from that, otherwise we get duplicates.\r\n\t\t\tlet modsMap = new Map<number, { modifier : API.Modifier, value : number }>();\r\n\t\t\tfor (let i = 0; i < relevantModifiers.length; i++) {\r\n\t\t\t\tconst modifier = relevantModifiers[i];\r\n\r\n\t\t\t\tlet entry = modsMap.get(modifier.id) || modsMap.set(modifier.id, { modifier: modifier, value: 0 }).get(modifier.id);\r\n\t\t\t\tlet value = calculateModifier(modifier, context.character);\r\n\t\t\t\tif (modifier.attribute_conversion) {\r\n\t\t\t\t\t\tvalue *= context.character.stats[modifier.attribute_conversion];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tentry!.value += value;\r\n\r\n\t\t\t\tif(modifier.flags.includes('SkipNextEntry')) {\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor(let { value, modifier } of modsMap.values()) {\r\n\t\t\t\tif(modifier.flags.includes('Subtract')) {\r\n\t\t\t\t\tvalue -= 100;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(modifier.flags.includes('MulByDuration')) {\r\n\t\t\t\t\tduration /= 1000;\r\n\t\t\t\t\tif(modifier.flags.includes('DivDurationBy3')) { //TODO(Rennorb): move to api side and remove this\r\n\t\t\t\t\t\tduration /= 3;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(modifier.flags.includes('DivDurationBy10')) { //TODO(Rennorb): move to api side and remove this\r\n\t\t\t\t\t\tduration /= 10;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvalue *= duration || 1;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(!modifier.flags.includes('NonStacking')) {\r\n\t\t\t\t\tvalue *= fact.apply_count;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(modifier.formula.includes('Regeneration'))\r\n\t\t\t\t\tvalue *= valueMod;\r\n\r\n\t\t\t\tlet strValue = modifier.flags.includes('FormatFraction')\r\n\t\t\t\t\t? drawFractional(value, config)\r\n\t\t\t\t\t: Math.floor(Math.fround(value)).toString();\r\n\r\n\t\t\t\tif(modifier.flags.includes('FormatPercent')) {\r\n\t\t\t\t\tif(value > 0 ) {\r\n\t\t\t\t\t\tstrValue = '+' + strValue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tstrValue += '%'\r\n\t\t\t\t}\r\n\t\t\t\tstrValue += ' ' + modifier.description;\r\n\r\n\t\t\t\tmodsArray.push(strValue);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn GW2Text2HTML(buff.description_brief || modsArray.join(', ') || buff.description)\r\n\t}\r\n\r\n\tconst applyMods = (duration : Milliseconds, buff : API.Skill, detailStack : (string | Node)[]) : [Milliseconds, number] => {\r\n\t\tlet durMod = 1, valueMod = 1;\r\n\t\tconst durationAttr : keyof Stats | false = (buff.buff_type == 'Boon' && 'Concentration') || (buff.buff_type == 'Condition' && 'Expertise');\r\n\t\tif(durationAttr) {\r\n\t\t\tconst attribVal = context.character.stats[durationAttr];\r\n\t\t\t// every 15 points add 1%\r\n\t\t\tdurMod += attribVal / 15 * 0.01;\r\n\t\t\tif(attribVal > 0 && config.showFactComputationDetail) {\r\n\t\t\t\tdetailStack.push(`base duration: ${n3(duration / 1000)}s`);\r\n\t\t\t\tdetailStack.push(`+${n3(attribVal / 15)}% from ${n3(attribVal)} ${durationAttr}`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//TODO(Rennorb) @correctness: this is probably not quite stable, but its good enough for now\r\n\t\tlet durModStack = context.character.statSources[buff.id];\r\n\t\tif(durModStack) {\r\n\t\t\t//NOTE(Rennorb): Just in case we didn't have a stat duration increase. Im aware that this is jank, but i cant think of a better way rn.\r\n\t\t\tif(durMod === 1 && config.showFactComputationDetail) detailStack.push(`base duration: ${n3(duration / 1000)}s`);\r\n\t\t\tlet percentMod = 0;\r\n\t\t\tfor(const { source, modifier, count } of durModStack) {\r\n\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tdetailStack.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} ` : ''}`, fromHTML(resolveInflections(source, count, context.character)))); //TODO(Rennorb) @cleanup: im not really happy with how this works right now. Storing html in the text is not what i like to do but it works for now. Multiple of this.\r\n\t\t\t\tpercentMod += mod;\r\n\t\t\t}\r\n\t\t\tdurMod += percentMod / 100;\r\n\t\t}\r\n\t\tduration *= durMod;\r\n\r\n\t\tif(buff.name.includes('Regeneration')) {\r\n\t\t\tlet valueModStack = context.character.statSources.HealEffectiveness;\r\n\t\t\tif(valueModStack.length) {\r\n\t\t\t\t//TODO(Rennorb)\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tdetailStack.push('regeneration value mods:');\r\n\t\t\t\tlet percentMod = 0;\r\n\t\t\t\tfor(const { source, modifier, count } of valueModStack) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tdetailStack.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} ` : ''}`, fromHTML(resolveInflections(source, count, context.character))));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tvalueMod += percentMod / 100;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\treturn [duration, valueMod];\r\n\t}\r\n\r\n\tconst factInflators : { [k in typeof fact.type] : (params : HandlerParams<API.FactMap[k]>) => (string|Node)[] } = {\r\n\t\tAdjustByAttributeAndLevelHealing : ({fact}) =>  {\r\n\t\t\tconst attributeVal = (context.character.stats as any)[fact.target] || 0;\r\n\t\t\tlet value = (fact.value + attributeVal * fact.attribute_multiplier + context.character.level ** fact.level_exponent * fact.level_multiplier) * fact.hit_count;\r\n\r\n\t\t\tconst lines = [];\r\n\r\n\t\t\tif(config.showFactComputationDetail) {\r\n\t\t\t\tlines.push(`${n3(fact.value)} base value`);\r\n\t\t\t\tif(fact.level_multiplier) lines.push(`+ ${n3(context.character.level ** fact.level_exponent * fact.level_multiplier)} from lvl ${context.character.level} ^ ${n3(fact.level_exponent)} lvl exp. * ${n3(fact.level_multiplier)} lvl mul.`);\r\n\t\t\t\tif(attributeVal) lines.push(`+ ${n3(attributeVal * fact.attribute_multiplier)} from ${n3(attributeVal)} ${mapLocale(fact.target)} * ${n3(fact.attribute_multiplier)} attrib. mod.`);\r\n\t\t\t\tif(fact.hit_count != 1) lines.push(` * ${fact.hit_count} hits`);\r\n\t\t\t}\r\n\r\n\t\t\tif(!fact.text?.includes('Barrier')) { //TODO(Rennorb) @cleanup @correctness\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.HealEffectiveness) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} `: ''}`, fromHTML(resolveInflections(source, count, context.character))));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tvalue *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\tlines.unshift(`${GW2Text2HTML(fact.text) || mapLocale(fact.target)}: ${Math.round(value)}`);\r\n\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tAttributeAdjust : ({fact}) => {\r\n\t\t\tconst value = Math.round((fact.range[1] - fact.range[0]) / (context.character.level / 80) + fact.range[0]);\r\n\t\t\tconst sign = value > 0 ? '+' : ''\r\n\t\t\tconst text = GW2Text2HTML(fact.text) || mapLocale(fact.target);\r\n\t\t\treturn [`${text}: ${sign}${value}`];\r\n\t\t},\r\n\t\tBuff : ({fact, buff}) =>  {\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MISSING_BUFF; // in case we didn't get the buff we wanted from the api\r\n\t\t\ticonSlug = buff.icon || iconSlug;\r\n\r\n\t\t\tconst lines : (string | Node)[] = [];\r\n\t\t\tlet valueMod;\r\n\t\t\t[buffDuration, valueMod] = applyMods(fact.duration, buff, lines);\r\n\r\n\t\t\tlet buffDescription = generateBuffDescription(buff, fact, buffDuration, valueMod);\r\n\t\t\tif(buffDescription) {\r\n\t\t\t\tbuffDescription = `: ${buffDescription}`;\r\n\t\t\t}\r\n\r\n\t\t\tconst seconds = buffDuration > 0 ? `(${drawFractional(buffDuration / 1000, config)}s)`: '';\r\n\t\t\tlines.unshift(`${GW2Text2HTML(fact.text) || buff.name_brief || buff.name} ${seconds}${buffDescription}`);\r\n\r\n\t\t\tbuffStackSize = fact.apply_count;\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tBuffBrief : ({fact, buff}) =>  {\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MISSING_BUFF;\r\n\t\t\ticonSlug = buff.icon || iconSlug;\r\n\r\n\t\t\treturn [`${GW2Text2HTML(fact.text, buff.name)}`];\r\n\t\t},\r\n\t\tDistance : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${Math.round(fact.distance)}`];\r\n\t\t},\r\n\t\tHealthAdjustHealing: ({ fact }) => {\r\n\t\t\t//TODO(Rennorb) @scaling\r\n\t\t\tconst attribute = (context.character.stats as any)[fact.attribute] || 0;\r\n\t\t\tconst value = Math.round((fact.value + attribute * fact.multiplier) * fact.hit_count);\r\n\t\t\tconst text = GW2Text2HTML(fact.text) || mapLocale(fact.attribute);\r\n\r\n\t\t\treturn [`${text}: ${value}`];\r\n\t\t},\r\n\t\tNumber : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${drawFractional(fact.value, config)}`];\r\n\t\t},\r\n\t\tPercent : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${drawFractional(fact.percent, config)}%`];\r\n\t\t},\r\n\t\tPercentDamage : ({fact}) => {\r\n\t\t\t// TODO(mithos) game shows an actual raw number here. to implement this we need to get the characters damage\r\n\t\t\t//NOTE(Rennorb): this is going to be verry difficult if not impossible\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${drawFractional(fact.percent, config)}%`];\r\n\t\t},\r\n\t\tPercentLifeForceAdjust : ({fact: {percent, text}}) => {\r\n\t\t\tconst hpPool = context.character.stats.Health;\r\n\r\n\t\t\tconst lines = [];\r\n\t\t\tif(context.character.statSources.LifeForce.length) {\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tlines.push(`${n3(percent * hpPool * 0.69)} from ${n3(percent)}% * (${n3(hpPool)} HP * 0.69) base pool`);\r\n\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.LifeForce) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} ` : ''}`, fromHTML(resolveInflections(source, count, context.character))));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tpercent *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\t//NOTE(Rennorb): lifeforce is 69% of the hp pool\r\n\t\t\tlet raw = Math.round(hpPool * 0.69 * percent * 0.01);\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}: ${drawFractional(percent, config)}% (${raw})`);\r\n\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tPercentHealth : ({fact: {percent, text}}) => {\r\n\t\t\tconst raw = Math.round((context.character.stats.Health * percent) * 0.01);\r\n\t\t\treturn [`${GW2Text2HTML(text)}: ${drawFractional(percent, config)}% (${raw})`];\r\n\t\t},\r\n\t\t//TODO(Rennorb) @correctness: this seems to be verry much percent based. Whats the difference to PercentLifeForceAdjust here?\r\n\t\tLifeForceAdjust : ({fact: {percent, text}}) => {\r\n\t\t\tconst hpPool = context.character.stats.Health;\r\n\r\n\t\t\tconst lines = [];\r\n\t\t\tif(context.character.statSources.LifeForce.length) {\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tlines.push(`${n3(percent * 0.01 * hpPool * 0.69)} from ${n3(percent)}% * (${n3(hpPool)} HP * 0.69) base pool`);\r\n\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.LifeForce) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} ` : ''}`, fromHTML(resolveInflections(source, count, context.character))));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tpercent *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\t//NOTE(Rennorb): lifeforce is 69% of the hp pool\r\n\t\t\tlet raw = Math.round(hpPool * 0.69 * percent * 0.01);\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}: ${drawFractional(percent, config)}% (${raw})`);\r\n\t\t\t\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tDamage : ({fact: {dmg_multiplier, hit_count, text}, weaponStrength}) => {\r\n\t\t\tconst lines = [];\r\n\t\t\t\r\n\t\t\tlet damage = dmg_multiplier * hit_count * weaponStrength * context.character.stats.Power / context.targetArmor;\r\n\t\t\tif(config.showFactComputationDetail) {\r\n\t\t\t\tlines.push(`${n3(damage)} from ${n3(dmg_multiplier)} internal mod. * ${n3(context.character.stats.Power)} power * ${weaponStrength} avg. weapon str. / ${context.targetArmor} target armor`);\r\n\t\t\t\tif(hit_count != 1) lines.push(`* ${hit_count} hits`);\r\n\t\t\t}\r\n\r\n\t\t\t//TODO(Rennorb): level scaling attributes. these are for lvl 80\r\n\t\t\tconst critChance = Math.min(0.05 + (context.character.stats.Precision - 1000) / 21 * 0.01, 1);\r\n\t\t\t//TODO(Rennorb): crit damage mods\r\n\t\t\tconst critDamage = 1.5 + context.character.stats.Ferocity / 15 * 0.01;\r\n\t\t\tconst moreDmgFromCrit = damage * critChance * (critDamage - 1);\r\n\t\t\tdamage += moreDmgFromCrit;\r\n\t\t\tif(config.showFactComputationDetail) {\r\n\t\t\t\tlines.push(`+${n3(moreDmgFromCrit)} (${n3(critChance * (critDamage - 1) * 100)}%) from ${n3(critChance * 100)}% crit chance and ${n3(critDamage * 100)}% damage on crit (${n3(context.character.stats.Precision)} precision and ${n3(context.character.stats.Ferocity)} ferocity)`);\r\n\t\t\t}\r\n\r\n\t\t\tif(context.character.statSources.Damage.length) {\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.Damage) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} ` : ''}`, fromHTML(resolveInflections(source, count, context.character))));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tdamage *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\tconst times = hit_count > 1 ? `(${hit_count}x)` : '';\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}${times}: ${Math.round(damage)}`);\r\n\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tTime : ({fact: { duration, text }}) => {\r\n\t\t\tconst lines = [];\r\n\t\t\t//TODO(Rennorb) @cleanup\r\n\t\t\tif(text && (text.includes('Stun') || text.includes('Daze'))) {\r\n\t\t\t\tif(context.character.statSources.Stun.length) {\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(`${n3(duration / 1000)}s base duration`);\r\n\t\t\t\t\tlet percentMod = 100;\r\n\t\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.Stun) {\r\n\t\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${n3(mod)}% from ${count > 1 ? `${count} ` : ''}`, fromHTML(resolveInflections(source, count, context.character))));\r\n\t\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tduration *= percentMod / 100;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tconst time = duration != 1000 ? 'seconds' : 'second';\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}: ${drawFractional(duration / 1000, config)} ${time}`);\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tComboField : ({fact}) =>  {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${mapLocale(fact.field_type)}`];\r\n\t\t},\r\n\t\tComboFinisher : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${mapLocale(fact.finisher_type)}`];\r\n\t\t},\r\n\t\tBuffConversion : ({fact}) => {\r\n\t\t\treturn [`Gain ${mapLocale(fact.target)} Based on a Percentage of ${mapLocale(fact.source)}: ${fact.percent}%`];\r\n\t\t},\r\n\t\tNoData : ({fact}) => {\r\n\t\t\treturn [GW2Text2HTML(fact.text)];\r\n\t\t},\r\n\t\tPrefixedBuff : ({fact, buff}) => {\r\n\t\t\tlet prefix = APICache.storage.skills.get(fact.prefix);\r\n\t\t\tif(!prefix) console.error('[gw2-tooltips] [facts processor] prefix #', fact.prefix, ' is apparently missing in the cache');\r\n\t\t\tprefix = prefix || MISSING_BUFF;\r\n\t\t\ticonSlug = prefix.icon || iconSlug;\r\n\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MISSING_BUFF; // in case we didn't get the buff we wanted from the api\r\n\r\n\t\t\tlet {duration, apply_count, text} = fact;\r\n\r\n\t\t\tconst details : string[] = [];\r\n\t\t\tlet valueMod;\r\n\t\t\t[buffDuration, valueMod] = applyMods(duration, buff, details);\r\n\r\n\t\t\tlet buffDescription = generateBuffDescription(buff, fact, buffDuration, valueMod);\r\n\t\t\tif(buffDescription) {\r\n\t\t\t\tbuffDescription = `: ${buffDescription}`;\r\n\t\t\t}\r\n\r\n\t\t\tconst seconds = buffDuration > 0 ? `(${drawFractional(buffDuration / 1000, config)}s)`: '';\r\n\r\n\t\t\tconst list : (string|HTMLElement)[] = [newElm('div.fact', // class is just for styling\r\n\t\t\tgenerateBuffIcon(buff.icon, apply_count),\r\n\t\t\t\tnewElm('span', fromHTML(`${GW2Text2HTML(text) || buff.name_brief || buff.name} ${seconds}${buffDescription}`))\r\n\t\t\t)];\r\n\t\t\tlist.push(...details);\r\n\r\n\t\t\treturn list;\r\n\t\t},\r\n\t\tPrefixedBuffBrief : ({fact, buff}) => {\r\n\t\t\tlet prefix = APICache.storage.skills.get(fact.prefix)\r\n\t\t\tif(!prefix) console.error('[gw2-tooltips] [facts processor] prefix #', fact.prefix, ' is apparently missing in the cache');\r\n\t\t\tprefix = prefix || MISSING_BUFF;\r\n\t\t\ticonSlug = prefix.icon || iconSlug\r\n\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MISSING_BUFF; // in case we didn't get the buff we wanted from the api\r\n\r\n\t\t\tlet node = newElm('div.fact', // class is just for styling\r\n\t\t\t\tnewImg(buff.icon),\r\n\t\t\t\tnewElm('span', `${GW2Text2HTML(fact.text) || buff.name_brief || buff.name}`)\r\n\t\t\t);\r\n\r\n\t\t\treturn [node]\r\n\t\t},\r\n\t\tRange : ({fact: {min, max}}) => {\r\n\t\t\treturn [`Range: ${min ? `${min} - ${max}` : max}`];\r\n\t\t},\r\n\t\tStunBreak : () => {\r\n\t\t\treturn [\"Breaks Stun\"];\r\n\t\t},\r\n\t}\r\n\r\n\tconst buff = APICache.storage.skills.get((fact as API.BuffFact).buff || 0)\r\n\tconst data : HandlerParams = { fact, buff, weaponStrength: weapon_strength }\r\n\tconst [firstLine, ...remainingDetail] = factInflators[fact.type](data as any)\r\n\tconst wrapper = newElm('div.fact')\r\n\tif(fact.requires_trait) {\r\n\t\twrapper.classList.add('gw2-color-traited-fact')\r\n\t}\r\n\r\n\tlet defianceBreak = 0;\r\n\tif(fact.defiance_break) {\r\n\t\tdefianceBreak = fact.defiance_break * (buffDuration || 1000) / 1000;\r\n\t\tconst breakDetail = (buffDuration != undefined && buffDuration != 1000) ? ` (${fact.defiance_break}/s)` : '';\r\n\t\tremainingDetail.push(newElm('span.detail.gw2-color-defiance-fact', `Defiance Break: ${withUpToNDigits(defianceBreak, 2)}${breakDetail}`))\r\n\t}\r\n\r\n\tif(fact.requires_trait) {\r\n\t\t//NOTE(Rennorb): If the trait is manually set on the object then we don't have it cached, so we just use the id if we don't have a name.\r\n\t\tconst trait_names = joinWordList(fact.requires_trait.map(id => `'<span class=\"gw2-color-traited-fact\">${APICache.storage.traits.get(id)?.name || id}</span>'`))\r\n\t\tremainingDetail.unshift(fromHTML(`<span class=\"detail\">${fact.skip_next ? 'overridden' : 'exists'} because of trait${fact.requires_trait.length == 1 ? '' : 's'} ${trait_names}</span>`));\r\n\t}\r\n\r\n\twrapper.append(generateBuffIcon(iconSlug, buffStackSize))\r\n\twrapper.append(newElm('div',\r\n\t\tnewElm('span', typeof firstLine == 'string' && firstLine.includes('<') ? fromHTML(firstLine) : firstLine), //parsing is expensive, don't just always do it\r\n\t\t...remainingDetail.map(d => typeof d == 'string' ? newElm('span.detail', d) : d))\r\n\t\t);\r\n\r\n\treturn { wrapper, defiance_break: defianceBreak }\r\n}\r\n\r\nexport function generateBuffIcon(icon : Parameters<typeof newImg>[0], stackSize = 1) : HTMLElement {\r\n\tconst img = newImg(icon);\r\n\tif(stackSize == 1) {\r\n\t\treturn img;\r\n\t}\r\n\telse {\r\n\t\tconst wrap = newElm('span.buff-ico', img);\r\n\t\twrap.setAttribute('count', String(stackSize));\r\n\t\treturn wrap;\r\n\t}\r\n}\r\n\r\nexport const MISSING_BUFF : API.Skill = {\r\n\tid         : 0,\r\n\tname       : 'Missing Buff',\r\n\tdescription: '<c=@warning>This Buff failed to load</c>',\r\n\tcategories : [], palettes   : [], modifiers  : [],\r\n}\r\nexport const MISSING_SKILL : API.Skill = {\r\n\tid         : 0,\r\n\tname       : 'Missing Skill',\r\n\tdescription: '<c=@warning>This Skill failed to load</c>',\r\n\tcategories : [], palettes   : [], modifiers  : [],\r\n}\r\n\r\nimport { newElm, newImg, drawFractional, GW2Text2HTML, withUpToNDigits, mapLocale, joinWordList, fromHTML, n3, resolveInflections } from './TUtilsV2';\r\nimport APICache from './APICache';\r\nimport { ICONS, config } from './TooltipsV2';\r\n","export function allUpgradeCounts(scope : ScopeElement, mode : CollectMode = CollectMode.Append) {\r\n\tconst elements = scope.getElementsByTagName('gw2object');\r\n\tfor(const pair of contexts.entries()) {\r\n\t\tconst elsInCorrectCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) == pair[0]);\r\n\t\tif(elsInCorrectCtx.length)\r\n\t\t\t_upgradeCounts(...pair, elsInCorrectCtx, mode);\r\n\t}\r\n\t//TODO(Rennorb): rethink this or at least make it uniform\r\n\tconst elsWithWrongCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) >= contexts.length);\r\n\tif(elsWithWrongCtx.length) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] Some targets in scope \", scope, \" have the wrong context: \", elsWithWrongCtx);\r\n\t}\r\n}\r\nexport function specificUpgradeCounts(contextIndex : number, targetContext : Context, scope : ScopeElement, mode : CollectMode = CollectMode.Append) {\r\n\t_upgradeCounts(contextIndex, targetContext, scope.getElementsByTagName('gw2object'), mode);\r\n}\r\nfunction _upgradeCounts(contextIndex : number, targetContext : Context, elements : Iterable<Element>, mode : CollectMode) {\r\n\tconst counts : Character['upgradeCounts'] = {};\r\n\r\n\tfor(const element of elements) {\r\n\t\tlet id;\r\n\t\tif(element.getAttribute('type') !== 'item' || !(id = +String(element.getAttribute('objid')))) continue;\r\n\r\n\t\tconst item = APICache.storage.items.get(id);\r\n\t\tif(!item || !('subtype' in item) || (!['Rune', 'Infusion'].includes(item.subtype))) continue;\r\n\r\n\t\tlet amountToAdd = 1;\r\n\r\n\t\tif(item.subtype == \"Infusion\") {\r\n\t\t\tif(!(amountToAdd = +String(element.getAttribute('count')))) { // modern version just has the item count as attribute\r\n\r\n\t\t\t\tif(config.legacyCompatibility) {\r\n\t\t\t\t\tamountToAdd = _legacy_getInfusionCount(element)!;\r\n\t\t\t\t\tif(!amountToAdd) continue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(!amountToAdd) {\r\n\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Could not figure how many infusions to add for sourceElement \", element, \". Will not assume anything and just ignore the stack.\");\r\n\t\t\t\t\t\tcontinue\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(targetContext.gameMode == \"Pvp\" && item.subtype == 'Rune') {\r\n\t\t\tamountToAdd = 6;\r\n\t\t}\r\n\r\n\t\tcounts[item.id] = (counts[item.id] || 0) + amountToAdd;\r\n\t}\r\n\r\n\tswitch(mode) {\r\n\t\tcase CollectMode.IgnoreGlobal: targetContext.character.upgradeCounts = counts; break\r\n\t\tcase CollectMode.Append: targetContext.character.upgradeCounts = Object.assign(targetContext.character.upgradeCounts, counts); break;\r\n\r\n\t\tcase CollectMode.PrioritizeGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign(counts, window.GW2TooltipsContext[contextIndex].character?.upgradeCounts);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign(counts, window.GW2TooltipsContext.character?.upgradeCounts);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.upgradeCounts = counts;\r\n\t\t\t}\r\n\t\t} break\r\n\r\n\t\tcase CollectMode.OverwriteGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign({}, window.GW2TooltipsContext[contextIndex].character?.upgradeCounts, counts);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign({}, window.GW2TooltipsContext.character?.upgradeCounts, counts);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.upgradeCounts = counts;\r\n\t\t\t}\r\n\t\t} break\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb) @correctness @incomplete: +x to all stats not working right now\r\nexport function allStatSources(scope : ScopeElement, mode : CollectMode = CollectMode.Append) {\r\n\tconst elements = scope.getElementsByTagName('gw2object');\r\n\tfor(const contextIndex of contexts.keys()) {\r\n\t\tconst elsInCorrectCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) == contextIndex);\r\n\t\tif(elsInCorrectCtx.length)\r\n\t\t\t_statSources(contextIndex, contexts, elsInCorrectCtx, mode);\r\n\t}\r\n\tconst elsWithWrongCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) >= contexts.length);\r\n\tif(elsWithWrongCtx.length) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] Some targets in scope \", scope, \" have the wrong context: \", elsWithWrongCtx);\r\n\t}\r\n}\r\nexport function specificStatSources(contextIndex : number, scope : ScopeElement, mode : CollectMode = CollectMode.Append) {\r\n\t_statSources(contextIndex, contexts, scope.getElementsByTagName('gw2object'), mode);\r\n}\r\nfunction _statSources(contextIndex : number, contexts : Context[], elements : Iterable<Element>, mode : CollectMode) {\r\n\tconst targetContext = contexts[contextIndex];\r\n\tconst sources : Context['character']['statSources'] = {\r\n\t\tPower            : [],\r\n\t\tToughness        : [],\r\n\t\tVitality         : [],\r\n\t\tPrecision        : [],\r\n\t\tFerocity         : [],\r\n\t\tConditionDamage  : [],\r\n\t\tExpertise        : [],\r\n\t\tConcentration    : [],\r\n\t\tHealingPower     : [],\r\n\t\tAgonyResistance  : [],\r\n\t\tArmor            : [],\r\n\t\tBoonDuration     : [],\r\n\t\tConditionDuration: [],\r\n\t\tCritChance       : [],\r\n\t\tCritDamage       : [],\r\n\t\tDamage           : [],\r\n\t\tLifeForce        : [],\r\n\t\tHealth           : [],\r\n\t\tHealEffectiveness: [],\r\n\t\tStun             : [],\r\n\t};\r\n\r\n\t//NOTE(Rennorb): Cant really use the existing upgrade counts since we want to add tiers individually.\r\n\t//TODO(Rennorb) @cleanup: Get rid of the count functions and just put them in here.\r\n\tlet upgrades = {} as { [k : number] : number };\r\n\r\n\tfor(const element of elements) {\r\n\t\tlet id, type = element.getAttribute('type');\r\n\t\tif(!(id = +String(element.getAttribute('objid')))) continue;\r\n\r\n\t\tlet amountToAdd = 1;\r\n\t\tlet tiersToProcess, item : API.Item | undefined, tierNumber, sourceRuneSuffix;\r\n\t\tif(type == 'item') {\r\n\t\t\titem = APICache.storage.items.get(id);\r\n\t\t\tif(!item || !('subtype' in item)) continue;\r\n\r\n\t\t\tif(item.type === 'UpgradeComponent' || item.type === 'Consumable') {\r\n\t\t\t\tif(item.subtype === 'Rune' && item.flags.includes('Pvp')) {\r\n\t\t\t\t\tamountToAdd = 6;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//NOTE(Rennorb): We count additional runes, but ignore those over the sensible amount.\r\n\t\t\t\t//NOTE(Rennorb): For pvp runes we get the wrong tier number here, it doesn't matter tho because we need to treat it differently anyways.\r\n\t\t\t\t// Since pvp builds only have one rune we need to add all tiers from just one item.\r\n\t\t\t\t// We still want to increase the upgrade count to do the warnings if we find more than expected.\r\n\t\t\t\ttierNumber = upgrades[item.id] = (upgrades[item.id] || 0) + amountToAdd;\r\n\r\n\t\t\t\tif(item.subtype === 'Rune') {\r\n\t\t\t\t\tsourceRuneSuffix = true;\r\n\r\n\t\t\t\t\tif(tierNumber > 6) {\r\n\t\t\t\t\t\t//NOTE(Rennorb): Only complain if we are manually counting runes.\r\n\t\t\t\t\t\t//TODO(Rennorb) @correctness: Is this the right way to do it? should we just complain when runes are specified but we find one that isn't?\r\n\t\t\t\t\t\tif(!targetContext.character.upgradeCounts[item.id])\r\n\t\t\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Found more than 6 runes of the same type. Here is the 7th rune element: \", element);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t//NOTE(Rennorb): Since pvp builds only have one rune we need to add all tiers from just one item.\r\n\t\t\t\t\tif(item.flags.includes('Pvp'))\r\n\t\t\t\t\t\ttiersToProcess = item.tiers;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\ttiersToProcess = [item.tiers[tierNumber - 1]];\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif(item.subtype == 'Infusion' || item.subtype == 'Enrichment') {\r\n\t\t\t\t\t\tif(!(amountToAdd = +String(element.getAttribute('count')))) { // modern version just has the item count as attribute\r\n\r\n\t\t\t\t\t\t\tif(config.legacyCompatibility) {\r\n\t\t\t\t\t\t\t\tamountToAdd = _legacy_getInfusionCount(element)!;\r\n\t\t\t\t\t\t\t\tif(!amountToAdd) continue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif(!amountToAdd) {\r\n\t\t\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Could not figure how many infusions to add for sourceElement \", element, \". Will not assume anything and just ignore the stack.\");\r\n\t\t\t\t\t\t\t\t\tcontinue\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if(item.subtype === 'Sigil' && tierNumber > 1) {\r\n\t\t\t\t\t\t//NOTE(Rennorb): We only process one sigil, since sigils are unique, but we start complaining at the third identical one since there might be the same sigil twice for different sets.\r\n\t\t\t\t\t\t//TODO(Rennorb) @correctness: how to handle asymmetric sets? Right now we would assume all unique sigils are active at once, so if you do [A, B] [B, C] then A, B, C would be considered active.\r\n\t\t\t\t\t\tif(tierNumber > 2)\r\n\t\t\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Found more than 2 sigils of the same type. Here is the 3th sigil element: \", element);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\ttiersToProcess = item.tiers; //should only ever be one anyways\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(type == 'pvp/amulet') {\r\n\t\t\titem = APICache.storage['pvp/amulets'].get(id);\r\n\t\t\tif(!item) continue;\r\n\t\t}\r\n\r\n\t\tlet attributeSet;\r\n\t\t{\r\n\t\t\tconst attributeSetId = +String(element.getAttribute('stats'));\r\n\t\t\tif(!isNaN(attributeSetId)) attributeSet = APICache.storage.itemstats.get(attributeSetId);\r\n\t\t\telse if(item && 'attribute_set' in item && item.attribute_set) {\r\n\t\t\t\tattributeSet = APICache.storage.itemstats.get(item.attribute_set);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(attributeSet) {\r\n\t\t\ttiersToProcess = [{\r\n\t\t\t\tmodifiers: attributeSet.attributes.map(a => ({\r\n\t\t\t\t\ttarget_attribute_or_buff: a.attribute,\r\n\t\t\t\t\tbase_amount             : (item as API.ItemAmulet).attribute_base * a.scaling,\r\n\t\t\t\t\tformula                 : \"NoScaling\",\r\n\t\t\t\t\t\r\n\t\t\t\t\tflags: [], id: -1, formula_param1: 0, formula_param2: 0, description: '',\r\n\t\t\t\t} as API.Modifier))\r\n\t\t\t}];\r\n\t\t}\r\n\t\tif(item && 'defense' in item) {\r\n\t\t\tconst defense = (typeof item.defense  == \"number\")\r\n\t\t\t\t? item.defense\r\n\t\t\t\t: LUT_DEFENSE[Math.min(100, (item.defense![0] + targetContext.character.level))] * item.defense![1];\r\n\r\n\t\t\ttiersToProcess![0].modifiers!.push({\r\n\t\t\t\ttarget_attribute_or_buff: 'Armor',\r\n\t\t\t\tbase_amount             : defense,\r\n\t\t\t\tformula                 : \"NoScaling\",\r\n\t\t\t\t\r\n\t\t\t\tflags: [], id: -1, formula_param1: 0, formula_param2: 0, description: '',\r\n\t\t\t} as API.Modifier)\r\n\t\t}\r\n\r\n\t\tif(tiersToProcess) for(const [i, tier] of tiersToProcess.entries()) {\r\n\t\t\tif(tier.modifiers) for(const mod of tier.modifiers!) {\r\n\t\t\t\tif(!mod.target_attribute_or_buff || (mod.mode && mod.mode !== targetContext.gameMode) || (mod.trait_req && !targetContext.character.traits.includes(mod.trait_req))) continue; //TODO(Rennorb): probably extract this into a fn similar to the other resolver\r\n\r\n\t\t\t\tlet source = formatItemName(item!, targetContext, attributeSet, undefined, -1);\r\n\t\t\t\tif(sourceRuneSuffix) {\r\n\t\t\t\t\tsource = `${source} (Tier ${tierNumber && tierNumber < 6 ? tierNumber : i + 1} Bonus)`;\r\n\t\t\t\t\tamountToAdd = 1; //TODO(Rennorb) @cleanup\r\n\t\t\t\t}\r\n\r\n\t\t\t\t(sources[mod.target_attribute_or_buff] || (sources[mod.target_attribute_or_buff] = []))\r\n\t\t\t\t\t.push({ modifier: mod, source, count: amountToAdd })\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//TODO(Rennorb) @cleanup: move this out?\r\n\tswitch(mode) {\r\n\t\tcase CollectMode.IgnoreGlobal: targetContext.character.statSources = sources; break\r\n\t\tcase CollectMode.Append: {\r\n\t\t\tfor(const [k, values] of Object.entries(sources)) {\r\n\t\t\t\t((targetContext.character.statSources as any)[k] || ((targetContext.character.statSources as any)[k] = []))\r\n\t\t\t\t\t.push(...values);\r\n\t\t\t}\r\n\t\t} break;\r\n\r\n\t\tcase CollectMode.PrioritizeGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign(sources, window.GW2TooltipsContext[contextIndex].character?.statSources);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign(sources, window.GW2TooltipsContext.character?.statSources);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.statSources = sources;\r\n\t\t\t}\r\n\t\t} break\r\n\r\n\t\tcase CollectMode.OverwriteGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign({}, window.GW2TooltipsContext[contextIndex].character?.statSources, sources);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign({}, window.GW2TooltipsContext.character?.statSources, sources);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.statSources = sources;\r\n\t\t\t}\r\n\t\t} break\r\n\t}\r\n}\r\n\r\nfunction _legacy_getInfusionCount(element : Element) : number | undefined {\r\n\t//NOTE(Rennorb): unfortunately this is a bit complicated as the count is next to the actual object, but within a stacked wrapper. so its\r\n\t// <gw2obj />\r\n\t// ... repeated for multiple infusions\r\n\t// <div.gw2-build-equipment-info>\r\n\t//   <span.item-name.noembed><strong.amount>{amount}x</strong>{name}</span>\r\n\t//   ... repeated for multiple infusions\r\n\tconst ownIndex = Array.prototype.indexOf.call(element.parentElement!.children, element);\r\n\tconst amountEl = element.parentElement!.getElementsByClassName('amount')[ownIndex];\r\n\tif(!amountEl){\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] `legacyCompatibility` is active, but no amount element for infusion \", element, \" could be found. Will not assume anything and just ignore the stack.\");\r\n\t\treturn;\r\n\t}\r\n\tconst amountToAdd = +String(amountEl.textContent?.match(/\\d+/)?.[0]);\r\n\tif(!amountToAdd) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] [legacyCompatibility] Amount element \", amountEl, \" for infusion element \", element, \" did not contain any readable amount. Will not assume anything and just ignore the stack.\");\r\n\t\treturn;\r\n\t}\r\n\tif(amountToAdd < 1 || amountToAdd > 20) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] [legacyCompatibility] Amount element \", amountEl, \" for infusion element \", element, \" did got interpreted as x\", amountToAdd, \" which is outside of the range of sensible values (amount in [1...20]). Will not assume anything and just ignore the stack.\");\r\n\t\treturn;\r\n\t}\r\n\r\n\treturn amountToAdd;\r\n}\r\n\r\nexport function allTraits(scope : ScopeElement, mode : CollectMode = CollectMode.Append) {\r\n\tconst elements = scope.querySelectorAll('gw2object[type=specialization]:not(.gw2objectembed)');\r\n\tfor(const pair of contexts.entries()) {\r\n\t\tconst elsInCorrectCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) == pair[0]);\r\n\t\tif(elsInCorrectCtx.length)\r\n\t\t\t_traits(...pair, elsInCorrectCtx, mode);\r\n\t}\r\n\tconst elsWithWrongCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) >= contexts.length);\r\n\tif(elsWithWrongCtx.length) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] Some targets in scope \", scope, \" have the wrong context: \", elsWithWrongCtx);\r\n\t}\r\n}\r\nexport function specificTraits(contextIndex : number, targetContext : Context, scope : ScopeElement, mode : CollectMode = CollectMode.Append) {\r\n\t_traits(contextIndex, targetContext, scope.getElementsByTagName('gw2object'), mode);\r\n}\r\nfunction _traits(contextIndex : number, targetContext : Context, elements : Iterable<Element>, mode : CollectMode) {\r\n\tconst traits : number[] = [];\r\n\tfor(const specialization of elements) {\r\n\t\tconst selectedPositions = String(specialization.getAttribute('selected_traits')).split(',').map(i => +i).filter(i => !isNaN(i) && 0 <= i && i <= 2);\r\n\t\tif(selectedPositions.length != 3) {\r\n\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Specialization object \", specialization, \" does not have its 'selected_traits' (properly) set. Add the attribute as `selected_traits=\\\"0,2,1\\\"` where the numbers are 0-2 indicating top, middle or bottom selection. Will not assume anything and just ignore the element.\");\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tfor(const [x, y] of selectedPositions.entries()) {\r\n\t\t\t// The expected structure is:\r\n\t\t\t// <spec>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t// </>\r\n\t\t\t{\r\n\t\t\t\tconst traitEl = specialization.children[1 + x * 2].children[y];\r\n\t\t\t\tlet id;\r\n\t\t\t\tif(!traitEl || !(id = +String(traitEl.getAttribute('objid')))) {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Trait object \", traitEl, \" is selected but does not exist or does not have an objid set. Add the attribute as `objid=\\\"1234\\\"`. Will not assume anything and just ignore the element.\");\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\ttraits.push(id);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//now abuse the iterator to also add minors\r\n\t\t\t{\r\n\t\t\t\tconst traitEl = specialization.children[x * 2];\r\n\t\t\t\tlet id;\r\n\t\t\t\tif(!(id = +String(traitEl.getAttribute('objid')))) {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Minor trait object \", traitEl, \" does not have an objid set. Add the attribute as `objid=\\\"1234\\\"`. Will not assume anything and just ignore the element.\");\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\ttraits.push(id);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//TODO(Rennorb) @cleanup: move this out?\r\n\tswitch(mode) {\r\n\t\tcase CollectMode.IgnoreGlobal:\r\n\t\t\t// It doest actually make sense to 'overwrite' here, so its just the same as IgnoreGlobal.\r\n\t\tcase CollectMode.OverwriteGlobal: targetContext.character.traits = traits; break\r\n\r\n\t\t// It doest actually make sense to 'append' here, so its just the same as PrioritizeGlobal.\r\n\t\tcase CollectMode.Append:\r\n\t\tcase CollectMode.PrioritizeGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\tconst set = new Set(window.GW2TooltipsContext[contextIndex].character?.traits);\r\n\t\t\t\ttraits.forEach(t => set.add(t));\r\n\t\t\t\ttargetContext.character.traits = Array.from(set);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\tconst set = new Set(window.GW2TooltipsContext.character?.traits);\r\n\t\t\t\ttraits.forEach(t => set.add(t));\r\n\t\t\t\ttargetContext.character.traits = Array.from(set);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.traits = traits;\r\n\t\t\t}\r\n\t\t} break\r\n\t}\r\n}\r\n\r\nexport function traitEffects(contexts : Context[]) {\r\n\tfor(const context of contexts) {\r\n\t\tfor(const traitId of context.character.traits) {\r\n\t\t\tconst trait = APICache.storage.traits.get(traitId);\r\n\t\t\tif(!trait) {\r\n\t\t\t\tconsole.error(`[gw2-tooltips] [collect] Trait #${traitId} is apparently missing in the cache.`);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tconst addModifiers = (modifiers : API.Modifier[]) => {\r\n\t\t\t\tfor(const mod of modifiers) {\r\n\t\t\t\t\tif(!mod.target_attribute_or_buff || (mod.mode && mod.mode !== context.gameMode) || (mod.trait_req && !context.character.traits.includes(mod.trait_req))) continue; //TODO(Rennorb): probably extract this into a fn similar to the other resolver\r\n\r\n\t\t\t\t\t(context.character.statSources[mod.target_attribute_or_buff] || (context.character.statSources[mod.target_attribute_or_buff] = []))\r\n\t\t\t\t\t\t.push({source: `trait '<span class=\"gw2-color-traited-fact\">${trait.name}</span>'`, modifier: mod, count: 1});\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tif(trait.modifiers) addModifiers(trait.modifiers);\r\n\r\n\t\t\tconst contextBoundInfo = resolveTraitsAndOverrides(trait, context);\r\n\t\t\tif(contextBoundInfo.blocks) for(const block of contextBoundInfo.blocks) if(block.facts) for(const fact of block.facts) {\r\n\t\t\t\tif(!('buff' in fact)) continue;\r\n\t\t\t\t\r\n\t\t\t\tconst buff = APICache.storage.skills.get(fact.buff);\r\n\t\t\t\tif(!buff) {\r\n\t\t\t\t\tconsole.error(`[gw2-tooltips] [collect] Buff #${fact.buff} required for trait effect collection is apparently missing in the cache.`);\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(buff.modifiers && !['Boon', 'Condition'].includes(buff.buff_type!)) {\r\n\t\t\t\t\tconsole.info(`[gw2-tooltips] [collect] [trait-effects] ${trait.name} applies ${buff.buff_type} ${buff.name}: ${buff.modifiers.length} mods`);\r\n\t\t\t\t\taddModifiers(buff.modifiers);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst enum CollectMode {\r\n\tIgnoreGlobal,\r\n\tPrioritizeGlobal,\r\n\tOverwriteGlobal,\r\n\tAppend,\r\n}\r\n\r\nimport APICache from \"./APICache\";\r\nimport { resolveTraitsAndOverrides, config, formatItemName, contexts, LUT_DEFENSE } from './TooltipsV2';\r\n","export function inflateGenericIcon(gw2Object : HTMLElement, data : { name : string, icon? : Parameters<typeof newImg>[0] }) {\r\n\tif(gw2Object.childElementCount > 0) return; // most scenarios will have the server prefill objects as best as it can.\r\n\r\n\tconst wikiLink = newElm('a', newImg(data.icon, undefined, data.name));\r\n\twikiLink.href = 'https://wiki-en.guildwars2.com/wiki/Special:Search/' + GW2Text2HTML(data.name).replaceAll(/\\[.*?\\]/g, ''); //remove plural forms ([s] and similar)\r\n\twikiLink.target = '_blank';\r\n\tif(gw2Object.classList.contains('gw2objectembed') && !gw2Object.classList.contains('icononly')) {\r\n\t\t//TODO(Rennorb) @correctness: this should probably take into account the plural form\r\n\t\tconst cleanName = GW2Text2HTML(data.name).replaceAll(/\\[.*?\\]/g, ''); //remove plural forms ([s] and similar)\r\n\t\twikiLink.append(cleanName);\r\n\t}\r\n\tgw2Object.append(wikiLink);\r\n}\r\n\r\nexport function inflateSkill(gw2Object : HTMLElement, skill : API.Skill) {\r\n\tconst contextSet = +String(gw2Object.getAttribute('contextSet')) || 0;\r\n\tconst context = specializeContextFromInlineAttribs(contexts[contextSet], gw2Object);\r\n\r\n\t//NOTE(Rennorb): doing this here might not be the best idea, as this wil prevent us form hot swapping traits.\r\n\t// The issue is that this is the place where the icon gets selected and inflated, so its somewhat required to change the skill before this point.\r\n\t// Maybe this is still the best place to do this and for cases were we need hot swapping (e.g. build editor) we just have to manually re-process skills after swapping traits.\r\n\t// Maybe we should move the original id to another attribute for savekeeping so we can revert it later on if we need to?\r\n\tif(gw2Object.classList.contains('auto-transform')) {\r\n\t\tconst replacementSkill = findTraitedOverride(skill, context);\r\n\t\tif(replacementSkill) {\r\n\t\t\tgw2Object.setAttribute('objid', String(replacementSkill.id));\r\n\t\t\tskill = replacementSkill;\r\n\t\t}\r\n\t}\r\n\t\r\n\tinflateGenericIcon(gw2Object, skill);\r\n}\r\n\r\nexport function inflateItem(gw2Object : HTMLElement, item : API.Item) {\r\n\tif(gw2Object.childElementCount > 0) return; // most scenarios will have the server prefill objects as best as it can.\r\n\r\n\tconst stackSize = +String(gw2Object.getAttribute('count')) || 1;\r\n\tconst context = contexts[+String(gw2Object.getAttribute('contextSet')) || 0];\r\n\r\n\tconst wikiLink = newElm('a', newImg(item.icon, undefined, item.name));\r\n\twikiLink.href = 'https://wiki-en.guildwars2.com/wiki/Special:Search/' + GW2Text2HTML(item.name).replaceAll(/\\[.*?\\]/g, ''); //remove plural forms ([s] and similar)\r\n\twikiLink.target = '_blank';\r\n\tif(gw2Object.classList.contains('gw2objectembed')) wikiLink.append(formatItemName(item, context, undefined, undefined, stackSize));\r\n\tgw2Object.append(wikiLink);\r\n}\r\n\r\nexport function inflateSpecialization(gw2Object : HTMLElement, spec: OfficialAPI.Specialization) {\r\n\tif(gw2Object.classList.contains('gw2objectembed')) {\r\n\t\tinflateGenericIcon(gw2Object, spec);\r\n\t}\r\n\telse {\r\n\t\t//NOTE(Rennorb): Full urls specify a protocol which is delilited by a colon. Not perferct but good enough for now.  https_:_ , data_:_image\r\n\t\tgw2Object.style.backgroundImage = `url(${spec.background.includes(':') ? spec.background : IMAGE_CDN + spec.background})`;\r\n\t\tgw2Object.dataset.label = spec.name;\r\n\r\n\t\t//TODO(Rennorb) @cleanup @compat: this is kinda dumb. we could just mark the selected traits, as we need to do that anyways for css. \r\n\t\t// Issue is backwards compat so yea, might not be able to get rid of it completely.\r\n\t\tconst selectedPositions = String(gw2Object.getAttribute('selected_traits')).split(',').map(i => +i).filter(i => !isNaN(i) && 0 <= i && i <= 2);\r\n\t\tif(selectedPositions.length != 3) {\r\n\t\t\tconsole.warn(\"[gw2-tooltips] [inflator] Specialization object \", gw2Object, \" does not have its 'selected_traits' (properly) set. Add the attribute as `selected_traits=\\\"0,2,1\\\"` where the numbers are 0-2 indicating top, middle or bottom selection.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tfor(const [x, y] of selectedPositions.entries()) {\r\n\t\t\t// The expected structure is:\r\n\t\t\t// <spec>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t// </>\r\n\t\t\tconst column = gw2Object.children[1 + x * 2];\r\n\t\t\tif(!column) {\r\n\t\t\t\tconsole.warn(\"[gw2-tooltips] [inflator] Cannot mark selected trait object in column #\", x, \" for specialization object \", gw2Object,  \" because the column doesn't seem to exist. Either mark the specialization object as inline or add the missing column.\");\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tfor(const [i, traitEl] of Array.prototype.entries.call(column.children)) {\r\n\t\t\t\ttraitEl.classList.toggle('trait_unselected', i !== y);\r\n\t\t\t}\r\n\t\t\t//TODO(Rennorb): can probably merge trait collection into here since its basically the same code\r\n\t\t}\r\n\t}\r\n}\r\n\r\ntype AdditionalAttributes = 'Profession' | 'MagicFind'\r\nexport function inflateAttribute(gw2Object : HTMLElement, attribute : BaseAttribute | ComputedAttribute | AdditionalAttributes) {\r\n\tconst context = contexts[+String(gw2Object.getAttribute('contextSet')) || 0];\r\n\r\n\tconst value : number | undefined = context.character.stats[attribute as Exclude<typeof attribute, AdditionalAttributes>];\r\n\tconst _p  = ({\r\n\t\tPower            : [ 66722, '' ],\r\n\t\tToughness        : [104162, '' ],\r\n\t\tVitality         : [104163, '' ],\r\n\t\tPrecision        : [156609, '' ],\r\n\t\tFerocity         : [156602, '' ],\r\n\t\tConditionDamage  : [156600, '' ],\r\n\t\tExpertise        : [156601, '' ],\r\n\t\tConcentration    : [156599, '' ],\r\n\t\tHealingPower     : [156606, '' ],\r\n\t\tAgonyResistance  : [536049, '' ],\r\n\t\tHealth           : [536052, '' ],\r\n\t\tArmor            : [536048, '' ],\r\n\t\tConditionDuration: [156601, '%'],\r\n\t\tBoonDuration     : [156599, '%'],\r\n\t\tCritChance       : [536051, '%'],\r\n\t\tCritDamage       : [784327, '%'],\r\n\t\tMagicFind        : [536054, '%'],\r\n\t} as { [k in BaseAttribute | ComputedAttribute | AdditionalAttributes]? : [number, string]})[attribute];\r\n\tlet img, suffix = '';\r\n\tif(_p) [img, suffix] = _p;\r\n\telse {\r\n\t\tconsole.warn(`[gw2-tooltips] [inflator] Unknown attribute '${attribute}' on object `, gw2Object);\r\n\t}\r\n\r\n\tconst displayMul = suffix ? 100 : 1;\r\n\r\n\tlet search = mapLocale(attribute);\r\n\tif(attribute == 'Profession') {\r\n\t\tsearch = \"Attribute#Profession_Attributes\";\r\n\t}\r\n\r\n\tconst wikiLink = newElm('a', newImg(img));\r\n\twikiLink.href = `https://wiki-en.guildwars2.com/wiki/Special:Search/${search}`;\r\n\twikiLink.target = '_blank';\r\n\tif(gw2Object.classList.contains('gw2objectembed')) {\r\n\t\tif(value !== undefined) {\r\n\t\t\twikiLink.append(withUpToNDigits(value * displayMul, 1) + suffix);\r\n\t\t}\r\n\t\telse {\r\n\t\t\twikiLink.append('???' + suffix);\r\n\t\t}\r\n\t}\r\n\r\n\t// We blindly replace this as we can assume the server does not do proper calculation and therefore can only do a rough simulation at best.\r\n\tgw2Object.replaceChildren(wikiLink);\r\n}\r\n\r\nexport function _legacy_transformEffectToSkillObject(gw2Object : HTMLElement, error_store : Set<string>) : number {\r\n\tconst name = String(gw2Object.getAttribute('objId'));\r\n\tlet id = ({\r\n\t\t//// auras\r\n\t\tchaos_aura              : 10332,\r\n\t\tdark_aura               : 39978,\r\n\t\tfire_aura               : 5677,\r\n\t\tfrost_aura              : 5579,\r\n\t\tlight_aura              : 25518,\r\n\t\tmagnetic_aura           : 5684,\r\n\t\tshocking_aura           : 5577,\r\n\t\t//// boons\r\n\t\taegis                   : 743,\r\n\t\talacrity                : 30328,\r\n\t\tfury                    : 725,\r\n\t\tmight                   : 740,\r\n\t\tprotection              : 717,\r\n\t\tquickness               : 1187,\r\n\t\tregeneration            : 718,\r\n\t\tresistance              : 26980,\r\n\t\tresolution              : 873,\r\n\t\tstability               : 1122,\r\n\t\tswiftness               : 719,\r\n\t\tvigor                   : 726,\r\n\t\t//// conditions\r\n\t\tbleeding                : 736,\r\n\t\tblinded                 : 720,\r\n\t\tburning                 : 737,\r\n\t\tchill                   : 722,\r\n\t\tchilled                 : 722,\r\n\t\tconfusion               : 861,\r\n\t\tcrippled                : 721,\r\n\t\tfear                    : 896,\r\n\t\timmobilize              : 727,\r\n\t\tpoison                  : 723,\r\n\t\tslow                    : 26766,\r\n\t\ttaunt                   : 27705,\r\n\t\ttorment                 : 19426,\r\n\t\tvulnerability           : 738,\r\n\t\tweakness                : 742,\r\n\t\t//// control effects\r\n\t\tdaze                    : 833,\r\n\t\t// float                -> see hardCoded below\r\n\t\t// knockback            -> see hardCoded below\r\n\t\t// knockdown            -> see hardCoded below\r\n\t\t// launch               -> see hardCoded below\r\n\t\t// pull                 -> see hardCoded below\r\n\t\t// sink                 -> see hardCoded below\r\n\t\tstun                    : 872,\r\n\t\t//// misc\r\n\t\tagony                   : 15773,\r\n\t\t// barrier              -> see hardCoded below\r\n\t\tinvulnerability         : 56227,\r\n\t\trevealed                : 890,\r\n\t\tstealth                 : 58026, //maybe wrong\r\n\t\t// stunbreak            -> see hardCoded below\r\n\t\tsuperspeed              : 5974,\r\n\t\tunblockable             : 18843,\r\n\t\t//// npcs\r\n\t\tblight                  : 62653,\r\n\t\tbloodstone_blessed      : 34917,\r\n\t\tblue_pylon_power        : 31413, // (vale guardian)\r\n\t\tchampion_of_the_legions : 20845, //maybe wrong (rock fest thing?)\r\n\t\tcompromised             : 35096,\r\n\t\tcrowd_favor             : 36173, //maybe wrong (marionette)\r\n\t\tcurse_of_frailty        : 53723, //maybe wrong (pirate fractal)\r\n\t\tdebilitated             : 67972, // ko\r\n\t\tdebilitating_void       : 64967, //ankah\r\n\t\tdefense_up              : 28482,\r\n\t\tderangement             : 34965,\r\n\t\telemental_empowerment   : 62733,\r\n\t\tempowering_auras        : 62939,\r\n\t\tequalization_matrix     : 67047, // (ko)\r\n\t\texpose_weakness         : 26660,\r\n\t\texposed                 : 28778, //maybe wrong\r\n\t\textreme_vulnerability   : 65662,\r\n\t\tfixated                 : 47434, //maybe wrong\r\n\t\tgrowing_rage_ashym      : 3362, //maybe wrong (urban battleground)\r\n\t\tignite                  : 16259,\r\n\t\tintervention            : 35061,\r\n\t\tnecrosis                : 47414,\r\n\t\tnot_sticking_together   : 54378,\r\n\t\tnova                    : 39193, //there is also the upgraded version with aegis\r\n\t\tooze_pheromone          : 21538,\r\n\t\tphoton_saturation       : 67872, // ah cm\r\n\t\tpositive_flow           : 66665,\r\n\t\tpower_of_the_void       : 65601, // xjj\r\n\t\treinforced_armor        : 9283,\r\n\t\trelentless_fire         : 62805,\r\n\t\tretaliation_ashym       : 24646, //maybe wrong\r\n\t\tsentinel_retribution    : 16350,\r\n\t\tshattering_ice          : 62909,\r\n\t\tshell_shocked           : 33361,\r\n\t\tspectral_darkness       : 31498,\r\n\t\tsticking_together       : 54604,\r\n\t\tsynchronized_vitality   : 63840, //maybe wrong(ko)\r\n\t\tunnatural_signet        : 38224,\r\n\t\tuse_soul_binder         : 55630,\r\n\t\tvoid_empowerment        : 68083,\r\n\t\txeras_embrace           : 34979,\r\n\t} as any)[name]\r\n\r\n\tif(!id) {\r\n\t\t//NOTE(Rennorb): these don't actually exist and need to be synthesized.\r\n\t\tconst hardCoded = ({\r\n\t\t\tbarrier: {\r\n\t\t\t\tid: 1,\r\n\t\t\t\tname: 'Barrier',\r\n\t\t\t\ticon: ICONS.BARRIER,\r\n\t\t\t\tdescription: \"Creates a health barrier that takes damage prior to the health bar. Barrier disappears 5s after being applied. Applying a barrier while one is already active will add to it, but the previously-existing barrier will still disappear 5s after it was originally applied. The amount of barrier generated is based on the source's healing power, and is capped at 50% of the recipient's maximum health.\",\r\n\t\t\t\tdescription_brief: \"Creates a health barrier that takes damage prior to the health bar.\",\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tstunbreak: {\r\n\t\t\t\tid: 2,\r\n\t\t\t\tname: 'Stun Break',\r\n\t\t\t\tdescription: 'Cancel control effects such as stuns.',\r\n\t\t\t\ticon: ICONS.STUN_BREAK,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tknockdown: {\r\n\t\t\t\tid: 3,\r\n\t\t\t\tname: 'Knockdown',\r\n\t\t\t\tdescription: 'Knocks the target on ground, preventing movement and actions for a short duration.',\r\n\t\t\t\ticon: ICONS.KNOCKDOWN,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tpull: {\r\n\t\t\t\tid: 4,\r\n\t\t\t\tname: 'Pull',\r\n\t\t\t\tdescription: 'Pulls the caster to the target or the target to a specific location and disables them for a short duration.',\r\n\t\t\t\ticon: ICONS.PULL,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tknockback: {\r\n\t\t\t\tid: 5,\r\n\t\t\t\tname: 'Knockback',\r\n\t\t\t\tdescription: 'Knocks back the target away and on the ground, preventing movement and actions for a short duration.',\r\n\t\t\t\ticon: ICONS.KNOCKBACK,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tlaunch: {\r\n\t\t\t\tid: 6,\r\n\t\t\t\tname: 'Launch',\r\n\t\t\t\tdescription: 'Throws the target in the air over a short distance, preventing movement and actions for a short duration. Can move Downed targets.',\r\n\t\t\t\ticon: ICONS.LAUNCH,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tfloat: {\r\n\t\t\t\tid: 7,\r\n\t\t\t\tname: 'Float',\r\n\t\t\t\tdescription: 'Causes the target to float in the air, preventing movement and actions for a short duration. Causes underwater targets to move up.',\r\n\t\t\t\ticon: ICONS.FLOAT,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tsink: {\r\n\t\t\t\tid: 8,\r\n\t\t\t\tname: 'Sink',\r\n\t\t\t\tdescription: 'Causes the underwater target to move downwards.',\r\n\t\t\t\ticon: ICONS.SINK,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t} as {[k : string] : API.Skill})[name];\r\n\r\n\t\tif(hardCoded) {\r\n\t\t\tid = hardCoded.id;\r\n\t\t\t//TODO(Rennorb) @cleanup: could probably move this out\r\n\t\t\tAPICache.storage.skills.set(id, hardCoded);\r\n\t\t}\r\n\t}\r\n\r\n\tif(id) {\r\n\t\tgw2Object.setAttribute('type', 'skill');\r\n\t\tgw2Object.setAttribute('objId', String(id));\r\n\t\treturn id;\r\n\t}\r\n\telse {\r\n\t\tgw2Object.innerText = name;\r\n\t\tgw2Object.title = `Failed to translate effect '${name}'.`;\r\n\t\tgw2Object.style.cursor = \"help\";\r\n\t\tgw2Object.classList.add('error');\r\n\t\terror_store.add(name);\r\n\t\treturn 0;\r\n\t}\r\n}\r\n\r\nexport function inferItemUpgrades(wrappers : Iterable<Element>) {\r\n\tconst remainingInfusionsByContext = contexts.map(ctx => {\r\n\t\tconst counts : Character['upgradeCounts'] = {};\r\n\t\tfor(const [id, c] of Object.entries(ctx.character.upgradeCounts)) {\r\n\t\t\tlet item;\r\n\t\t\tif((item = APICache.storage.items.get(+id)) && 'subtype' in item && item.subtype == 'Infusion')\r\n\t\t\t\tcounts[+id] = c;\r\n\t\t}\r\n\t\treturn counts;\r\n\t});\r\n\tconst enrichmentByContext = contexts.map(ctx => {\r\n\t\tfor(const [id, c] of Object.entries(ctx.character.upgradeCounts)) {\r\n\t\t\tlet item;\r\n\t\t\tif((item = APICache.storage.items.get(+id)) && 'subtype' in item && item.subtype == 'Enrichment')\r\n\t\t\t\treturn id;\r\n\t\t}\r\n\t})\r\n\r\n\tfor(const wrapper of wrappers) {\r\n\tif(wrapper.childElementCount < 2) continue;\r\n\t\tconst [itemEl, ...upgradeEls] = wrapper.children;\r\n\t\tif(itemEl.getAttribute('type') !== 'item') continue;\r\n\r\n\t\tconst itemCtx = +String(itemEl.getAttribute('contextSet')) || 0 ;\r\n\r\n\t\tconst upgradeIds = upgradeEls.filter(u =>\r\n\t\t\t\tu.getAttribute('type') === 'item' && u.getAttribute('objid')\r\n\t\t\t\t&& (+String(itemEl.getAttribute('contextSet')) || 0) === itemCtx\r\n\t\t\t)\r\n\t\t\t.map(u => u.getAttribute('objid'));\r\n\r\n\t\t{\r\n\t\t\tlet id, item;\r\n\t\t\tif((id = +String(itemEl.getAttribute('objid'))) && (item = APICache.storage.items.get(id)) && 'slots' in item) {\r\n\t\t\t\tfor(const slot of item.slots) {\r\n\t\t\t\t\tif(slot == 'Infusion') {\r\n\t\t\t\t\t\tconst remainingInfusions = remainingInfusionsByContext[itemCtx] as { [k : string] : number };\r\n\t\t\t\t\t\tfor(const infusionId of Object.keys(remainingInfusions)) {\r\n\t\t\t\t\t\t\tupgradeIds.push(infusionId);\r\n\t\t\t\t\t\t\tif(--remainingInfusions[infusionId] < 1) {\r\n\t\t\t\t\t\t\t\tdelete remainingInfusions[infusionId];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if(slot == 'Enrichment') {\r\n\t\t\t\t\t\tconst enrichment = enrichmentByContext[itemCtx];\r\n\t\t\t\t\t\tif(enrichment) upgradeIds.push(enrichment);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst attrString = upgradeIds.join(',');\r\n\t\tif(attrString) itemEl.setAttribute('slotted', attrString);\r\n\t}\r\n}\r\n\r\nimport APICache from \"./APICache\";\r\nimport { GW2Text2HTML, IMAGE_CDN, mapLocale, newElm, newImg, withUpToNDigits } from \"./TUtilsV2\";\r\nimport { ICONS, contexts, findTraitedOverride, formatItemName, specializeContextFromInlineAttribs } from \"./TooltipsV2\";\r\n","//TODO(Rennorb) @issues:\r\n//TODO(Rennorb): Provide a clean way to construct custom tooltips. Currently with the old version we manipulate the cache before the hook function gets called, which really isn't the the best.\r\n//TODO(Rennorb): Option to show whole skill-chain (maybe on button hold)?\r\n//TODO(Rennorb): Stop using these jank custom tags. There is no reason to do so and its technically not legal per html spec.\r\n//TODO(Rennorb): Link minion skills to minion summon skill. might be doable via the species def\r\n//TODO(Rennorb): Defiance break on single effect tooltips.\r\n//TODO(Rennorb): Change anything percent related to use fractions instead of integers (0.2 instead of 20).\r\n// The only thing this is good for is to make drawing the facts easier. Since we do quite a few calculations this swap would reduce conversions quite a bit.\r\n//TODO(Rennorb): Note the specialization a trait belongs to on the trait tooltip (probably instead of the slot).\r\n//TODO(Rennorb) @correctness: Split up incoming / outgoing effects. Mostly relevant for healing.\r\n//TODO(Rennorb) @correctness: Change the lookup to first try to figure out the palette and then go from there. this is the way to move forward as this is the future-proof way to list skills.\r\n//TODO(Rennorb) @correctness: implement processing for trait / skill buffs to properly show certain flip skills and chains aswell as properly do trait overrides for skills\r\n\r\n//TODO(Rennorb): (maybe) add specific hs output command that produces files outside of the repo to preserve them inside of the parent.\r\n\r\nlet tooltip : HTMLElement\r\nlet lastTooltipTarget : HTMLElement | undefined\r\n\r\nlet cyclePos    : number = 0\r\nlet lastMouseX  : number\r\nlet lastMouseY  : number\r\n\r\nexport const contexts : Context[] = []; //@debug\r\nexport let config    : Config = null!;\r\n\r\n//TODO(Rennorb) @cleanup: get rid of this\r\nfunction _constructor() {\r\n\t//TODO(Rennorb): Validate config. there are a few places this partially happens but its hard to keep track. Should just happen in one place.\r\n\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\tfor(const partialContext of window.GW2TooltipsContext)\r\n\t\t\tcontexts.push(createCompleteContext(partialContext))\r\n\t}\r\n\telse if(window.GW2TooltipsContext) {\r\n\t\tcontexts.push(createCompleteContext(window.GW2TooltipsContext))\r\n\t}\r\n\telse{\r\n\t\tcontexts.push(createCompleteContext({}))\r\n\t}\r\n\r\n\tconfig = Object.assign({}, DEFAULT_CONFIG, window.GW2TooltipsConfig)\r\n\tif(config.apiImpl) APICache.apiImpl = config.apiImpl(APIs);\r\n\r\n\ttooltip = newElm('div.tooltipWrapper')\r\n\ttooltip.style.display = 'none';\r\n\tdocument.body.appendChild(tooltip)\r\n\r\n\tconst isMobile = /android|webos|iphone|ipad|ipod|blackberry|bb|playbook|mobile|windows phone|kindle|silk|opera mini/.test(navigator.userAgent.toLowerCase())\r\n\tdocument.addEventListener('mousemove', event => {\r\n\t\tif(isMobile && (Math.abs(event.pageX - lastMouseX) + Math.abs(event.pageY - lastMouseY) > 20)) {\r\n\t\t\ttooltip.style.display = 'none';\r\n\t\t}\r\n\r\n\t\tlastMouseX = event.pageX\r\n\t\tlastMouseY = event.pageY\r\n\r\n\t\tif(tooltip.style.display != 'none')\r\n\t\t\tpositionTooltip()\r\n\t})\r\n\tdocument.addEventListener('contextmenu', event => {\r\n\t\tconst node = findSelfOrParent(event.target as Element, 'gw2object') as HTMLElement;\r\n\t\tif(!node) return;\r\n\r\n\t\t//NOTE(Rennorb): the style check is to prevent an initial cycle on mobile\r\n\t\tif(node.classList.contains('cycler') && tooltip.style.display != 'none') {\r\n\t\t\tevent.preventDefault()\r\n\r\n\t\t\tdo {\r\n\t\t\t\tcyclePos = (cyclePos + 1) % tooltip.childElementCount\r\n\t\t\t} while(tooltip.children[cyclePos].classList.contains('not-collapsable'))\r\n\t\t\tactivateSubTooltip(cyclePos)\r\n\t\t\tscrollSubTooltipIntoView(cyclePos, true)\r\n\t\t\tpositionTooltip(true)\r\n\t\t}\r\n\t\tif(isMobile && tooltip.style.display == 'none') {\r\n\t\t\tevent.preventDefault()\r\n\t\t\tshowTooltipFor(node);\r\n\t\t\tpositionTooltip()\r\n\t\t}\r\n\t})\r\n\r\n\t//TODO(Rennorb): this sint very clean,  would like a better solution tbh\r\n\tlet touch : Touch;\r\n\tconst scrollHandler = (event : WheelEvent | TouchEvent | { detail : number, preventDefault: VoidFunction }) => {\r\n\t\tif(tooltip.style.display == 'none') return;\r\n\t\tconst activeTT = tooltip.children[cyclePos];\r\n\t\tif(activeTT.scrollHeight == activeTT.clientHeight) return;\r\n\r\n\t\tevent.preventDefault()\r\n\t\tconst deltaY = (event as WheelEvent).deltaY || event.detail || (event as TouchEvent).touches[0].clientY - touch.clientY;\r\n\t\tactiveTT.scrollBy(0, deltaY);\r\n\t}\r\n\tconst passive = 'onwheel' in window ? { passive: false } : false;\r\n\t\r\n\twindow.addEventListener('DOMMouseScroll', scrollHandler as any, false); // older FF\r\n\twindow.addEventListener('wheel', scrollHandler, passive)\r\n\twindow.addEventListener('touchstart', event => {\r\n\t\ttouch = event.touches[0];\r\n\t})\r\n\twindow.addEventListener('touchmove', scrollHandler, passive)\r\n\r\n\t//TODO(Rennorb) @ui\r\n\twindow.addEventListener('keydown', e => {\r\n\t\tif(e.ctrlKey && e.altKey) {\r\n\t\t\tif(e.key == 'd') {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tconfig.showFactComputationDetail = !config.showFactComputationDetail;\r\n\t\t\t\tconsole.log(`[gw2-tooltips] [cfg] showFactComputationDetail is now ${config.showFactComputationDetail}`);\r\n\t\t\t\tif(lastTooltipTarget && tooltip.style.display != 'none') {\r\n\t\t\t\t\tshowTooltipFor(lastTooltipTarget, cyclePos); // visibleIndex = cyclePos: keep the same sub-tooltip active\r\n\t\t\t\t\tpositionTooltip();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if(e.key == 't') {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tconfig.showPreciseAbilityTimings = !config.showPreciseAbilityTimings;\r\n\t\t\t\tconsole.log(`[gw2-tooltips] [cfg] showPreciseAbilityTimings is now ${config.showPreciseAbilityTimings}`);\r\n\t\t\t\tif(lastTooltipTarget && tooltip.style.display != 'none') {\r\n\t\t\t\t\tshowTooltipFor(lastTooltipTarget, cyclePos); // visibleIndex = cyclePos: keep the same sub-tooltip active\r\n\t\t\t\t\tpositionTooltip();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction activateSubTooltip(tooltipIndex : number) {\r\n\tconst tooltips = tooltip.children as HTMLCollectionOf<HTMLLegendElement>;\r\n\r\n\tfor(let index = 0; index < tooltips.length; index++) {\r\n\t\tif(!tooltips[index].classList.contains('not-collapsable'))\r\n\t\t\ttooltips[index].classList.toggle('active', index === tooltipIndex);\r\n\t}\r\n}\r\n\r\nfunction scrollSubTooltipIntoView(tooltipIndex : number, animate = false) {\r\n\tconst tooltips = (tooltip.children as HTMLCollectionOf<HTMLLegendElement>)[tooltipIndex];\r\n\ttooltip.style.transition = animate ? 'transform 0.25s' : '';\r\n\ttooltip.style.transform = `translate(0, -${tooltips.offsetTop + tooltips.offsetHeight}px)`;\r\n}\r\n\r\n//TODO(Rennorb); If the tooltip doesn't fit on screen its probably because we have many and they don't fit even if collapsed.\r\n// In that case we want to fit the currently active one on screen instead of the whole list.\r\nfunction positionTooltip(animate = false) {\r\n\tconst wpadminbar = document.getElementById('wpadminbar'); //TODO(Rennorb) @hardcoded: this accounts for the wordpress bar that might exist.\r\n\tconst topBarHeight = wpadminbar ? wpadminbar.offsetHeight : 0;\r\n\r\n\t//using actual css margins in js is pain\r\n\tconst marginX = 22;\r\n\tconst marginY = 13;\r\n\t//some space form the cursor\r\n\tconst offsetX = 6;\r\n\tconst offsetY = 6;\r\n\r\n\tconst currentSubTooltip = tooltip.children[cyclePos] as HTMLElement;\r\n\r\n\tlet tooltipXpos = lastMouseX + offsetX;\r\n\tif(tooltipXpos + tooltip.offsetWidth > document.documentElement.clientWidth - marginX) {\r\n\t\ttooltipXpos = document.documentElement.clientWidth - (tooltip.offsetWidth + marginX);\r\n\t}\r\n\r\n\tlet tooltipYpos = lastMouseY - offsetY;\r\n\tif(tooltipYpos - currentSubTooltip.offsetHeight < document.documentElement.scrollTop + topBarHeight + marginY) {\r\n\t\tif(animate) {\r\n\t\t\ttooltip.style.transition += ', top 0.25s';\r\n\t\t\tsetTimeout(() => tooltip.style.transition = '', 250);\r\n\t\t}\r\n\t\ttooltipYpos = document.documentElement.scrollTop + topBarHeight + marginY + currentSubTooltip.offsetHeight;\r\n\t}\r\n\r\n\ttooltip.style.left = `${tooltipXpos}px`;\r\n\ttooltip.style.top  = `${tooltipYpos}px`;\r\n}\r\n\r\ntype GW2ObjectMap = {\r\n\t[k in `${Exclude<V2ObjectType, 'effect' | 'attribute'>}s`] : Map<number, HTMLElement[]>\r\n} & {\r\n\tattributes : Map<string, HTMLElement[]>,\r\n}\r\n\r\nexport async function hookDocument(scope : ScopeElement, _unused? : any) : Promise<GW2ObjectMap> {\r\n\t//NOTE(Rennorb): need to use an array since there might be multiple occurrences of the same id in a given scope\r\n\tconst objectsToGet : GW2ObjectMap = {\r\n\t\tskills         : new Map<number, HTMLElement[]>(),\r\n\t\ttraits         : new Map<number, HTMLElement[]>(),\r\n\t\titems          : new Map<number, HTMLElement[]>(),\r\n\t\tspecializations: new Map<number, HTMLElement[]>(),\r\n\t\tpets           : new Map<number, HTMLElement[]>(),\r\n\t\t'pvp/amulets'  : new Map<number, HTMLElement[]>(),\r\n\t\tattributes     : new Map<string, HTMLElement[]>(),\r\n\t}\r\n\tconst statsToGet = new Set<number>();\r\n\tconst _legacy_effectErrorStore = new Set<string>();\r\n\r\n\tfor(const gw2Object of scope.getElementsByTagName('gw2object') as HTMLCollectionOf<HTMLElement>) {\r\n\t\tconst stats = +String(gw2Object.getAttribute('stats'));\r\n\t\tif(!isNaN(stats)) statsToGet.add(stats);\r\n\r\n\t\tlet objId_raw = gw2Object.getAttribute('objId');\r\n\t\t//TODO(Rennorb) @cleanup @compat: this is literally just for naming 'convenience'.\r\n\t\t// Figure out if we can just get rid of the +'s' or if that poses an issue with backwards compat\r\n\t\tlet type = (gw2Object.getAttribute('type') || 'skill') + 's' as `${V2ObjectType}s`;\r\n\r\n\t\tif(type === 'attributes') {\r\n\t\t\tif(typeof objId_raw === 'string') {\r\n\t\t\t\tconst elementsWithThisId = objectsToGet.attributes.get(objId_raw);\r\n\t\t\t\tif(elementsWithThisId) elementsWithThisId.push(gw2Object);\r\n\t\t\t\telse objectsToGet.attributes.set(objId_raw, [gw2Object]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tlet objId = +String(objId_raw);\r\n\r\n\t\t\tif(type === 'effects') {\r\n\t\t\t\t//NOTE(Rennorb): weapon swaps are completely synthesized\r\n\t\t\t\tif(config.legacyCompatibility) {\r\n\t\t\t\t\ttype = 'skills';\r\n\t\t\t\t\tobjId = _legacy_transformEffectToSkillObject(gw2Object, _legacy_effectErrorStore);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(!isNaN(objId) && type in objectsToGet) {\r\n\t\t\t\tconst elementsWithThisId = objectsToGet[type].get(objId);\r\n\t\t\t\tif(elementsWithThisId) elementsWithThisId.push(gw2Object);\r\n\t\t\t\telse objectsToGet[type].set(objId, [gw2Object]);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tgw2Object.addEventListener('mouseenter', (e) => showTooltipFor(e.target as HTMLElement));\r\n\t\tgw2Object.addEventListener('mouseleave', () => {\r\n\t\t\ttooltip.style.display   = 'none';\r\n\t\t\ttooltip.style.transform = '';\r\n\t\t});\r\n\t}\r\n\r\n\tif(_legacy_effectErrorStore.size) {\r\n\t\tconsole.error(\"[gw2-tooltips] [legacy-compat] Some effects could not be translated into skills: \", Array.from(_legacy_effectErrorStore));\r\n\t}\r\n\r\n\tif(statsToGet.size > 0) APICache.ensureExistence('itemstats', statsToGet.values());\r\n\r\n\tawait Promise.all(\r\n\t\t(Object.entries(objectsToGet)\r\n\t\t.filter(([key, _]) => key != 'attributes') as [Exclude<keyof typeof objectsToGet, 'attributes'>, Map<number, HTMLElement[]>][])\r\n\t\t.map(async ([key, values]) => {\r\n\t\tif(values.size == 0) return;\r\n\r\n\t\tlet inflator;\r\n\t\tswitch(key) {\r\n\t\t\tcase 'skills'         : inflator = inflateSkill;          break;\r\n\t\t\tcase 'items'          : inflator = inflateItem;           break;\r\n\t\t\tcase 'specializations': inflator = inflateSpecialization; break;\r\n\t\t\tdefault               : inflator = inflateGenericIcon;    break;\r\n\t\t}\r\n\t\tconst cache = APICache.storage[key];\r\n\r\n\t\tawait APICache.ensureExistence(key, values.keys())\r\n\r\n\t\tfor(const [id, objects] of values) {\r\n\t\t\tconst data = cache.get(id);\r\n\t\t\tif(!objects || !data) continue;\r\n\r\n\t\t\tfor(const gw2Object of objects)\r\n\t\t\t\tinflator(gw2Object, data as any);\r\n\t\t}\r\n\t}));\r\n\r\n\treturn objectsToGet;\t\r\n}\r\n\r\nfunction showTooltipFor(gw2Object : HTMLElement, visibleIndex = 0) {\r\n\tconst type = ((gw2Object.getAttribute('type') || 'skill') + 's') as `${V2ObjectType}s`;\r\n\tconst objId = gw2Object.getAttribute('objId')\r\n\tlet   context = contexts[+String(gw2Object.getAttribute('contextSet')) || 0];\r\n\tconst statSetId = +String(gw2Object.getAttribute('stats')) || undefined;\r\n\tconst stackSize = +String(gw2Object.getAttribute('count')) || undefined;\r\n\r\n\tif(type == 'specializations' || type == 'effects') return; //TODO(Rennorb) @completeness: inline objs\r\n\r\n\tlastTooltipTarget = gw2Object;\r\n\r\n\tif(type == 'attributes') {\r\n\t\tif(objId) {\r\n\t\t\t//TODO(Rennorb): should we actually reset this every time?\r\n\t\t\tcyclePos = visibleIndex;\r\n\t\t\ttooltip.replaceChildren(generateAttributeTooltip(objId as BaseAttribute | ComputedAttribute, gw2Object, context));\r\n\r\n\t\t\ttooltip.style.display = ''; //empty value resets actual value to use stylesheet\r\n\t\t\tfor(const tt of tooltip.children) tt.classList.add('active');\r\n\t\t\tscrollSubTooltipIntoView(cyclePos);\r\n\t\t}\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst data = APICache.storage[type].get(+String(objId));\r\n\tif(data) {\r\n\t\t//TODO(Rennorb): should we actually reset this every time?\r\n\t\tcyclePos = visibleIndex;\r\n\t\tcontext = specializeContextFromInlineAttribs(context, gw2Object);\r\n\t\ttooltip.replaceChildren(...generateToolTipList(data, gw2Object, context, statSetId, stackSize));\r\n\r\n\t\ttooltip.style.display = ''; //empty value resets actual value to use stylesheet\r\n\t\tif(Array.from(tooltip.children).filter(tt => !tt.classList.contains('not-collapsable')).length > 1) {\r\n\t\t\tgw2Object.classList.add('cycler')\r\n\t\t\tgw2Object.title = 'Right-click to cycle through tooltips'\r\n\t\r\n\t\t\tactivateSubTooltip(cyclePos)\r\n\t\t}\r\n\t\telse {\r\n\t\t\tfor(const tt of tooltip.children) tt.classList.add('active');\r\n\t\t}\r\n\t\tscrollSubTooltipIntoView(cyclePos)\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb): this is neither complete, nor reliable\r\nfunction getSlotName(skill: API.Skill) : string | undefined {\r\n\tlet skillSlot\r\n\tfor(const palette of skill.palettes) {\r\n\t\tfor(const slot of palette.slots) {\r\n\t\t\tswitch (palette.type) {\r\n\t\t\t\tcase 'Equipment':\r\n\t\t\t\tcase 'Bundle':\r\n\t\t\t\t\t//NOTE(Rennorb): mech skills are part pet part equipment skills...\r\n\t\t\t\t\t//TODO(Rennorb): Figure out a good way to get the actual slot name for that. Also look at actual pets.\r\n\t\t\t\t\tif(palette.weapon_type !== 'None' || palette.type == 'Bundle') {\r\n\t\t\t\t\t\t//TODO(Rennorb) @cleanup: move this to the api side\r\n\t\t\t\t\t\tskillSlot = slot.slot.replace(/(Offhand|Main)(\\d)/, (_, hand, digit) => {\r\n\t\t\t\t\t\t\tif(hand == 'Offhand') {\r\n\t\t\t\t\t\t\t\tdigit = digit === '1' ? '4' : '5'\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn `${mapLocale(palette.weapon_type)} ${digit}`\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'Standard':\r\n\t\t\t\t\tif(slot.slot === 'Standard') {\r\n\t\t\t\t\t\tskillSlot = 'Utility'\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'Heal':\r\n\t\t\t\tcase 'Toolbelt':\r\n\t\t\t\tcase 'Elite':\r\n\t\t\t\t\t\tskillSlot = palette.type;\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\t\tcase 'Pet':\r\n\t\t\t\tcase 'Profession':\r\n\t\t\t\t\tskillSlot = slot.slot\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase 'Monster':\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tconsole.error(`[gw2-tooltips] [tooltip engine] unknown palette type '${palette.type}' for skill '${skill.name}'`)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn skillSlot\r\n}\r\n\r\n// TODO(Rennorb) @cleanup: split this into the inflator system aswell. its getting to convoluted already\r\nfunction generateToolTip(apiObject : SupportedTTTypes, notCollapsable : boolean, context : Context) : HTMLElement {\r\n\tconst headerElements = [newImg(apiObject.icon), newElm('teb', GW2Text2HTML(apiObject.name).replaceAll('[s]', '')/* TODO(Rennorb) @cleanup: quick hack to get relics working */), newElm('div.flexbox-fill')]; // split, now the right side\r\n\r\n\tconst currentContextInformation = resolveTraitsAndOverrides(apiObject, context);\r\n\r\n\t// TODO(mithos): add no underwater check\r\n\tif(0) {\r\n\t\theaderElements.push(newImg(ICONS.NO_UNDERWATER, 'iconsmall'));\r\n\t}\r\n\r\n\tif(currentContextInformation.activation) {\r\n\t\tconst value = drawFractional(currentContextInformation.activation / 1000, config);\r\n\t\tif (value != '0') { //in case we rounded down a fractional value just above 0\r\n\t\t\theaderElements.push(newElm('ter',\r\n\t\t\t\tvalue,\r\n\t\t\t\tnewImg(ICONS.ACTIVATION, 'iconsmall')\r\n\t\t\t));\r\n\t\t}\r\n\t}\r\n\r\n\tif(currentContextInformation.resource_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(currentContextInformation.resource_cost),\r\n\t\t\t//TODO(Rennorb) @correctness: see reaper shroud\r\n\t\t\tnewImg(context.character.profession == 'Revenant' ? ICONS.RESOURCE_REV : ICONS.RESOURCE_THIEF, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tif(currentContextInformation.endurance_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(Math.round(currentContextInformation.endurance_cost)),\r\n\t\t\tnewImg(ICONS.ENDURANCE_COST, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tif(currentContextInformation.upkeep_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(currentContextInformation.upkeep_cost),\r\n\t\t\tnewImg(ICONS.UPKEEP_COST, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tif(currentContextInformation.recharge) {\r\n\t\tconst value = drawFractional(currentContextInformation.recharge / 1000, config);\r\n\t\tif (value != '0') {\r\n\t\t\theaderElements.push(newElm('ter',\r\n\t\t\t\tvalue,\r\n\t\t\t\tnewImg(ICONS.RECHARGE, 'iconsmall')\r\n\t\t\t));\r\n\t\t}\r\n\t}\r\n\r\n\tif(currentContextInformation.supply_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(currentContextInformation.supply_cost),\r\n\t\t\tnewImg(ICONS.SUPPLY_COST, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tconst secondHeaderRow = [];\r\n\t{\r\n\t\t//TODO(Rennorb): slots stuff might not be doable serverside since the server is missing context. this is at least a case of @cleanup\r\n\t\tlet slotName = ('slot' in apiObject && apiObject.slot) || ('palettes' in apiObject && getSlotName(apiObject));\r\n\t\tif(slotName) secondHeaderRow.push(newElm('tes', `( ${slotName} )`));\r\n\t}\r\n\r\n\tsecondHeaderRow.push(newElm('div.flexbox-fill')); // split, now the right side\r\n\r\n\tif('override_groups' in apiObject && apiObject.override_groups) {\r\n\t\tconst baseContext = new Set<GameMode>(['Pve', 'Pvp', 'Wvw']);\r\n\t\tfor(const override of apiObject.override_groups) {\r\n\t\t\tfor(const context of override.context) {\r\n\t\t\t\tbaseContext.delete(context as GameMode);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst splits = [Array.from(baseContext), ...apiObject.override_groups.map(o => o.context)]\r\n\r\n\t\tconst splits_html : string[] = [];\r\n\t\tfor(const mode of ['Pve', 'Pvp', 'Wvw'] as GameMode[]) { //loop to keep sorting vaguely correct\r\n\t\t\tlet split;\r\n\t\t\tfor(let i = 0; i < splits.length; i++) {\r\n\t\t\t\tif(splits[i].includes(mode)) {\r\n\t\t\t\t\tsplit = splits.splice(i, 1)[0];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(!split) continue;\r\n\r\n\t\t\tconst text = split.join('/');\r\n\t\t\tif(split.includes(context.gameMode))\r\n\t\t\t\tsplits_html.push(`<span style=\"color: var(--gw2-tt-color-text-accent) !important;\">${text}</span>`);\r\n\t\t\telse\r\n\t\t\t\tsplits_html.push(text);\r\n\t\t}\r\n\r\n\t\tsecondHeaderRow.push(newElm('tes', '( ', fromHTML(splits_html.join(' | ')), ' )'));\r\n\t}\r\n\r\n\tconst parts : HTMLElement[] = [newElm('tet.title', ...headerElements)];\r\n\tif(secondHeaderRow.length > 1) parts.push(newElm('tet.detail', ...secondHeaderRow));\r\n\r\n\tif('description' in apiObject && apiObject.description) {\r\n\t\tparts.push(newElm('p.description', fromHTML(GW2Text2HTML(apiObject.description))))\r\n\t}\r\n\r\n\tif(currentContextInformation.blocks) {\r\n\t\t//NOTE(Rennorb): 690.5 is the midpoint weapon strength for slot skills (except bundles).\r\n\t\t//TODO(Rennorb) @hardcoded @correctness: This value is hardcoded for usage with traits as they currently don't have any pointer that would provide weapon strength information.\r\n\t\t// This will probably fail in some cases where damage facts on traits reference bundle skills (e.g. kits).\r\n\t\tlet weaponStrength = 690.5;\r\n\t\tif('palettes' in apiObject && apiObject.palettes.length) {\r\n\t\t\tconst criteria = context.character.profession\r\n\t\t\t\t? ((s : API.Slot) => s.profession === context.character.profession)\r\n\t\t\t\t: ((s : API.Slot) => s.profession !== 'None');\r\n\t\t\tconst relevantPalette = apiObject.palettes.find(p => p.slots.some(criteria));\r\n\r\n\t\t\tif(relevantPalette) {\r\n\t\t\t\tweaponStrength = getWeaponStrength(relevantPalette)\r\n\t\t\t}\r\n\t\t}\r\n\t\tparts.push(...generateFacts(currentContextInformation.blocks, weaponStrength, context))\r\n\t}\r\n\r\n\tconst tooltip = newElm('div.tooltip', ...parts)\r\n\tif(notCollapsable) tooltip.classList.add('not-collapsable')\r\n\ttooltip.dataset.id = String(apiObject.id)\r\n\r\n\treturn tooltip;\r\n}\r\n\r\nexport function resolveTraitsAndOverrides(apiObject : SupportedTTTypes & { blocks? : API.ContextGroup['blocks'], override_groups? : API.ContextInformation['override_groups'] }, context : Context) : API.ContextInformation {\r\n\tlet override = apiObject.override_groups?.find(g => g.context.includes(context.gameMode));\r\n\tlet result = Object.assign({}, apiObject, override);\r\n\tresult.blocks = structuredClone(apiObject.blocks); // always have to clone this because we later on manipulate the facts\r\n\r\n\tif(result.blocks && override?.blocks) {\r\n\t\tconst end = Math.max(apiObject.blocks!.length, override.blocks.length);\r\n\t\tfor(let blockId = 0; blockId < end; blockId++) {\r\n\t\t\tconst baseBlock = apiObject.blocks![blockId];\r\n\t\t\tconst overrideBlock = override.blocks[blockId];\r\n\t\t\tif(!baseBlock && overrideBlock) {\r\n\t\t\t\tresult.blocks[blockId] = structuredClone(overrideBlock);\r\n\t\t\t}\r\n\t\t\telse if (overrideBlock) {\r\n\t\t\t\tif(!overrideBlock.facts) continue;\r\n\t\t\t\t//NOTE(Rennorb): trait restrictions only exist on the base block\r\n\r\n\t\t\t\t//TODO(Rennorb): description and trait requirements cannot be overridden. so is this the wrong structure then?\r\n\t\t\t\tif(!baseBlock.facts) {\r\n\t\t\t\t\tresult.blocks[blockId].facts = overrideBlock.facts.slice(); //clone the array\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconst facts = result.blocks[blockId].facts = baseBlock.facts.slice(); // clone the base facts so we don't override the 'definition'\r\n\t\t\t\tfor(const fact of overrideBlock.facts) {\r\n\t\t\t\t\tif(fact.requires_trait?.some(t => !context.character.traits.includes(t))) continue;\r\n\r\n\t\t\t\t\tif(fact.insert_before !== undefined) facts.splice(fact.insert_before, 0, fact);\r\n\t\t\t\t\telse facts.push(fact);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// else (baseBlock && !overrideBlock) -> we already have the base block in the array\r\n\t\t}\r\n\t}\r\n\r\n\tif(result.blocks) {\r\n\t\tconst finalBlocks = [];\r\n\t\tfor(const block of result.blocks) {\r\n\t\t\tif(block.trait_requirements?.some(t => !context.character.traits.includes(t))) continue;\r\n\t\t\t\r\n\t\t\tif(block.facts) {\r\n\t\t\t\tconst finalFacts = [];\r\n\t\t\t\tfor(let i = 0; i < block.facts.length; i++) {\r\n\t\t\t\t\tconst fact = block.facts[i];\r\n\r\n\t\t\t\t\tif(fact.requires_trait?.some(t => !context.character.traits.includes(t))) continue;\r\n\r\n\t\t\t\t\tfinalFacts.push(fact);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(fact.skip_next) i++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tblock.facts = finalFacts;\r\n\t\t\t}\r\n\t\t\tfinalBlocks.push(block);\r\n\t\t}\r\n\t\tresult.blocks = finalBlocks;\r\n\t}\r\n\r\n\treturn result;\r\n}\r\n\r\nfunction getWeaponStrength({ weapon_type, type : palette_type } : API.Palette) : number {\r\n\tif(weapon_type === 'None') {\r\n\t\tif(palette_type === 'Bundle') {\r\n\t\t\treturn 922.5\r\n\t\t}\r\n\r\n\t\t//NOTE(Rennorb): The default value. Im not 100% sure if this is correct in all cases.\r\n\t\treturn 690.5\r\n\t}\r\n\telse {\r\n\t\treturn {\r\n\t\t\tBundleLarge: 0,\r\n\t\t\tStandard   : 690.5,\r\n\t\t\tFocus      : 900,\r\n\t\t\tShield     : 900,\r\n\t\t\tTorch      : 900,\r\n\t\t\tWarhorn    : 900,\r\n\t\t\tGreatsword : 1100,\r\n\t\t\tHammer     : 1100,\r\n\t\t\tStaff      : 1100,\r\n\t\t\tBowLong    : 1050,\r\n\t\t\tRifle      : 1150,\r\n\t\t\tBowShort   : 1000,\r\n\t\t\tAxe        : 1000,\r\n\t\t\tSword      : 1000,\r\n\t\t\tDagger     : 1000,\r\n\t\t\tPistol     : 1000,\r\n\t\t\tScepter    : 1000,\r\n\t\t\tMace       : 1000,\r\n\t\t\tSpear      : 1000,\r\n\t\t\tSpeargun   : 1000,\r\n\t\t\tTrident    : 1000,\r\n\t\t}[weapon_type];\r\n\t}\r\n}\r\n\r\nfunction generateToolTipList(initialAPIObject : SupportedTTTypes, gw2Object: HTMLElement, context : Context, statSetId? : number, stackSize? : number) : HTMLElement[] {\r\n\tconst objectChain : { obj : SupportedTTTypes, notCollapsable : boolean }[] = []\r\n\tconst validPaletteTypes = ['Bundle', 'Heal', 'Elite', 'Profession', 'Standard', 'Equipment']\r\n\tconst adjustTraitedSkillIds = gw2Object.classList.contains('auto-transform');\r\n\r\n\tconst addObjectsToChain = (currentObj : SupportedTTTypes) => {\r\n\t\tlet hasChain = false;\r\n\t\tif('palettes' in currentObj) {\r\n\t\t\t//TODO(Rennorb): cleanup is this neccesary? Since the root element already gets replaced automatically, It would be if we have skills where some skill in the chain needs to be replaced. \r\n\t\t\tif(adjustTraitedSkillIds) {\r\n\t\t\t\tconst replacementSkill = findTraitedOverride(currentObj, context);\r\n\t\t\t\tif(replacementSkill) currentObj = replacementSkill;\r\n\t\t\t}\r\n\t\t\tobjectChain.push({ obj: currentObj, notCollapsable: false });\r\n\r\n\t\t\tconst palette = currentObj.palettes.find(p => validPaletteTypes.includes(p.type));\r\n\t\t\tif(palette) for(const slot of palette.slots) {\r\n\t\t\t\tif(slot.next_chain && slot.profession !== 'None') {\r\n\t\t\t\t\tconst nextSkillInChain = APICache.storage.skills.get(slot.next_chain);\r\n\t\t\t\t\tif(nextSkillInChain) {\r\n\t\t\t\t\t\thasChain = true;\r\n\t\t\t\t\t\taddObjectsToChain(nextSkillInChain)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tobjectChain.push({ obj: currentObj, notCollapsable: false })\r\n\t\t}\r\n\r\n\t\t//NOTE(Rennorb): Checking for the skill chain here since it usually produces duplicated entries if one is present and the skill chain is more authoritative.\r\n\t\t//NOTE(Rennorb): `related_skills` is also used for traits.\r\n\t\tif(!hasChain && 'related_skills' in currentObj) {\r\n\t\t\tconst type = gw2Object.getAttribute('type') || 'skill';\r\n\t\t\tfor(const subSkillId of currentObj.related_skills!) {\r\n\t\t\t\tconst subSkillInChain = APICache.storage.skills.get(subSkillId);\r\n\t\t\t\tif(subSkillInChain && ((type != 'skill') || subSkillInChain.palettes.some(palette => validPaletteTypes.includes(palette.type)))) {\r\n\t\t\t\t\tobjectChain.push({ obj: subSkillInChain, notCollapsable: false })\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//pet skills\r\n\t\tif('skills' in currentObj) for(const { id: petSkillId } of currentObj.skills) {\r\n\t\t\tlet petSkill = APICache.storage.skills.get(petSkillId);\r\n\t\t\tif(!petSkill) {\r\n\t\t\t\tconsole.warn(`[gw2-tooltips] pet skill #${petSkillId} is missing from the cache. The query was caused by `, gw2Object);\r\n\t\t\t\tpetSkill = MISSING_SKILL;\r\n\t\t\t}\r\n\t\t\tobjectChain.push({ obj: petSkill, notCollapsable: true })\r\n\t\t}\r\n\t}\r\n\r\n\taddObjectsToChain(initialAPIObject)\r\n\r\n\tconst tooltipChain = objectChain.map(({obj, notCollapsable}) => (\r\n\t\t('type' in obj) ? generateItemTooltip(obj, context, gw2Object, statSetId, stackSize) : generateToolTip(obj, notCollapsable, context)\r\n\t));\r\n\ttooltip.append(...tooltipChain);\r\n\treturn tooltipChain\r\n}\r\n\r\nexport function findTraitedOverride(skill : API.Skill, context : Context) : API.Skill | undefined {\r\n\tfor(const palette of skill.palettes) {\r\n\t\tfor(const slot of palette.slots) {\r\n\t\t\tif(slot.traited_alternatives) {\r\n\t\t\t\t//TODO(Rennorb): use buffs here\r\n\t\t\t\tconst pair = slot.traited_alternatives.find(([a, _]) => context.character.traits.includes(a));\r\n\t\t\t\tif(!pair) return;\r\n\r\n\t\t\t\tconst [traitId, altId] = pair;\r\n\t\t\t\tif(altId == skill.id) return;\r\n\r\n\t\t\t\tconst replacementSkill = APICache.storage.skills.get(altId);\r\n\t\t\t\tif(!replacementSkill) {\r\n\t\t\t\t\tconsole.error(`[gw2-tooltips] Corrected skill #${altId} is missing in the cache.`);\r\n\t\t\t\t\treturn undefined;\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.info(`[gw2-tooltips] Corrected skill #${skill.id} (${skill.name}) to #${replacementSkill.id} (${replacementSkill.name}) because the trait #${traitId} (${APICache.storage.traits.get(traitId)?.name || '<not cached>'}) is active.`);\r\n\t\t\t\t\t//TODO(Rennorb): Add indicator on the skill that its been replaced by a trait.\r\n\t\t\t\t\treturn replacementSkill;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction generateItemTooltip(item : API.Item, context : Context, target : HTMLElement, statSetId? : number, stackSize = 1) : HTMLElement {\r\n\tlet statSet : API.AttributeSet | undefined = undefined;\r\n\tif(item.type == \"Armor\" || item.type == \"Trinket\" || item.type == \"Weapon\") {\r\n\t\tstatSetId = statSetId || item.attribute_set;\r\n\t\tif(statSetId === undefined) console.warn(`[gw2-tooltips] [tooltip engine] Hovering on item without specified or innate stats. Specify the stats by adding 'stats=\"<stat_set_id>\" to the html element.' `);\r\n\t\telse {\r\n\t\t\tstatSet = APICache.storage.itemstats.get(statSetId);\r\n\t\t\tif(!statSet) console.error(`[gw2-tooltips] [tooltip engine] itemstat #${statSetId} is missing in cache.`);\r\n\t\t\telse {\r\n\t\t\t\t//TODO(Rennorb): should this happen at injection time?\r\n\t\t\t\tif(config.adjustIncorrectStatIds && statSet.similar_sets) {\r\n\t\t\t\t\tconst correctSetId = statSet.similar_sets[item.subtype];\r\n\t\t\t\t\tif(correctSetId !== undefined) {\r\n\t\t\t\t\t\tconsole.info(`[gw2-tooltips] [tooltip engine] Corrected itemstat #${statSetId} to #${correctSetId} because the target is of type ${item.subtype}.`);\r\n\t\t\t\t\t\tconst newSet = APICache.storage.itemstats.get(correctSetId);\r\n\t\t\t\t\t\tif(!newSet) console.error(`[gw2-tooltips] [tooltip engine] Corrected itemstat #${correctSetId} is missing in the cache.`);\r\n\t\t\t\t\t\telse statSet = newSet;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tlet slottedItems : (API.ItemBase & API.ItemUpgradeComponent)[] | undefined;\r\n\tif('slots' in item) {\r\n\t\tslottedItems = target.getAttribute('slotted')?.split(',')\r\n\t\t\t.map(id => APICache.storage.items.get(+String(id) || 0))\r\n\t\t\t.filter(i => i && 'subtype' in i) as (API.ItemBase & API.ItemUpgradeComponent)[];\r\n\t}\r\n\r\n\tconst countPrefix = stackSize > 1 ? stackSize + ' ' : '';\r\n\tconst upgradeNameSource = slottedItems?.find(i => !['Infusion', 'Enrichment'].includes(i.subtype)) || slottedItems?.[0];\r\n\tconst name = countPrefix + formatItemName(item, context, statSet, upgradeNameSource, stackSize);\r\n\tconst parts = [newElm('tet.title', newImg(item.icon),  newElm('teb.gw2-color-rarity-'+item.rarity.toLowerCase(), name), newElm('div.flexbox-fill'))];\r\n\r\n\tif('defense' in item && item.defense) {\r\n\t\tconst defense = (typeof item.defense  == \"number\")\r\n\t\t\t? item.defense\r\n\t\t\t: LUT_DEFENSE[Math.min(100, (item.defense[0] + context.character.level))] * item.defense[1];\r\n\r\n\t\tparts.push(newElm('te', newElm('tem', 'Defense: ', newElm('span.gw2-color-stat-green', String(defense)))));\r\n\t}\r\n\r\n\tif('power' in item) {\r\n\t\tlet power;\r\n\t\tif('mul' in item.power) {\r\n\t\t\tlet minRarity : keyof typeof LUT_RARITY = 'Common';\r\n\t\t\tif(['PlayerLevelScaleRarity', 'ItemScale4'].includes(item.power.scaling!)) {\r\n\t\t\t\t//NOTE(Rennorb) @hardcoded: these thresholds are apparently from a config\r\n\t\t\t\tif(context.character.level >= 14) minRarity = 'Uncommon'; // content:Configuration?guid=Wu52xQQYEUWiDdyKv+jf2Q==\r\n\t\t\t\telse if(context.character.level >= 30) minRarity = 'Rare'; // content:Configuration?guid=AX9BmdFkNkuyIpWOz58kmA==\r\n\t\t\t\telse if(context.character.level >= 60) minRarity = 'Exotic'; // content:Configuration?guid=X6vQWpTe2Ui+LPdJTv560g==\r\n\t\t\t\telse if(context.character.level >= 80) minRarity = 'Legendary'; // content:Configuration?guid=W2O5W4HAPEy3GJFfaSt4mQ==\r\n\t\t\t}\r\n\t\t\tlet index = Math.max(LUT_RARITY[item.rarity], LUT_RARITY[minRarity]);\r\n\t\t\tif(!item.power.scaling) //no scaling means ItemLevel scaling\r\n\t\t\t\tindex += item.level;\r\n\t\t\telse { //any of the other three\r\n\t\t\t\tindex += context.character.level;\r\n\t\t\t}\r\n\r\n\t\t\tconst avg = (context.character.isPlayer ? LUT_POWER_PLAYER : LUT_POWER_MONSTER)[Math.min(100, index)] * item.power.mul;\r\n\t\t\tconst spread = avg * item.power.spread;\r\n\t\t\tpower = [Math.ceil(avg - spread), Math.ceil(avg + spread)];\r\n\t\t}\r\n\t\telse {\r\n\t\t\tpower = item.power;\r\n\t\t}\r\n\r\n\t\tparts.push(newElm('te', newElm('tem', 'Weapon Strength: ', newElm('span.gw2-color-stat-green', `${power[0]} - ${power[1]}`))));\r\n\t}\r\n\r\n\tif('tiers' in item) {\r\n\t\tparts.push(generateUpgradeItemGroup(item, context));\r\n\t}\r\n\r\n\tif(statSet && 'attribute_base' in item) {\r\n\t\tparts.push(...statSet.attributes.map(({attribute, base_value, scaling}) => {\r\n\t\t\tconst computedValue = Math.round(base_value + item.attribute_base! * scaling);\r\n\t\t\treturn newElm('te', newElm('tem.gw2-color-stat-green', `+${computedValue} ${mapLocale(attribute)}`));\r\n\t\t}));\r\n\t}\r\n\r\n\tif('slots' in item) {\r\n\t\tparts.push(newElm('div.group.slots', ...item.slots.map(s => {\r\n\t\t\tlet slottedItemIdx = -1;\r\n\t\t\tif(slottedItems) {\r\n\t\t\t\tswitch(s) {\r\n\t\t\t\t\tcase 'Upgrade'   : slottedItemIdx = slottedItems.findIndex(i => ['Rune', 'Sigil', 'Gem'].includes(i.subtype)); break;\r\n\t\t\t\t\tcase 'Infusion'  : slottedItemIdx = slottedItems.findIndex(i => i.subtype == 'Infusion'); break;\r\n\t\t\t\t\tcase 'Enrichment': slottedItemIdx = slottedItems.findIndex(i => i.subtype == 'Enrichment'); break;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(slottedItemIdx > -1) {\r\n\t\t\t\tconst slottedItem = slottedItems!.splice(slottedItemIdx, 1)[0];\r\n\t\t\t\tconst group = generateUpgradeItemGroup(slottedItem, context);\r\n\t\t\t\tconst name = formatItemName(slottedItem, context, statSet);\r\n\t\t\t\tgroup.prepend(newElm('tet', newImg(slottedItem.icon, 'iconsmall'),  newElm('teb.gw2-color-rarity-'+slottedItem.rarity, name), newElm('div.flexbox-fill')));\r\n\t\t\t\treturn group;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\treturn newElm('te',\r\n\t\t\t\t\tnewImg(ICONS['SLOT_'+s as keyof typeof ICONS], 'iconsmall'), `Empty ${s} Slot`\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t})));\r\n\t}\r\n\r\n\tconst metaInfo = newElm('div.group');\r\n\t//NOTE(Rennorb): PvP amulets only show the stats, they aren't real 'items'.\r\n\tif(item.type == \"Armor\" || item.type == \"Weapon\" || (item.type == \"Trinket\" && !item.flags.includes('Pvp'))) {\r\n\t\tmetaInfo.append(newElm('span.gw2-color-rarity-'+item.rarity, item.rarity));\r\n\t\tif('weight' in item) metaInfo.append(newElm('span', item.weight));\r\n\t\tmetaInfo.append(newElm('span', `${item.type}: ${item.subtype}`));\r\n\t\tif(item.type == \"Weapon\" && isTwoHanded(item.subtype)) metaInfo.append(newElm('span.gw2-color-rarity-Junk', `(Two-Handed)`));\r\n\t\tif(item.required_level) metaInfo.append(newElm('span', 'Required Level: '+item.required_level));\r\n\t}\r\n\tif(item.description) metaInfo.append(newElm('span', fromHTML(GW2Text2HTML(item.description))));\r\n\r\n\tif(!item.flags.includes('Pvp')) { //NOTE(Rennorb): pvp items (runes / sigils) don't show these\r\n\t\tif(item.flags.includes('Unique')) metaInfo.append(newElm('span', 'Unique'));\r\n\t\tif(item.flags.includes('AccountBound')) metaInfo.append(newElm('span', 'Account Bound'));\r\n\t\tif(item.flags.includes('SoulBindOnUse')) metaInfo.append(newElm('span', 'Soulbound on Use'));\r\n\t\telse if(item.flags.includes('SoulBindOnAcquire')) metaInfo.append(newElm('span', 'Soulbound on Acquire'));\r\n\t}\r\n\r\n\tif(!item.flags.includes('NoSalvage')) {\r\n\t\tconst salvageOptions = [item.type == 'Consumable' && item.subtype == 'Food'\r\n\t\t\t? 'Compost'\r\n\t\t\t: item.rarity == 'Ascended' ? 'Ascended' : 'Standard'\r\n\t\t];\r\n\t\tif(item.flags_ex.includes('SalvageResearch')) salvageOptions.push('Research');\r\n\t\tif(salvageOptions.length) metaInfo.append(newElm('span', 'Salvage: '+salvageOptions.join(', ')));\r\n\t}\r\n\r\n\tif(item.vendor_value) {\r\n\t\tlet inner = ['Vendor Value: ', formatCoins(item.vendor_value * stackSize)];\r\n\t\tif(stackSize > 1)\r\n\t\t\tinner.push(' (', formatCoins(item.vendor_value), ` x ${stackSize})`);\r\n\t\tmetaInfo.append(newElm('span', ...inner));\r\n\t}\r\n\r\n\tparts.push(metaInfo);\r\n\r\n\tconst tooltip = newElm('div.tooltip.item.active', ...parts);\r\n\ttooltip.dataset.id = String(item.id);\r\n\treturn tooltip;\r\n}\r\n\r\nfunction generateUpgradeItemGroup(item : API.ItemUpgradeComponent | API.ItemConsumable, context : Context) : HTMLElement {\r\n\tconst group = newElm('div.group');\r\n\tfor(const [i, tier] of item.tiers.entries()) {\r\n\t\tlet tier_wrap = newElm('te');\r\n\t\tif(tier.description) tier_wrap.append(newElm('span', fromHTML(GW2Text2HTML(tier.description))));\r\n\r\n\t\t//NOTE(Rennorb): facts seem to exist, but almost universally be wrong.\r\n\t\telse if(tier.facts) {\r\n\t\t\tfor(const fact of tier.facts) {\r\n\t\t\t\tconst { wrapper } = generateFact(fact, null as any, context);\r\n\t\t\t\tif(wrapper) tier_wrap.append(wrapper);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\telse if(tier.modifiers) {\r\n\t\t\ttier_wrap.style.flexDirection = \"column\";\r\n\t\t\tfor(const modifier of tier.modifiers) {\r\n\t\t\t\t//TODO(Rennorb) @cleanup: unify this wth the buf fact processing\r\n\t\t\t\tlet modifierValue = calculateModifier(modifier, context.character);\r\n\r\n\t\t\t\tlet text;\r\n\t\t\t\tif(modifier.flags.includes('FormatPercent')) {\r\n\t\t\t\t\ttext = `+${Math.round(modifierValue)}% ${mapLocale(modifier.description as any)}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttext = `+${Math.round(modifierValue)} ${mapLocale(modifier.description as any)}`;\r\n\t\t\t\t}\r\n\t\t\t\ttier_wrap.append(newElm('te', text));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst w = newElm('te', tier_wrap);\r\n\t\tif(item.subtype == \"Rune\") {\r\n\t\t\tconst colorClass = i < (context.character.upgradeCounts[item.id] || 0) ? '.gw2-color-stat-green' : '';\r\n\t\t\tw.prepend(newElm('span'+colorClass, `(${i + 1})`));\r\n\t\t}\r\n\t\tgroup.append(w);\r\n\t}\r\n\r\n\treturn group;\r\n}\r\n\r\nfunction generateAttributeTooltip(attribute : BaseAttribute | ComputedAttribute, gw2Object : HTMLElement, context : Context) : HTMLElement {\r\n\tconst [_, parts] = computeAttributeFromMods(attribute, context, true);\r\n\treturn newElm('div.tooltip.item.active', ...parts);\r\n}\r\n\r\nfunction computeAttributeFromMods(attribute : BaseAttribute | ComputedAttribute, context : Context, generateHtml = false) : [number, HTMLElement[]] {\r\n\tlet { baseAttribute, suffix, isComputed, base, div } = getAttributeInformation(attribute, context);\r\n\tconst displayMul = suffix ? 100 : 1;\r\n\r\n\tlet value = base, text;\r\n\tconst parts = [];\r\n\r\n\tif(!baseAttribute) {\r\n\t\tif(generateHtml) parts.push(newElm('tet.title', newElm('teb', attribute)));\r\n\t}\r\n\telse {\r\n\t\t{\r\n\t\t\tif(generateHtml) {\r\n\t\t\t\ttext = `${n3(base * displayMul) + suffix} base value`;\r\n\t\t\t\tif(base) { text += ' from lvl 80'; }\r\n\t\t\t\tparts.push(newElm('div.detail', text));\r\n\t\t\t}\r\n\t\t\tif(isComputed) {\r\n\t\t\t\tlet stat = context.character.stats[baseAttribute];\r\n\t\t\t\t//NOTE(Rennorb): precision is processed really wired, so we just hard code this case\r\n\t\t\t\t//TODO(Rennorb) @scaling\r\n\t\t\t\tif(attribute == 'CritChance') stat -= 1000;\r\n\t\t\t\tconst statBonus = stat / div;\r\n\t\t\t\tvalue += statBonus;\r\n\r\n\t\t\t\tif(generateHtml && statBonus) {\r\n\t\t\t\t\ttext = ` + ${n3(statBonus * displayMul) + suffix} from ${n3(context.character.stats[baseAttribute])} ${mapLocale(baseAttribute)}`\r\n\t\t\t\t\tif(div != 1) text += ` / ${div / displayMul} (attrib. specific conv. factor)`\r\n\t\t\t\t\tparts.push(newElm('div.detail', text!));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet modValue = 0;\r\n\t\tfor(const source of context.character.statSources[attribute]) {\r\n\t\t\tlet mod = calculateModifier(source.modifier, context.character) * source.count;\r\n\t\t\tconst suffix = source.modifier.flags.includes('FormatPercent') ? '%' : '';\r\n\t\t\tconst displayMul = suffix ? 100 : 1;\r\n\t\t\tconst toAdd = suffix ? mod * value : mod;\r\n\t\t\tmodValue += toAdd;\r\n\t\t\t\r\n\t\t\tif(generateHtml) {\r\n\t\t\t\ttext = `+${n3(toAdd)}`;\r\n\t\t\t\tif(suffix) text += ` (${n3(mod * displayMul)}%)`;\r\n\t\t\t\ttext += ' from ';\r\n\t\t\t\tif(source.count > 1) text += `${source.count} `;\r\n\t\t\t\ttext += source.source;\r\n\t\t\t\tparts.push(newElm('div.detail', fromHTML(resolveInflections(text, source.count, context.character))));\r\n\t\t\t}\r\n\t\t}\r\n\t\tvalue += modValue;\r\n\r\n\t\tif(generateHtml) {\r\n\t\t\tparts.unshift(newElm('tet.title', newElm('teb', n3(value * displayMul) + suffix + ' ' + mapLocale(attribute))));\r\n\t\t}\r\n\t}\r\n\r\n\treturn [value, parts];\r\n}\r\n\r\nfunction getAttributeInformation<T_>(attribute : BaseAttribute | ComputedAttribute | T_, context : Context) {\r\n\tconst _p2 = ({\r\n\t\tPower            : ['Power'          ,  66722, '' , false,   1000,    1],\r\n\t\tToughness        : ['Toughness'      , 104162, '' , false,   1000,    1],\r\n\t\tVitality         : ['Vitality'       , 104163, '' , false,   1000,    1],\r\n\t\tPrecision        : ['Precision'      , 156609, '' , false,   1000,    1],\r\n\t\tFerocity         : ['Ferocity'       , 156602, '' , false,      0,    1],\r\n\t\tConditionDamage  : ['ConditionDamage', 156600, '' , false,      0,    1],\r\n\t\tExpertise        : ['Expertise'      , 156601, '' , false,      0,    1],\r\n\t\tConcentration    : ['Concentration'  , 156599, '' , false,      0,    1],\r\n\t\tHealingPower     : ['HealingPower'   , 156606, '' , false,      0,    1],\r\n\t\tAgonyResistance  : ['AgonyResistance', 536049, '' , false,      0,    1],\r\n\t\tHealth           : ['Vitality'       , 536052, '' , true ,      0,  0.1],\r\n\t\tArmor            : ['Toughness'      , 536048, '' , true ,      0,    1],\r\n\t\tConditionDuration: ['Expertise'      , 156601, '%', true ,      0, 1500],\r\n\t\tBoonDuration     : ['Concentration'  , 156599, '%', true ,      0, 1500],\r\n\t\tCritChance       : ['Precision'      , 536051, '%', true ,   0.05, 2100],\r\n\t\tCritDamage       : ['Ferocity'       , 784327, '%', true ,    1.5, 1500],\r\n\t} as { [k in BaseAttribute | ComputedAttribute]? : [BaseAttribute, number, string, boolean, number, number]})[attribute as Exclude<typeof attribute, T_>];\r\n\tlet baseAttribute, img, suffix = '', isComputed, base = 0, div = 1;\r\n\tif(_p2) [baseAttribute, img, suffix, isComputed, base, div] = _p2;\r\n\tif(attribute == 'Health') base = getBaseHealth(context.character);\r\n\treturn { baseAttribute, img, suffix, isComputed, base, div };\r\n}\r\n\r\nfunction getBaseHealth(character : Character) : number {\r\n\t//TODO(Rennorb): level scaling\r\n\treturn !character.profession\r\n\t\t? 1000 //TODO(Rennorb): none?\r\n\t\t: ({\r\n\t\t\t\tGuardian     : 1645,\r\n\t\t\t\tThief        : 1645,\r\n\t\t\t\tElementalist : 1645,\r\n\t\t\t\tEngineer     : 5922,\r\n\t\t\t\tRanger       : 5922,\r\n\t\t\t\tMesmer       : 5922,\r\n\t\t\t\tRevenant     : 5922,\r\n\t\t\t\tNecromancer  : 9212,\r\n\t\t\t\tWarrior      : 9212,\r\n\t\t\t} as { [k in Profession] : number })[character.profession];\r\n}\r\n\r\nfunction recomputeCharacterAttributes(context : Context) {\r\n\tconst attributeOrder : (BaseAttribute | ComputedAttribute)[] = [\r\n\t\t'Power', 'Toughness', 'Vitality', 'Precision', 'Ferocity', 'ConditionDamage', 'Expertise', 'Concentration', 'HealingPower', 'AgonyResistance',\r\n\t\t'Health', 'Armor', 'ConditionDuration', 'BoonDuration', 'CritChance', 'CritDamage',\r\n\t];\r\n\tfor(const attribute of attributeOrder) {\r\n\t\tconst [value, _] = computeAttributeFromMods(attribute, context);\r\n\t\tcontext.character.stats[attribute] = value;\r\n\t}\r\n}\r\n\r\nfunction calculateConditionDuration(level : number, expertise : number) {\r\n\treturn expertise / (LUT_CRITICAL_DEFENSE[level] * (15 / LUT_CRITICAL_DEFENSE[80]));\r\n}\r\n\r\nfunction calculateBoonDuration(level : number, concentration : number) {\r\n\treturn concentration / (LUT_CRITICAL_DEFENSE[level] * (15 / LUT_CRITICAL_DEFENSE[80]));\r\n}\r\n\r\n//TODO(Rennorb): have another look at the suffix. might still be missing in the export\r\n/** Does not format inflections if stackSize is < 0. */\r\nexport function formatItemName(item : API.Item, context : Context, statSet? : API.AttributeSet, upgradeComponent? : any, stackSize = 1) : string {\r\n\tlet name;\r\n\tif(item.type == 'TraitGuide') {\r\n\t\tname = item.trait;\r\n\t}\r\n\telse {\r\n\t\tname = item.name;\r\n\t}\r\n\r\n\tlet arg1, arg2, arg3, arg4;\r\n\targ1 = arg2 = arg3 = arg4 = '';\r\n\r\n\tif(!item.flags.includes('HidePrefix' as any)) { //TODO(Rennorb) @correctness: this flag comes from skindef and is currently not properly exported\r\n\t\tif(statSet && statSet.name) {\r\n\t\t\targ1 = statSet.name;\r\n\t\t\targ2 = \" \";\r\n\t\t}\r\n\t}\r\n\r\n\tif(!item.flags.includes('HideSuffix')) {\r\n\t\tif(upgradeComponent && upgradeComponent.suffix) {\r\n\t\t\targ4 = upgradeComponent.suffix;\r\n\t\t\targ3 = \" \";\r\n\t\t}\r\n\t}\r\n\r\n\tname = GW2Text2HTML(name, arg1, arg2, arg3, arg4);\r\n\tif(stackSize > -1)\r\n\t\tname = resolveInflections(name, stackSize, context.character);\r\n\r\n\tif(!item.flags.includes('Pve') && (item.flags.includes('Pvp') || item.flags.includes('PvpLobby')))\r\n\t\tname += \" (PvP)\";\r\n\r\n\treturn name;\r\n}\r\n\r\n//TODO(Rennorb): @docs\r\nexport function specializeContextFromInlineAttribs(context : Context, gw2Object : HTMLElement) : Context {\r\n\tlet traitOverrides;\r\n\tif(gw2Object.getAttribute('type') === 'skill' && (traitOverrides = gw2Object.getAttribute('with-traits'))) {\r\n\t\tcontext = structuredClone(context);\r\n\t\tconst invalid : string[] = [];\r\n\t\tcontext.character.traits = traitOverrides.split(',').map(t => {\r\n\t\t\tconst v = +t;\r\n\t\t\tif(!v) invalid.push(t);\r\n\t\t\treturn v;\r\n\t\t}).filter(t => t);\r\n\t\tif(invalid.length) console.warn(\"[gw2-tooltips] [tooltip engine] Inline trait-override for element \", gw2Object, \" has misformed overrides: \", invalid)\r\n\t}\r\n\treturn context;\r\n}\r\n\r\nfunction formatCoins(amount : number) : HTMLElement {\r\n\tconst parts = [String(Math.floor(amount % 100)), newImg(ICONS.COIN_COPPER, 'iconsmall', '')];\r\n\tif(amount > 99) parts.unshift(String(Math.floor((amount / 100) % 100)), newImg(ICONS.COIN_SILVER, 'iconsmall', ''));\r\n\tif(amount > 9999) parts.unshift(String(Math.floor(amount / 1_00_00)), newImg(ICONS.COIN_GOLD, 'iconsmall', ''));\r\n\treturn newElm('span', ...parts);\r\n}\r\n\r\nfunction isTwoHanded(type : API.WeaponDetailType) {\r\n\tswitch(type) {\r\n\t\tcase 'Axe'         : return false;\r\n\t\tcase 'Dagger'      : return false;\r\n\t\tcase 'Mace'        : return false;\r\n\t\tcase 'Pistol'      : return false;\r\n\t\tcase 'Scepter'     : return false;\r\n\t\tcase 'Focus'       : return false;\r\n\t\tcase 'Sword'       : return false;\r\n\t\tcase 'BowShort'    : return false;\r\n\t\tcase 'Torch'       : return false;\r\n\t\tcase 'Shield'      : return false;\r\n\t\tcase 'Warhorn'     : return false;\r\n\t\tcase 'Toy'         : return false;\r\n\t\tcase 'ToyTwoHanded': return false;\r\n\t\tcase 'BundleSmall' : return false;\r\n\r\n\t\tcase 'Hammer'     : return true;\r\n\t\tcase 'BowLong'    : return true;\r\n\t\tcase 'Greatsword' : return true;\r\n\t\tcase 'Polearm'    : return true;\r\n\t\tcase 'Rifle'      : return true;\r\n\t\tcase 'Staff'      : return true;\r\n\t\tcase 'BundleLarge': return true;\r\n\t\tcase 'Spear'      : return true;\r\n\t\tcase 'Speargun'   : return true;\r\n\t\tcase 'Trident'    : return true;\r\n\t}\r\n}\r\n\r\n//NOTE(Rennorb): stats are going to be processed separately\r\nexport const DEFAULT_CONTEXT : Context = {\r\n\tgameMode           : 'Pve',\r\n\ttargetArmor        : 2597,\r\n\tcharacter: {\r\n\t\tlevel            : 80,\r\n\t\tisPlayer         : true,\r\n\t\tsex              : \"Male\",\r\n\t\ttraits           : [],\r\n\t\tstats: {\r\n\t\t\tPower            : 1000,\r\n\t\t\tToughness        : 1000,\r\n\t\t\tVitality         : 1000,\r\n\t\t\tPrecision        : 1000,\r\n\t\t\tFerocity         : 0,\r\n\t\t\tConditionDamage  : 0,\r\n\t\t\tExpertise        : 0,\r\n\t\t\tConcentration    : 0,\r\n\t\t\tHealingPower     : 0,\r\n\t\t\tAgonyResistance  : 0,\r\n\t\t\tHealth           : 10000,\r\n\t\t\tArmor            : 1000,\r\n\t\t\tCritChance       : 0.05,\r\n\t\t\tCritDamage       : 1.5,\r\n\t\t\tConditionDuration: 0,\r\n\t\t\tBoonDuration     : 0,\r\n\t\t},\r\n\t\tstatSources: {\r\n\t\t\tPower            : [],\r\n\t\t\tToughness        : [],\r\n\t\t\tVitality         : [],\r\n\t\t\tPrecision        : [],\r\n\t\t\tFerocity         : [],\r\n\t\t\tConditionDamage  : [],\r\n\t\t\tExpertise        : [],\r\n\t\t\tConcentration    : [],\r\n\t\t\tHealingPower     : [],\r\n\t\t\tAgonyResistance  : [],\r\n\t\t\tArmor            : [],\r\n\t\t\tBoonDuration     : [],\r\n\t\t\tConditionDuration: [],\r\n\t\t\tCritChance       : [],\r\n\t\t\tCritDamage       : [],\r\n\t\t\tDamage           : [],\r\n\t\t\tLifeForce        : [],\r\n\t\t\tHealth           : [],\r\n\t\t\tHealEffectiveness: [],\r\n\t\t\tStun             : [],\r\n\t\t},\r\n\t\tupgradeCounts: {},\r\n\t},\r\n}\r\nfunction createCompleteContext(partialContext : PartialContext) : Context {\r\n\tif(partialContext.gameMode == \"Pvp\" && partialContext.character?.level && partialContext.character?.level != 80) {\r\n\t\tconsole.error('[gw2-tooltips] [init] supplied (partial) context has its gamemode set to pvp, but has a character level specified thats other than 80. In pvp you are always level 80. This will lead to unexpected results; Remove the explicit level or change the gamemode. The (partial) context in question is: ', partialContext);\r\n\t}\r\n\r\n\tconst stats = Object.assign({}, DEFAULT_CONTEXT.character.stats, partialContext.character?.stats);\r\n\tconst statSources = Object.assign({}, structuredClone(DEFAULT_CONTEXT.character.statSources), partialContext.character?.statSources);\r\n\tconst upgradeCounts = Object.assign({}, partialContext.character?.upgradeCounts);\r\n\tconst character = Object.assign({}, DEFAULT_CONTEXT.character, partialContext.character, { stats, statSources, upgradeCounts });\r\n\treturn Object.assign({}, DEFAULT_CONTEXT, partialContext, { character });\r\n}\r\n\r\nconst DEFAULT_CONFIG : Config = {\r\n\tautoInitialize                  : true,\r\n\tautoCollectRuneCounts           : true,\r\n\tautoCollectStatSources          : true,\r\n\tautoCollectSelectedTraits       : true,\r\n\tautoRecomputeCharacterAttributes: true,\r\n\tadjustIncorrectStatIds          : true,\r\n\tautoInferEquipmentUpgrades      : true,\r\n\tlegacyCompatibility             : true,\r\n\tshowPreciseAbilityTimings       : false,\r\n\tshowFactComputationDetail       : false,\r\n}\r\n\r\nexport const LUT_DEFENSE = [\r\n\t115, 120, 125, 129, 133, 137, 142, 146, 150, 154, 162, 168, 175, 182, 189, 196, 202, 209, 216, 223, 232, 240, 248, 257, 265, 274, 282, 290, 299, 307, 319, 330, 341, 352, 363, 374, 385, 396, 407, 418, 431, 443, 456, 469, 481, 494, 506, 519, 532, 544, 560, 575, 590, 606, 621, 636, 651, 666, 682, 697, 714, 731, 748, 764, 781, 798, 815, 832, 848, 865, 885, 905, 924, 943, 963, 982, 1002, 1021, 1040, 1060, 1081, 1102, 1123, 1144, 1165, 1186, 1207, 1228, 1249, 1270, 1291, 1312, 1333, 1354, 1375, 1396, 1417, 1438, 1459, 1480, 1501,\r\n];\r\n\r\nconst LUT_POWER_PLAYER = [\r\n\t170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 202, 207, 212, 217, 222, 227, 232, 237, 242, 247, 253, 259, 265, 271, 277, 283, 289, 295, 301, 307, 315, 323, 331, 339, 347, 355, 363, 371, 379, 387, 396, 405, 414, 423, 432, 441, 450, 459, 468, 477, 488, 499, 510, 521, 532, 543, 554, 565, 576, 587, 599, 611, 623, 635, 647, 659, 671, 683, 695, 707, 721, 735, 749, 763, 777, 791, 805, 819, 833, 847, 862, 877, 892, 907, 922, 937, 952, 967, 982, 997, 1012, 1027, 1042, 1057, 1072, 1087, 1102, 1117, 1132, 1147, 1162,\r\n];\r\n\r\nconst LUT_POWER_MONSTER = [\r\n\t162, 179, 197, 214, 231, 249, 267, 286, 303, 322, 344, 367, 389, 394, 402, 412, 439, 454, 469, 483, 500, 517, 556, 575, 593, 612, 622, 632, 672, 684, 728, 744, 761, 778, 820, 839, 885, 905, 924, 943, 991, 1016, 1067, 1093, 1119, 1145, 1193, 1220, 1275, 1304, 1337, 1372, 1427, 1461, 1525, 1562, 1599, 1637, 1692, 1731, 1802, 1848, 1891, 1936, 1999, 2045, 2153, 2201, 2249, 2298, 2368, 2424, 2545, 2604, 2662, 2723, 2792, 2854, 2985, 3047, 3191, 3269, 3348, 3427, 3508, 3589, 3671, 3754, 3838, 3922, 4007, 4093, 4180, 4267, 4356, 4445, 4535, 4625, 4717, 4809, 4902,\r\n];\r\n\r\nconst LUT_RARITY = {\r\n\tJunk     : 0,\r\n\tBasic    : 0,\r\n\tCommon   : 1,\r\n\tUncommon : 2,\r\n\tRare     : 3,\r\n\tExotic   : 4,\r\n\tAscended : 4,\r\n\tLegendary: 4,\r\n};\r\n\r\nconst LUT_CRITICAL_DEFENSE = [\r\n\t1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3.0, 3.2, 3.4, 3.6, 3.8, 4.0, 4.2, 4.4, 4.6, 4.8, 5.0, 5.2, 5.4, 5.6, 5.8, 6.0, 6.2, 6.4, 6.6, 6.8, 7.0, 7.3, 7.6, 7.9, 8.2, 8.5, 8.8, 9.1, 9.4, 9.7, 10.0, 10.3, 10.6, 10.9, 11.2, 11.5, 11.8, 12.1, 12.4, 12.7, 13.0, 13.4, 13.8, 14.2, 14.6, 15.0, 15.4, 15.8, 16.2, 16.6, 17.0, 17.4, 17.8, 18.2, 18.6, 19.0, 19.4, 19.8, 20.2, 20.6, 21.0, 21.5, 22.0, 22.5, 23.0, 23.5, 24.0, 24.5, 25.0, 25.5, 26.0, 26.5, 27.0, 27.5, 28.0, 28.5, 29.0, 29.5, 30.0, 30.5, 31.0,\r\n];\r\n\r\nexport const ICONS = {\r\n\tCOIN_COPPER     : 156902,\r\n\tCOIN_SILVER     : 156907,\r\n\tCOIN_GOLD       : 156904,\r\n\t//NOTE(Rennorb): lower case to make it compatible with the enum\r\n\tSLOT_Upgrade    : 517197,\r\n\tSLOT_Infusion   : 517202,\r\n\tSLOT_Enrichment : 517204,\r\n\r\n\tRESOURCE_THIEF  : 156649,\r\n\tRESOURCE_REV    : 156647,\r\n\tUPKEEP_COST     : 156058,\r\n\tSUPPLY_COST     : 2111003,\r\n\tENDURANCE_COST  : 156649,\r\n\tNO_UNDERWATER   : 358417,\r\n\tRECHARGE        : 156651,\r\n\tACTIVATION      : 496252,\r\n\tRANGE           : 156666,\r\n\tDEFIANCE_BREAK  : 1938788,\r\n\tWEAPON_SWAP     : 156583,\r\n\tBARRIER         : 1770209,\r\n\tSTUN_BREAK      : 156654,\r\n\tKNOCKDOWN       : 2440716,\r\n\tPULL            : 2440717,\r\n\tKNOCKBACK       : 2440715,\r\n\tLAUNCH          : 2440712,\r\n\tFLOAT           : 2440713,\r\n\tSINK            : 2440714,\r\n}\r\n\r\ntype SupportedTTTypes = API.Skill | API.Trait | API.ItemAmulet | OfficialAPI.Pet | API.Item; //TODO(Rennorb): change pet\r\n\r\n\r\n_constructor();\r\nif(config.autoInitialize) {\r\n\tconst buildNodes = document.getElementsByClassName('gw2-build-wrapper');\r\n\tif(config.autoCollectSelectedTraits) {\r\n\t\tif(buildNodes.length) for(const target of buildNodes)\r\n\t\t\tCollect.allTraits(target)\r\n\t\telse {\r\n\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoCollectSelectedTraits` is active, but no element with class `gw2-build` could be found to use as source. Build information will not be collected as there is no way to tell which objects belong to the build definition and which ones are just in some arbitrary text.\");\r\n\t\t}\r\n\t}\r\n\r\n\thookDocument(document)\r\n\t\t.then(gw2Objects => {\r\n\t\t\t//TODO(Rennorb) @cleanup: those routines could probably be combined into one when both options are active\r\n\t\t\tif(config.autoCollectRuneCounts) {\r\n\t\t\t\t//TODO(Rennorb) @correctness: this might not work properly with multiple builds on one page\r\n\t\t\t\tif(buildNodes.length) for(const target of buildNodes)\r\n\t\t\t\t\tCollect.allUpgradeCounts(target)\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoCollectRuneCounts` is active, but no element with class `gw2-build` could be found to use as source. Upgrades will not be collected as there is no way to tell which upgrades belongs to the build and which ones are just in some arbitrary text.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoCollectStatSources) {\r\n\t\t\t\tif(buildNodes.length) for(const target of buildNodes)\r\n\t\t\t\t\tCollect.allStatSources(target)\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoCollectStatSources` is active, but no element with class `gw2-build` could be found to use as source. Build information will not be collected as there is no way to tell which objects belong to the build definition and which ones are just in some arbitrary text.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoCollectSelectedTraits) {\r\n\t\t\t\tCollect.traitEffects(contexts);\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoInferEquipmentUpgrades) {\r\n\t\t\t\tconst targets = document.querySelectorAll('.weapon, .armor, .trinket');\r\n\t\t\t\tif(targets.length)\r\n\t\t\t\t\tinferItemUpgrades(targets)\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoInferEquipmentUpgrades` is active, but no wrapper elements element with class `'weapon`, `armor` or `trinket` could be found to use as source. No elements will be updated\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoRecomputeCharacterAttributes) {\r\n\t\t\t\tfor(const context of contexts) {\r\n\t\t\t\t\trecomputeCharacterAttributes(context);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//TODO(Rennorb) @cleanup: this will not be triggered by hook document which is technically not correct.\r\n\t\t\t// But for this to work is has to happen after the collect logic, which is not quite as easy to do.\r\n\t\t\t// Maybe a good approach would be to slice hook document into stages that can be enabled / disabled. This would also fix some config options only working with autoInit = true.\r\n\t\t\tfor(const [attribute, elements] of gw2Objects.attributes) {\r\n\t\t\t\tfor(const element of elements) {\r\n\t\t\t\t\tinflateAttribute(element, attribute as BaseAttribute | ComputedAttribute);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n}\r\n\r\nimport { newElm, newImg, GW2Text2HTML, mapLocale, drawFractional, fromHTML, findSelfOrParent, n3, resolveInflections } from './TUtilsV2';\r\nimport * as APIs from './API';\r\nimport APICache from './APICache';\r\nimport { MISSING_SKILL, calculateModifier, generateFact, generateFacts } from './FactsProcessor';\r\nimport * as Collect from './Collect'; //TODO(Rennorb) @cleanup\r\nimport { _legacy_transformEffectToSkillObject, inferItemUpgrades, inflateAttribute, inflateGenericIcon, inflateItem, inflateSkill, inflateSpecialization } from './Inflators'\r\n\r\n"],"names":["newElm","spec","inner","tag","classes","split","el","document","createElement","length","classList","add","append","IMAGE_CDN","missingImage","newImg","src","className","alt","img","includes","fromHTML","html","dummy","innerHTML","content","GW2Text2HTML","text","formatArgs","replaceAll","_","i","resolveInflections","count","character","sex","n3","v","withUpToNDigits","x","digits","str","toFixed","charAt","slice","drawFractional","value","config","showPreciseAbilityTimings","sign","Math","abs","fraction","min","round","floor","mapLocale","type","joinWordList","words","quoteWords","map","w","last","join","HSAPI","constructor","baseUrl","this","bulkRequest","endpoint","ids","fetch","then","r","json","hsApi","fallback","ex","console","warn","APICache","ensureExistence","initialIds","apiImpl","additionalIds","Object","assign","skills","Set","items","traits","pets","specializations","itemstats","findNextRelevantEndpoint","entries","size","currentEndpoint","storageSet","storage","request","Array","from","values","clear","info","response","unobtainable","filter","id","some","obj","datum","has","set","collectConnectedIds","error","connectedIdsStorage","addFacts","facts","fact","buff","prefix","palette","palettes","slot","slots","profession","next_chain","traited_alternatives","skillId","subSkill","related_skills","block","blocks","override_groups","attribute_set","subSkillId","calculateModifier","formula","base_amount","formula_param1","level_scaling","formula_param2","level","stats","Power","ConditionDamage","HealingPower","generateFact","weapon_strength","context","iconSlug","icon","buffStackSize","buffDuration","duration","generateBuffDescription","valueMod","modsArray","modifiers","description_brief","relevantModifiers","modifier","trait_req","mode","gameMode","modsMap","Map","entry","get","attribute_conversion","flags","apply_count","strValue","fround","toString","description","push","applyMods","detailStack","durMod","durationAttr","buff_type","attribVal","showFactComputationDetail","durModStack","statSources","percentMod","source","mod","name","valueModStack","HealEffectiveness","factInflators","AdjustByAttributeAndLevelHealing","attributeVal","target","attribute_multiplier","level_exponent","level_multiplier","hit_count","lines","_a","unshift","AttributeAdjust","range","Buff","MISSING_BUFF","buffDescription","seconds","name_brief","BuffBrief","Distance","distance","HealthAdjustHealing","attribute","multiplier","Number","Percent","percent","PercentDamage","PercentLifeForceAdjust","hpPool","Health","LifeForce","raw","PercentHealth","LifeForceAdjust","Damage","dmg_multiplier","weaponStrength","damage","targetArmor","critChance","Precision","critDamage","Ferocity","moreDmgFromCrit","times","Time","Stun","time","ComboField","field_type","ComboFinisher","finisher_type","BuffConversion","NoData","PrefixedBuff","details","list","generateBuffIcon","PrefixedBuffBrief","Range","max","StunBreak","data","firstLine","remainingDetail","wrapper","requires_trait","defianceBreak","defiance_break","breakDetail","undefined","trait_names","skip_next","d","stackSize","wrap","setAttribute","String","window","categories","MISSING_SKILL","allUpgradeCounts","scope","elements","getElementsByTagName","pair","contexts","elsInCorrectCtx","e","getAttribute","_upgradeCounts","elsWithWrongCtx","contextIndex","targetContext","counts","element","item","subtype","amountToAdd","legacyCompatibility","_legacy_getInfusionCount","upgradeCounts","GW2TooltipsContext","_b","_c","allStatSources","keys","_statSources","sources","Toughness","Vitality","Expertise","Concentration","AgonyResistance","Armor","BoonDuration","ConditionDuration","CritChance","CritDamage","upgrades","tiersToProcess","tierNumber","sourceRuneSuffix","attributeSet","tiers","attributeSetId","isNaN","attributes","a","target_attribute_or_buff","attribute_base","scaling","defense","LUT_DEFENSE","tier","formatItemName","k","ownIndex","prototype","indexOf","call","parentElement","children","amountEl","getElementsByClassName","textContent","match","allTraits","querySelectorAll","_traits","specialization","selectedPositions","y","traitEl","forEach","t","inflateGenericIcon","gw2Object","childElementCount","wikiLink","href","contains","cleanName","inflateSkill","skill","contextSet","specializeContextFromInlineAttribs","replacementSkill","findTraitedOverride","inflateItem","inflateSpecialization","style","backgroundImage","background","dataset","label","column","toggle","inflateAttribute","_p","MagicFind","suffix","displayMul","search","replaceChildren","_legacy_transformEffectToSkillObject","error_store","chaos_aura","dark_aura","fire_aura","frost_aura","light_aura","magnetic_aura","shocking_aura","aegis","alacrity","fury","might","protection","quickness","regeneration","resistance","resolution","stability","swiftness","vigor","bleeding","blinded","burning","chill","chilled","confusion","crippled","fear","immobilize","poison","slow","taunt","torment","vulnerability","weakness","daze","stun","agony","invulnerability","revealed","stealth","superspeed","unblockable","blight","bloodstone_blessed","blue_pylon_power","champion_of_the_legions","compromised","crowd_favor","curse_of_frailty","debilitated","debilitating_void","defense_up","derangement","elemental_empowerment","empowering_auras","equalization_matrix","expose_weakness","exposed","extreme_vulnerability","fixated","growing_rage_ashym","ignite","intervention","necrosis","not_sticking_together","nova","ooze_pheromone","photon_saturation","positive_flow","power_of_the_void","reinforced_armor","relentless_fire","retaliation_ashym","sentinel_retribution","shattering_ice","shell_shocked","spectral_darkness","sticking_together","synchronized_vitality","unnatural_signet","use_soul_binder","void_empowerment","xeras_embrace","hardCoded","barrier","ICONS","BARRIER","stunbreak","STUN_BREAK","knockdown","KNOCKDOWN","pull","PULL","knockback","KNOCKBACK","launch","LAUNCH","float","FLOAT","sink","SINK","innerText","title","cursor","tooltip","lastTooltipTarget","lastMouseX","lastMouseY","cyclePos","activateSubTooltip","tooltipIndex","tooltips","index","scrollSubTooltipIntoView","animate","transition","transform","offsetTop","offsetHeight","positionTooltip","wpadminbar","getElementById","topBarHeight","currentSubTooltip","tooltipXpos","offsetWidth","documentElement","clientWidth","tooltipYpos","scrollTop","setTimeout","left","top","async","hookDocument","_unused","objectsToGet","statsToGet","_legacy_effectErrorStore","objId_raw","elementsWithThisId","objId","addEventListener","showTooltipFor","display","Promise","all","key","inflator","cache","objects","visibleIndex","statSetId","parts","computeAttributeFromMods","generateAttributeTooltip","tt","initialAPIObject","objectChain","validPaletteTypes","adjustTraitedSkillIds","addObjectsToChain","currentObj","hasChain","notCollapsable","find","p","nextSkillInChain","subSkillInChain","petSkillId","petSkill","tooltipChain","statSet","slottedItems","adjustIncorrectStatIds","similar_sets","correctSetId","newSet","countPrefix","upgradeNameSource","rarity","toLowerCase","power","minRarity","LUT_RARITY","avg","isPlayer","LUT_POWER_PLAYER","LUT_POWER_MONSTER","mul","spread","ceil","generateUpgradeItemGroup","base_value","s","slottedItemIdx","findIndex","slottedItem","splice","group","prepend","metaInfo","weight","isTwoHanded","required_level","salvageOptions","flags_ex","vendor_value","formatCoins","generateItemTooltip","apiObject","headerElements","currentContextInformation","resolveTraitsAndOverrides","activation","ACTIVATION","resource_cost","RESOURCE_REV","RESOURCE_THIEF","endurance_cost","ENDURANCE_COST","upkeep_cost","UPKEEP_COST","recharge","RECHARGE","supply_cost","SUPPLY_COST","secondHeaderRow","slotName","skillSlot","weapon_type","replace","hand","digit","getSlotName","baseContext","override","delete","splits","o","splits_html","criteria","relevantPalette","palette_type","BundleLarge","Standard","Focus","Shield","Torch","Warhorn","Greatsword","Hammer","Staff","BowLong","Rifle","BowShort","Axe","Sword","Dagger","Pistol","Scepter","Mace","Spear","Speargun","Trident","getWeaponStrength","looseBlock","remainingBlocks","totalDefianceBreak","makeFactElements","sort","b","order","trait_requirements","blockFacts","defianceWrap","DEFIANCE_BREAK","generateFacts","generateToolTip","generateToolTipList","g","result","structuredClone","end","blockId","baseBlock","overrideBlock","insert_before","finalBlocks","finalFacts","_d","traitId","altId","tier_wrap","flexDirection","modifierValue","colorClass","generateHtml","baseAttribute","isComputed","base","div","_p2","Guardian","Thief","Elementalist","Engineer","Ranger","Mesmer","Revenant","Necromancer","Warrior","getAttributeInformation","stat","statBonus","modValue","toAdd","recomputeCharacterAttributes","attributeOrder","upgradeComponent","arg1","arg2","arg3","arg4","trait","traitOverrides","invalid","amount","COIN_COPPER","COIN_SILVER","COIN_GOLD","DEFAULT_CONTEXT","createCompleteContext","partialContext","_e","DEFAULT_CONFIG","autoInitialize","autoCollectRuneCounts","autoCollectStatSources","autoCollectSelectedTraits","autoRecomputeCharacterAttributes","autoInferEquipmentUpgrades","Junk","Basic","Common","Uncommon","Rare","Exotic","Ascended","Legendary","SLOT_Upgrade","SLOT_Infusion","SLOT_Enrichment","NO_UNDERWATER","RANGE","WEAPON_SWAP","GW2TooltipsConfig","APIs","body","appendChild","isMobile","test","navigator","userAgent","touch","event","pageX","pageY","node","self","selector","depth","current","matches","findSelfOrParent","preventDefault","scrollHandler","activeTT","scrollHeight","clientHeight","deltaY","detail","touches","clientY","scrollBy","passive","ctrlKey","altKey","log","_constructor","buildNodes","Collect.allTraits","gw2Objects","Collect.allUpgradeCounts","Collect.allStatSources","addModifiers","contextBoundInfo","Collect.traitEffects","targets","wrappers","remainingInfusionsByContext","ctx","c","enrichmentByContext","itemEl","upgradeEls","itemCtx","upgradeIds","u","remainingInfusions","infusionId","enrichment","attrString","inferItemUpgrades"],"mappings":"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AAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAGvgBiP,GAAmB,CACxB,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,MAGzfC,GAAoB,CACzB,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,K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"}