{"version":3,"file":"tooltips.min.js","sources":["../src/TUtilsV2.ts","../src/API.ts","../src/APICache.ts","../src/FactsProcessor.ts","../src/Collect.ts","../src/Inflators.ts","../src/TooltipsV2.ts"],"sourcesContent":["type HTMLElementMap = HTMLElementTagNameMap & {\r\n\t[k in string] : HTMLElement // just so we can produce arbitrary tags\r\n};\r\n\r\n/** @param spec expected to be of shape tagname[.class1[.class2[...]]] */\r\nexport function newElm<T extends keyof HTMLElementMap>(spec : T, ...inner : (string | Node)[]) : HTMLElementMap[T] {\r\n\tconst [tag, ...classes] = spec.split('.');\r\n\tconst el = document.createElement(tag);\r\n\tif(classes.length) el.classList.add(...classes);\r\n\tif(inner.length) el.append(...inner);\r\n\treturn el as HTMLElementMap[T]\r\n}\r\n\r\nconst iconSource = 'https://assets.gw2dat.com/'\r\nconst missingImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHEAAABuCAIAAACfnGvJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAMCSURBVHhe7ZjpkeowEAaJywERD9GQDMGwumyPLj+2XssH+/UPyjMjjVBjUWXf3oJGTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSU51inr8d0u02PVwp/xf/MHQvt9Hm/Be7PlMgIHhyzCjn9hNlpc7ebxe9hhNPp8QifpTdfuz9Oe3thjHH6Cndkfv7DWb0/syNbnN8QJuzkZr5q5K+Xk2C6BtbCTDEAZJDTuIfKi0tUKuZgHhBx89P1Zj5rtK4YQzspL43z6RnltFBR5DMVKVhGFPTy3UYBO6vo0GuIMcxpvs1O2gbhei0tbOazRusvmCe+x6nddDtbBA4/LmEFNfN1o57TOD0F5ZIDGOh0CbL91SrqDYZ07iiQ5etGdrxNpGkz9XowQ53GG2Sa7H5rFc095n1W1nzdqOPUXzbXGMVYp1FqlqlVxMCNXEd9kG806t2n87cw2KE4g53mO/fUKrJgxkzp5Ou5Paf//E4wtNPzUelupki+32k8+cZgMDpQ6V9w6ij+UAeee8/fcLovcsojpzxyyiOnPHLKI6c8csqDOx39MH0B5JRHTnmGO00v2uKLi0B8e7E8ghf+7aP5RimyDrC1ga9HPmIXp2ajy95tvEhwUaHJlpaouUandgD7OF3MpHijbrAlf13MmsOwoulQxruzu9NfGLClvtO6QTF2d87mNISWuWT7ZGtUMwJy2nLVKK2YBcqGx3Mmp+XUomQqGUcf9YpT3afZ2BBUoWFpElqYnm7ooY5P9n8a9QRcDz83lfylFdVcJnGoUAfudAjlD+FopM7CNZy27/aTKr2KU4c93Y6jD/gG13F6HeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklEdOeeSUR0555JRHTnnklOb9/gEv6oxxwmIw6QAAAABJRU5ErkJggg==';\r\nexport function newImg(src? : string | number, className? : string, alt? : string) : HTMLImageElement {\r\n\tif(typeof src == 'number') src = src + '.png'\r\n\t\r\n\tconst img = document.createElement('img')\r\n\t//NOTE(Rennorb): Full urls specify a protocol which is delilited by a colon. Not perferct but good enough for now.  https_:_ , data_:_image\r\n\timg.src = src ? (src.includes(':') ? src : iconSource + src) : missingImage;\r\n\tif(className) img.classList.add(className)\r\n\timg.alt = alt ? alt+' icon' : 'icon';\r\n\treturn img;\r\n}\r\n\r\nexport function fromHTML(html : string) : DocumentFragment {\r\n\tconst dummy = document.createElement('template');\r\n\tdummy.innerHTML = html;\r\n\treturn dummy.content;\r\n}\r\n\r\nexport const GW2Text2HTML = (text? : string, ...formatArgs : string[]) => text\r\n\t? text\r\n\t\t.replace(/<c=@(.*?)>(.*?)<\\/c>/g, `<span class=\"gw2-color-$1\">$2</span>`)\r\n\t\t.replace(/%%/g, '%')\r\n\t\t.replaceAll('[lbracket]', '[').replaceAll('[rbracket]', ']')\r\n\t\t.replaceAll('[null]', '')\r\n\t\t.replaceAll('\\n', '<br />')\r\n\t\t.replaceAll(/%str\\d%/g, (_, i) => formatArgs[+i - 1] || '')\r\n\t: '';\r\n\r\n//TODO(Rennorb) @cleanup: we should just use consistent names.\r\nexport const Uncapitalize = <T extends string>(str : T) => str.charAt(0).toLowerCase() + str.slice(1) as Uncapitalize<T>;\r\n\r\nexport function withUpToNDigits(x : number, digits : number) {\r\n\tlet str = x.toFixed(digits);\r\n\twhile(str.charAt(str.length - 1) === '0') str = str.slice(0, -1);\r\n\tif(str.charAt(str.length - 1) === '.') str = str.slice(0, -1);\r\n\treturn str;\r\n}\r\n\r\n//TODO(Rennorb) @cleanup @rename\r\nexport function drawFractional(value : number, config : Config) {\r\n\tif (!config.showPreciseAbilityTimings) {\r\n\t\tconst sign = value < 0 ? '-' : '';\r\n\t\tvalue = Math.abs(value);\r\n\t\tconst index = (Math.min(Math.round((value % 1) * 4), 4));\r\n\t\tlet fraction = '';\r\n\t\tswitch (index) {\r\n\t\t\tcase 0: \r\n\t\t\tcase 4:\r\n\t\t\t{\r\n\t\t\t\tvalue = Math.round(value);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase 1: {\r\n\t\t\t\tvalue = Math.floor(value);\r\n\t\t\t\tfraction = '¼';\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase 2: {\r\n\t\t\t\tvalue = Math.floor(value);\r\n\t\t\t\tfraction = '½';\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase 3: {\r\n\t\t\t\tvalue = Math.floor(value);\r\n\t\t\t\tfraction = '¾';\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(value == 0 && fraction == '') {\r\n\t\t\treturn '0';\r\n\t\t}\r\n\t\treturn `${sign}${value > 0 ? value : ''}${fraction}`;\r\n\t} else {\r\n\t\treturn withUpToNDigits(value, 3);\r\n\t}\r\n}\r\n\r\n//TODO(rennorb) @cleanup: rename\r\nexport function mapLocale(type : API.Attributes | API.ComboFinisherType | API.ComboFieldType | API.Palette['weapon_type']) {\r\n\tswitch (type) {\r\n\t\tcase 'ConditionDmg': return 'Condition Damage';\r\n\t\tcase 'Healing'     : return 'Healing Power';\r\n\t\tcase 'BowLong'     : return 'Longbow';\r\n\t\tcase 'BowShort'    : return 'Shortbow';\r\n\t\tcase 'Projectile20': return 'Projectile (20% Chance)';\r\n\t\tdefault: return type;\r\n\t}\r\n}\r\n\r\nexport function findSelfOrParent(self : Element, selector : string, depth = 10) : Element | null {\r\n\tlet current : Element | null = self;\r\n\twhile(current && depth-- > 0 && !current.matches(selector)) current = current.parentElement;\r\n\tif(depth == 0) return null;\r\n\treturn current;\r\n}\r\n\r\nexport function joinWordList(words : string[], quoteWords = false) {\r\n\tif(quoteWords) words = words.map(w => `'${w}'`);\r\n\tswitch(words.length) {\r\n\t\tcase 0: return '';\r\n\t\tcase 1: return words[0];\r\n\t\tdefault:\r\n\t\t\tconst last = words[words.length - 1];\r\n\t\t\treturn words.slice(0, -1).join(', ') + last;\r\n\t}\r\n}\r\n","//NOTE(Rennorb): The different API implementations exist to easily swap out the data source for a local one, or even the official api in theory.\r\n// If the API is not set on APICache it will set it to HSAPI on the first request to the cache.\r\n// This can be done by specifying the apiImpl config option.\r\n//TODO(Rennorb): readme\r\n\r\nexport class FakeAPI implements APIImplementation {\r\n\thsApi    = new HSAPI('http://127.0.0.1:3000');\r\n\tfallback = new HSAPI(); // since we now have a public api running we can jsut fall back to that\r\n\r\n\tasync bulkRequest<T extends keyof APIResponseTypeMap>(endpoint: T, ids: number[]): Promise<APIResponseTypeMap[T][]> {\r\n\t\ttry {\r\n\t\t\treturn await this.hsApi.bulkRequest(endpoint, ids);\r\n\t\t}\r\n\t\tcatch(ex) {\r\n\t\t\tconsole.warn(`[gw2-tooltips] [FakeAPI] error trying to get ep '${endpoint}' from localhost, will try to use the fallback API.\\n${ex}`);\r\n\t\t\treturn await this.fallback.bulkRequest(endpoint, ids);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class HSAPI implements APIImplementation {\r\n\tbaseUrl : string;\r\n\r\n\tpublic constructor(baseUrl : string = 'https://api-v0.hardstuck.gg') {\r\n\t\tthis.baseUrl = baseUrl;\r\n\t}\r\n\r\n\tasync bulkRequest<T extends keyof APIResponseTypeMap>(endpoint : T, ids : number[]) : Promise<APIResponseTypeMap[T][]> {\r\n\t\tif(['specializations', 'pvp/amulets'].includes(endpoint)) {\r\n\t\t\tconst response = await fetch(`https://api.guildwars2.com/v2/${endpoint}?ids=${ids.join(',')}`).then(r => r.json());\r\n\t\t\tif (endpoint == 'pvp/amulets') {\r\n\t\t\t\tconst modifierTranslation = {\r\n\t\t\t\t\tBoonDuration     : \"Concentration\",\r\n\t\t\t\t\tConditionDamage  : \"ConditionDmg\",\r\n\t\t\t\t\tConditionDuration: \"Expertise\", \r\n\t\t\t\t\tCritDamage       : \"Ferocity\",\r\n\t\t\t\t} as { [k in OfficialAPI.AmuletStats]? : Exclude<API.Attributes, 'None'> }\r\n\r\n\t\t\t\tconst transformed : API.ItemAmulet[] = [];\r\n\t\t\t\tfor(const obj of response as OfficialAPI.Amulet[]) {\r\n\t\t\t\t\tconst tier : API.ItemUpgradeComponent['tiers'][0] = { modifiers: [] }\r\n\t\t\t\t\t//hackedy hack hack\r\n\t\t\t\t\tfor(const [attribute_, adjustment] of Object.entries(obj.attributes)) {\r\n\t\t\t\t\t\tconst attribute = modifierTranslation[attribute_] || attribute_ as Exclude<API.Attributes, 'None'>;\r\n\r\n\t\t\t\t\t\ttier.modifiers!.push({\r\n\t\t\t\t\t\t\tformula       : \"NoScaling\",\r\n\t\t\t\t\t\t\tbase_amount   : adjustment,\r\n\t\t\t\t\t\t\tid            : -1, //TODO unused\r\n\t\t\t\t\t\t\tformula_param1: 0,\r\n\t\t\t\t\t\t\tformula_param2: 0,\r\n\t\t\t\t\t\t\ttarget_attribute_or_buff: attribute,\r\n\t\t\t\t\t\t\tdescription   : attribute,\r\n\t\t\t\t\t\t\tflags         : [],\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\ttransformed.push({\r\n\t\t\t\t\t\tid            : obj.id,\r\n\t\t\t\t\t\ttype          : \"Trinket\",\r\n\t\t\t\t\t\tsubtype       : \"Amulet\",\r\n\t\t\t\t\t\tname          : obj.name,\r\n\t\t\t\t\t\ticon          : obj.icon,\r\n\t\t\t\t\t\tflags         : ['Pvp', 'NoSalvage'],\r\n\t\t\t\t\t\tflags_ex      : [],\r\n\t\t\t\t\t\ttiers         : [tier],\r\n\t\t\t\t\t\trarity        : \"Exotic\",\r\n\t\t\t\t\t\tlevel         : 82,\r\n\t\t\t\t\t\trequired_level: 0,\r\n\t\t\t\t\t\tvendor_value  : 0,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn transformed as APIResponseTypeMap[T][];\r\n\t\t\t}\r\n\t\t\treturn response;\r\n\t\t}\r\n\r\n\t\treturn fetch(`${this.baseUrl}/${endpoint}?ids=${ids.join(',')}`).then(r => r.json());\r\n\t}\r\n}\r\n","export default class APICache {\r\n\tstatic storage : ObjectDataStorage = {\r\n\t\tskills         : new Map<number, API.Skill>(),\r\n\t\titems          : new Map<number, API.Item>(),\r\n\t\ttraits         : new Map<number, API.Trait>(),\r\n\t\tpets           : new Map<number, API.Pet>(),\r\n\t\t'pvp/amulets'  : new Map<number, API.ItemAmulet>(),\r\n\t\tspecializations: new Map<number, API.Specialization>(),\r\n\t\titemstats      : new Map<number, API.AttributeSet>(),\r\n\t}\r\n\r\n\tstatic apiImpl : APIImplementation\r\n\r\n\t//TODO(Rennorb): add option to api to send hybrid request to get all related information for a page\r\n\t/** This might actually fetch more data than just the ids specified and ensures that all data required to display the ids is available */\r\n\tstatic async ensureExistence<T extends Endpoints>(endpoint : T, initialIds : IterableIterator<number>) : Promise<void> {\r\n\t\tif(!this.apiImpl) {\r\n\t\t\tthis.apiImpl = new HSAPI()\r\n\t\t}\r\n\r\n\t\tlet additionalIds : { [k in Endpoints] : Set<number> } = Object.assign({\r\n\t\t\tskills         : new Set<number>(),\r\n\t\t\titems          : new Set<number>(),\r\n\t\t\ttraits         : new Set<number>(),\r\n\t\t\tpets           : new Set<number>(),\r\n\t\t\t'pvp/amulets'  : new Set<number>(),\r\n\t\t\tspecializations: new Set<number>(),\r\n\t\t\titemstats      : new Set<number>(),\r\n\t\t}, { [endpoint]: new Set(initialIds) })\r\n\r\n\t\tconst findNextRelevantEndpoint = () => {\r\n\t\t\tfor(const [endpoint, ids] of Object.entries(additionalIds))\r\n\t\t\t\tif(ids.size > 0)\r\n\t\t\t\t\treturn endpoint\r\n\t\t\treturn undefined\r\n\t\t}\r\n\r\n\t\tlet currentEndpoint : Endpoints | undefined = endpoint\r\n\t\tlet i = 0\r\n\t\tdo {\r\n\r\n\t\t\tconst storageSet = this.storage[currentEndpoint]\r\n\t\t\t//TODO(Rennorb): i really don't like this but it seems to be the most sensible way for now\r\n\t\t\tconst request = Array.from(additionalIds[currentEndpoint].values())\r\n\t\t\tadditionalIds[currentEndpoint].clear()\r\n\r\n\t\t\tconsole.info(`[gw2-tooltips] [API cache] round #${i++} for a ${endpoint} request, currently fetching ${currentEndpoint}. Ids: `, request)\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconst response = await this.apiImpl.bulkRequest(currentEndpoint, request)\r\n\t\t\t\t//TODO(Rennorb) @perf: provide option to disable this\r\n\t\t\t\tconst unobtainable = request.filter(id => !response.some(obj => obj.id == id))\r\n\t\t\t\tif(unobtainable.length) console.warn(`[gw2-tooltips] [API cache] Did not receive all requested ${currentEndpoint} ids. missing: `, unobtainable);\r\n\r\n\t\t\t\tfor(const datum of response) {\r\n\t\t\t\t\tif(storageSet.has(datum.id)) continue\r\n\r\n\t\t\t\t\tstorageSet.set(datum.id, datum as any) //TODO\r\n\t\t\t\t\tthis.collectConnectedIds({ endpoint: currentEndpoint, datum } as any, additionalIds)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tcatch(ex) {\r\n\t\t\t\tconsole.error(ex)\r\n\t\t\t}\r\n\t\t} while((currentEndpoint = findNextRelevantEndpoint()) && i < 100)\r\n\t}\r\n\r\n\tstatic collectConnectedIds({ endpoint, datum } : ConnectedIdDatum, connectedIdsStorage : { [k in Endpoints] : Set<number> }) : void {\r\n\t\tconst addFacts = (facts : API.Fact[]) => {\r\n\t\t\tfor(const fact of facts) {\r\n\t\t\t\tif(fact.type == 'Buff' || fact.type == 'BuffBrief') {\r\n\t\t\t\t\tif(!this.storage.skills.has(fact.buff))\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(fact.buff) // TODO(Rennorb) @correctness: are we sure about using the skill endpoint for this?\r\n\t\t\t\t}\r\n\t\t\t\tif(fact.type === 'PrefixedBuffBrief' || fact.type === 'PrefixedBuff') {\r\n\t\t\t\t\tif(!this.storage.skills.has(fact.prefix))\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(fact.prefix)\r\n\t\t\t\t\tif(!this.storage.skills.has(fact.buff))\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(fact.buff)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif('palettes' in datum) {\r\n\t\t\tfor(const palette of datum.palettes) {\r\n\t\t\t\tfor(const slot of palette.slots) {\r\n\t\t\t\t\tif(slot.profession !== 'None' && slot.next_chain && !this.storage.items.has(slot.next_chain)) {\r\n\t\t\t\t\t\tconnectedIdsStorage.skills.add(slot.next_chain)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif('related_skills' in datum && datum.related_skills) {\r\n\t\t\tfor(const subSkill of datum.related_skills)\r\n\t\t\t\tif(!this.storage.skills.has(subSkill))\r\n\t\t\t\t\tconnectedIdsStorage.skills.add(subSkill);\r\n\t\t}\r\n\r\n\t\tif('facts' in datum && datum.facts) {\r\n\t\t\taddFacts(datum.facts);\r\n\t\t}\r\n\r\n\t\tif('override_groups' in datum && datum.override_groups) {\r\n\t\t\tfor(const { facts } of datum.override_groups)\r\n\t\t\t\tif(facts)\r\n\t\t\t\t\taddFacts(facts);\r\n\t\t}\r\n\r\n\t\tif('attribute_set' in datum && datum.attribute_set) {\r\n\t\t\tif(!this.storage.itemstats.has(datum.attribute_set))\r\n\t\t\t\tconnectedIdsStorage.itemstats.add(datum.attribute_set);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb) @cleanup: disgusting\r\ntype ConnectedIdDatum = {\r\n\tendpoint : 'skills'\r\n\tdatum    : APIResponseTypeMap['skills']\r\n} | {\r\n\tendpoint : 'traits'\r\n\tdatum    : APIResponseTypeMap['traits']\r\n} | {\r\n\tendpoint : 'items'\r\n\tdatum    : APIResponseTypeMap['items']\r\n} | {\r\n\tendpoint : 'specializations'\r\n\tdatum    : APIResponseTypeMap['specializations']\r\n} | {\r\n\tendpoint : 'pets'\r\n\tdatum    : APIResponseTypeMap['pets']\r\n} | {\r\n\tendpoint : 'pvp/amulets'\r\n\tdatum    : APIResponseTypeMap['pvp/amulets']\r\n} | {\r\n\tendpoint : 'itemstats'\r\n\tdatum    : APIResponseTypeMap['itemstats']\r\n}\r\n\r\n(window as any).APICache = APICache; //@debug\r\n\r\nimport { HSAPI } from './API';\r\n","const MissingBuff : API.Skill = {\r\n\tid               : 0,\r\n\tname             : 'Missing Buff',\r\n\tdescription      : 'This Buff failed to load',\r\n\tcategories       : [],\r\n\tpalettes         : [],\r\n\tmodifiers        : [],\r\n}\r\n\r\nexport function calculateModifier(\r\n\t{ formula, base_amount, formula_param1: level_scaling, formula_param2 } : API.Modifier,\r\n\t{ level, stats: { power, conditionDmg, healing: healing_power }} : Character,\r\n) {\r\n\t//TODO(Rennorb): this is **screaming** tabledrive me\r\n\t//TODO(Rennorb) @correctness: attribute conversion e.g. Bountiful Maintenance Oil\r\n\tswitch (formula) {\r\n\t\tcase 'BuffLevelLinear':\r\n\t\t\treturn         level * level_scaling + base_amount\r\n\t\tcase 'ConditionDamage':\r\n\t\t\treturn         level * level_scaling + base_amount + conditionDmg * formula_param2\r\n\t\tcase 'ConditionDamageSquared':\r\n\t\t\treturn level * level * level_scaling + base_amount + conditionDmg * formula_param2\r\n\t\tcase 'NoScaling':\r\n\t\t\treturn                                 base_amount\r\n\t\tcase 'Regeneration':\r\n\t\t\treturn         level * level_scaling + base_amount + healing_power * formula_param2\r\n\t\tcase 'RegenerationSquared':\r\n\t\t\treturn level * level * level_scaling + base_amount + healing_power * formula_param2\r\n\t\tcase 'SpawnScaleLinear':\r\n\t\tcase 'TargetLevelLinear':\r\n\t\t\treturn         level * level_scaling + base_amount\r\n\t\tcase 'BuffFormulaType11':\r\n\t\t\treturn         level * level_scaling + base_amount - formula_param2\r\n\t\tcase 'Power':\r\n\t\t\treturn         level * level_scaling + base_amount + power * formula_param2\r\n\t\tcase 'PowerSquared':\r\n\t\t\treturn level * level * level_scaling + base_amount + power * formula_param2\r\n\t}\r\n\r\n\tconsole.warn('[gw2-tooltips] [facts processor] Could not find formula #', formula, ', using base amount for now!')\r\n\treturn base_amount; //TODO(Rennorb) @correctness\r\n}\r\n\r\n/** @param facts should already be context resolved */\r\nexport function generateFacts(facts : API.Fact[], weaponStrength : number, context : Context) : HTMLElement[] {\r\n\tlet totalDefianceBreak = 0\r\n\r\n\tconst factWraps = facts\r\n\t\t.sort((a, b) => a.order - b.order)\r\n\t\t.map(fact => {\r\n\t\t\tconst { wrapper, defiance_break } = generateFact(fact, weaponStrength, context);\r\n\t\t\ttotalDefianceBreak += defiance_break;\r\n\t\t\treturn wrapper;\r\n\t\t})\r\n\t\t.filter(d => d) as HTMLElement[] // ts doesn't understand what the predicate does\r\n\r\n\t//TODO(Rennorb): This should use order 1003\r\n\tif(totalDefianceBreak > 0) {\r\n\t\tconst defianceWrap = newElm('div.fact',\r\n\t\t\tnewImg(ICONS.DEFIANCE_BREAK, 'iconmed'),\r\n\t\t\tnewElm('div.gw2-color-defiance-fact', `Defiance Break: ${withUpToNDigits(totalDefianceBreak, 2)}`)\r\n\t\t)\r\n\t\tfactWraps.push(defianceWrap)\r\n\t}\r\n\r\n\treturn factWraps\r\n}\r\n\r\n/** @param fact should already be context resolved */\r\nexport function generateFact(fact : API.Fact, weapon_strength : number, context : Context) : { wrapper? : HTMLElement, defiance_break : number } {\r\n\tlet iconSlug : Parameters<typeof newImg>[0] = fact.icon;\r\n\tlet buffStackSize = 1;\r\n\tlet buffDuration = (fact as API.BuffFact).duration;\r\n\r\n\tconst generateBuffDescription = (buff : API.Skill, fact : API.BuffFact | API.PrefixedBuffFact, duration : Milliseconds, valueMod : number  /* TODO(Rennorb): kindof a weird hack for now. maybe merge the two export functions? */) => {\r\n\t\tlet modsArray: string[] = []\r\n\t\tif(buff.modifiers && !buff.description_brief) { // early bail to not have to do the work if we use the description anyways\r\n\t\t\t//TODO(Rennorb) @consistency: gamemode splitting for mods (?)\r\n\t\t\tconst relevantModifiers = buff.modifiers.filter(modifier => (\r\n\t\t\t\t\t\t(!modifier.trait_req || context.character.traits.includes(modifier.trait_req))\r\n\t\t\t\t&& (!modifier.mode || modifier.mode === context.gameMode)\r\n\t\t\t));\r\n\r\n\t\t\t//NOTE(Rennorb): Modifiers can 'stack'. For that reason we need to first collect the values and then create text from that, otherwise we get duplicates.\r\n\t\t\tlet modsMap = new Map<number, { modifier : API.Modifier, value : number }>();\r\n\t\t\tfor (let i = 0; i < relevantModifiers.length; i++) {\r\n\t\t\t\tconst modifier = relevantModifiers[i];\r\n\r\n\t\t\t\tlet entry = modsMap.get(modifier.id) || modsMap.set(modifier.id, { modifier: modifier, value: 0 }).get(modifier.id);\r\n\t\t\t\tlet value = calculateModifier(modifier, context.character);\r\n\t\t\t\tif (modifier.attribute_conversion) {\r\n\t\t\t\t\t\tvalue *= context.character.stats[Uncapitalize(modifier.attribute_conversion)];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tentry!.value += value;\r\n\r\n\t\t\t\tif(modifier.flags.includes('SkipNextEntry')) {\r\n\t\t\t\t\ti++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor(let { value, modifier } of modsMap.values()) {\r\n\t\t\t\tif(modifier.flags.includes('Subtract')) {\r\n\t\t\t\t\tvalue -= 100;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(modifier.flags.includes('MulByDuration')) {\r\n\t\t\t\t\tduration /= 1000;\r\n\t\t\t\t\tif(modifier.flags.includes('DivDurationBy3')) { //TODO(Rennorb): move to api side and remove this\r\n\t\t\t\t\t\tduration /= 3;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(modifier.flags.includes('DivDurationBy10')) { //TODO(Rennorb): move to api side and remove this\r\n\t\t\t\t\t\tduration /= 10;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvalue *= duration || 1;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(!modifier.flags.includes('NonStacking')) {\r\n\t\t\t\t\tvalue *= fact.apply_count;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(modifier.formula.includes('Regeneration'))\r\n\t\t\t\t\tvalue *= valueMod;\r\n\r\n\t\t\t\tlet strValue = modifier.flags.includes('FormatFraction')\r\n\t\t\t\t\t? drawFractional(value, config)\r\n\t\t\t\t\t: Math.floor(value).toString();\r\n\r\n\t\t\t\tif(modifier.flags.includes('FormatPercent')) {\r\n\t\t\t\t\tif(value > 0 ) {\r\n\t\t\t\t\t\tstrValue = '+' + strValue;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tstrValue += '%'\r\n\t\t\t\t}\r\n\t\t\t\tstrValue += ' ' + modifier.description;\r\n\r\n\t\t\t\tmodsArray.push(strValue);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn GW2Text2HTML(buff.description_brief || modsArray.join(', ') || buff.description)\r\n\t}\r\n\r\n\tconst applyMods = (duration : Milliseconds, buff : API.Skill, detailStack : (string | Node)[]) : [Milliseconds, number] => {\r\n\t\tlet durMod = 1, valueMod = 1;\r\n\t\tconst durationAttr : keyof Stats | false = (buff.buff_type == 'Boon' && 'concentration') || (buff.buff_type == 'Condition' && 'expertise');\r\n\t\tif(durationAttr) {\r\n\t\t\tconst attribVal = context.character.stats[durationAttr];\r\n\t\t\t// every 15 points add 1%\r\n\t\t\tdurMod += attribVal / 15 * 0.01;\r\n\t\t\tif(attribVal > 0 && config.showFactComputationDetail) {\r\n\t\t\t\tdetailStack.push(`base duration: ${drawFractional(duration / 1000, config)}s`);\r\n\t\t\t\tdetailStack.push(`+${withUpToNDigits(attribVal / 15, 2)}% from ${attribVal} ${durationAttr}`);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//TODO(Rennorb) @correctness: this is probably not quite stable, but its good enough for now\r\n\t\tlet durModStack = context.character.statSources[buff.id];\r\n\t\tif(durModStack) {\r\n\t\t\t//NOTE(Rennorb): Just in case we didn't have a stat duration increase. Im aware that this is jank, but i cant think of a better way rn.\r\n\t\t\tif(durMod === 1 && config.showFactComputationDetail) detailStack.push(`base duration: ${drawFractional(duration / 1000, config)}s`);\r\n\t\t\tlet percentMod = 0;\r\n\t\t\tfor(const { source, modifier, count } of durModStack) {\r\n\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tdetailStack.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : '')); //TODO(Rennorb) @cleanup: im not really happy with how this works right now. Storing html in the text is not what i like to do but it works for now. Multiple of this.\r\n\t\t\t\tpercentMod += mod;\r\n\t\t\t}\r\n\t\t\tdurMod += percentMod / 100;\r\n\t\t}\r\n\t\tduration *= durMod;\r\n\r\n\t\tif(buff.name.includes('Regeneration')) {\r\n\t\t\tlet valueModStack = context.character.statSources.healEffectiveness;\r\n\t\t\tif(valueModStack.length) {\r\n\t\t\t\t//TODO(Rennorb)\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tdetailStack.push('regeneration value mods:');\r\n\t\t\t\tlet percentMod = 0;\r\n\t\t\t\tfor(const { source, modifier, count } of valueModStack) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tdetailStack.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : ''));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tvalueMod += percentMod / 100;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\r\n\t\treturn [duration, valueMod];\r\n\t}\r\n\r\n\tconst factInflators : { [k in typeof fact.type] : (params : HandlerParams<API.FactMap[k]>) => (string|Node)[] } = {\r\n\t\tAdjustByAttributeAndLevelHealing : ({fact}) =>  {\r\n\t\t\tconst attributeVal = (context.character.stats as any)[Uncapitalize(fact.target)] || 0; //TODO(Rennorb) @cleanup\r\n\t\t\tlet value = (fact.value + attributeVal * fact.attribute_multiplier + context.character.level ** fact.level_exponent * fact.level_multiplier) * fact.hit_count;\r\n\r\n\t\t\tconst lines = [];\r\n\r\n\t\t\tif(config.showFactComputationDetail) {\r\n\t\t\t\tlines.push(`${fact.value} base value`);\r\n\t\t\t\tif(fact.level_multiplier) lines.push(`+ ${withUpToNDigits(context.character.level ** fact.level_exponent * fact.level_multiplier, 2)} from lvl ${context.character.level} ^ ${fact.level_exponent} lvl exp. * ${fact.level_multiplier} lvl mul.`);\r\n\t\t\t\tif(attributeVal) lines.push(`+ ${withUpToNDigits(attributeVal * fact.attribute_multiplier, 2)} from ${attributeVal} ${mapLocale(fact.target)} * ${fact.attribute_multiplier} attrib mod.`);\r\n\t\t\t\tif(fact.hit_count != 1) lines.push(` * ${fact.hit_count} hits`);\r\n\t\t\t}\r\n\r\n\t\t\tif(!fact.text?.includes('Barrier')) { //TODO(Rennorb) @cleanup @correctness\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.healEffectiveness) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : ''));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tvalue *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\tlines.unshift(`${GW2Text2HTML(fact.text) || mapLocale(fact.target)}: ${Math.round(value)}`);\r\n\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tAttributeAdjust : ({fact}) => {\r\n\t\t\tconst value = Math.round((fact.range[1] - fact.range[0]) / (context.character.level / 80) + fact.range[0]);\r\n\t\t\tconst sign = value > 0 ? '+' : ''\r\n\t\t\tconst text = GW2Text2HTML(fact.text) || mapLocale(fact.target);\r\n\t\t\treturn [`${text}: ${sign}${value}`];\r\n\t\t},\r\n\t\tBuff : ({fact, buff}) =>  {\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MissingBuff; // in case we didn't get the buff we wanted from the api\r\n\t\t\ticonSlug = buff.icon || iconSlug;\r\n\r\n\t\t\tconst lines : (string | Node)[] = [];\r\n\t\t\tlet valueMod;\r\n\t\t\t[buffDuration, valueMod] = applyMods(fact.duration, buff, lines);\r\n\r\n\t\t\tlet buffDescription = generateBuffDescription(buff, fact, buffDuration, valueMod);\r\n\t\t\tif(buffDescription) {\r\n\t\t\t\tbuffDescription = `: ${buffDescription}`;\r\n\t\t\t}\r\n\r\n\t\t\tconst seconds = buffDuration > 0 ? `(${drawFractional(buffDuration / 1000, config)}s)`: '';\r\n\t\t\tlines.unshift(`${GW2Text2HTML(fact.text) || buff.name_brief || buff.name} ${seconds}${buffDescription}`);\r\n\r\n\t\t\tbuffStackSize = fact.apply_count;\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tBuffBrief : ({fact, buff}) =>  {\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MissingBuff;\r\n\t\t\ticonSlug = buff.icon || iconSlug;\r\n\r\n\t\t\treturn [`${GW2Text2HTML(fact.text, buff.name)}`];\r\n\t\t},\r\n\t\tDistance : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${Math.round(fact.distance)}`];\r\n\t\t},\r\n\t\tHealthAdjustHealing: ({ fact }) => {\r\n\t\t\t//TODO(Rennorb) @cleanup @scaling\r\n\t\t\tconst attribute = (context.character.stats as any)[Uncapitalize(fact.attribute)] || 0;\r\n\t\t\tconst value = Math.round((fact.value + attribute * fact.multiplier) * fact.hit_count);\r\n\t\t\tconst text = GW2Text2HTML(fact.text) || mapLocale(fact.attribute);\r\n\r\n\t\t\treturn [`${text}: ${value}`];\r\n\t\t},\r\n\t\tNumber : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${drawFractional(fact.value, config)}`];\r\n\t\t},\r\n\t\tPercent : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${drawFractional(fact.percent, config)}%`];\r\n\t\t},\r\n\t\tPercentDamage : ({fact}) => {\r\n\t\t\t// TODO(mithos) game shows an actual raw number here. to implement this we need to get the characters damage\r\n\t\t\t//NOTE(Rennorb): this is going to be verry difficult if not impossible\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${drawFractional(fact.percent, config)}%`];\r\n\t\t},\r\n\t\tPercentLifeForceAdjust : ({fact: {percent, text}}) => {\r\n\t\t\tconst hpPool = getHealth(context.character);\r\n\r\n\t\t\tconst lines = [];\r\n\t\t\tif(context.character.statSources.lifeForce.length) {\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tlines.push(`${percent * hpPool * 0.69} from ${percent}% * (${hpPool} HP * 0.69) base pool`);\r\n\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.lifeForce) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : ''));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tpercent *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\t//NOTE(Rennorb): lifeforce is 69% of the hp pool\r\n\t\t\tlet raw = Math.round(hpPool * 0.69 * percent * 0.01);\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}: ${drawFractional(percent, config)}% (${raw})`);\r\n\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tPercentHealth : ({fact: {percent, text}}) => {\r\n\t\t\tconst raw = Math.round((getHealth(context.character) * percent) * 0.01);\r\n\t\t\treturn [`${GW2Text2HTML(text)}: ${drawFractional(percent, config)}% (${raw})`];\r\n\t\t},\r\n\t\t//TODO(Rennorb) @correctness: this seems to be verry much percent based. Whats the difference to PercentLifeForceAdjust here?\r\n\t\tLifeForceAdjust : ({fact: {percent, text}}) => {\r\n\t\t\tconst hpPool = getHealth(context.character);\r\n\r\n\t\t\tconst lines = [];\r\n\t\t\tif(context.character.statSources.lifeForce.length) {\r\n\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\tlines.push(`${withUpToNDigits(percent * 0.01 * hpPool * 0.69, 3)} from ${percent}% * (${hpPool} HP * 0.69) base pool`);\r\n\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.lifeForce) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : ''));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tpercent *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\t//NOTE(Rennorb): lifeforce is 69% of the hp pool\r\n\t\t\tlet raw = Math.round(hpPool * 0.69 * percent * 0.01);\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}: ${drawFractional(percent, config)}% (${raw})`);\r\n\t\t\t\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tDamage : ({fact: {dmg_multiplier, hit_count, text}, weaponStrength}) => {\r\n\t\t\tconst lines = [];\r\n\t\t\t\r\n\t\t\tlet damage = dmg_multiplier * hit_count * weaponStrength * context.character.stats.power / context.targetArmor;\r\n\t\t\tif(config.showFactComputationDetail) {\r\n\t\t\t\tlines.push(`${withUpToNDigits(damage, 2)} from ${withUpToNDigits(dmg_multiplier, 2)} internal mod. * ${context.character.stats.power} power * ${weaponStrength} avg. weapon str. / ${context.targetArmor} target armor`);\r\n\t\t\t\tif(hit_count != 1) lines.push(`* ${hit_count} hits`);\r\n\t\t\t}\r\n\r\n\t\t\t//TODO(Rennorb): level scaling attributes. these are for lvl 80\r\n\t\t\tconst critChance = Math.min(0.05 + (context.character.stats.precision - 1000) / 21 * 0.01, 1);\r\n\t\t\t//TODO(Rennorb): crit damage mods\r\n\t\t\tconst critDamage = 1.5 + context.character.stats.ferocity / 15 * 0.01;\r\n\t\t\tconst moreDmgFromCrit = damage * critChance * (critDamage - 1);\r\n\t\t\tdamage += moreDmgFromCrit;\r\n\t\t\tif(config.showFactComputationDetail) {\r\n\t\t\t\tlines.push(`+${withUpToNDigits(moreDmgFromCrit, 2)} (${withUpToNDigits(critChance * (critDamage - 1) * 100, 2)}%) from ${withUpToNDigits(critChance * 100, 2)}% crit chance and ${withUpToNDigits(critDamage * 100, 2)}% damage on crit (${withUpToNDigits(context.character.stats.precision, 2)} precision and ${withUpToNDigits(context.character.stats.ferocity, 2)} ferocity)`);\r\n\t\t\t}\r\n\r\n\t\t\tif(context.character.statSources.damage.length) {\r\n\t\t\t\tlet percentMod = 100;\r\n\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.damage) {\r\n\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : ''));\r\n\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t}\r\n\t\t\t\tdamage *= percentMod / 100;\r\n\t\t\t}\r\n\r\n\t\t\tconst times = hit_count > 1 ? `(${hit_count}x)` : '';\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}${times}: ${Math.round(damage)}`);\r\n\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tTime : ({fact: { duration, text }}) => {\r\n\t\t\tconst lines = [];\r\n\t\t\t//TODO(Rennorb) @cleanup\r\n\t\t\tif(text && (text.includes('Stun') || text.includes('Daze'))) {\r\n\t\t\t\tif(context.character.statSources.stun.length) {\r\n\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\tlines.push(`${duration / 1000}s base duration`);\r\n\t\t\t\t\tlet percentMod = 100;\r\n\t\t\t\t\tfor(const { source, modifier, count } of context.character.statSources.stun) {\r\n\t\t\t\t\t\tconst mod = calculateModifier(modifier, context.character);\r\n\t\t\t\t\t\tif(config.showFactComputationDetail)\r\n\t\t\t\t\t\t\tlines.push(newElm('span.detail', `${mod > 0 ? '+' : ''}${mod}% from `, fromHTML(source), count > 1 ? ` (x ${count})` : ''));\r\n\t\t\t\t\t\tpercentMod += mod;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tduration *= percentMod / 100;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tconst time = duration != 1000 ? 'seconds' : 'second';\r\n\t\t\tlines.unshift(`${GW2Text2HTML(text)}: ${drawFractional(duration / 1000, config)} ${time}`);\r\n\t\t\treturn lines;\r\n\t\t},\r\n\t\tComboField : ({fact}) =>  {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${mapLocale(fact.field_type)}`];\r\n\t\t},\r\n\t\tComboFinisher : ({fact}) => {\r\n\t\t\treturn [`${GW2Text2HTML(fact.text)}: ${mapLocale(fact.finisher_type)}`];\r\n\t\t},\r\n\t\tBuffConversion : ({fact}) => {\r\n\t\t\treturn [`Gain ${mapLocale(fact.target)} Based on a Percentage of ${mapLocale(fact.source)}: ${fact.percent}%`];\r\n\t\t},\r\n\t\tNoData : ({fact}) => {\r\n\t\t\treturn [GW2Text2HTML(fact.text)];\r\n\t\t},\r\n\t\tPrefixedBuff : ({fact, buff}) => {\r\n\t\t\tlet prefix = APICache.storage.skills.get(fact.prefix);\r\n\t\t\tif(!prefix) console.error('[gw2-tooltips] [facts processor] prefix #', fact.prefix, ' is apparently missing in the cache');\r\n\t\t\tprefix = prefix || MissingBuff;\r\n\t\t\ticonSlug = prefix.icon || iconSlug;\r\n\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MissingBuff; // in case we didn't get the buff we wanted from the api\r\n\r\n\t\t\tlet {duration, apply_count, text} = fact;\r\n\r\n\t\t\tconst details : string[] = [];\r\n\t\t\tlet valueMod;\r\n\t\t\t[buffDuration, valueMod] = applyMods(duration, buff, details);\r\n\r\n\t\t\tlet buffDescription = generateBuffDescription(buff, fact, buffDuration, valueMod);\r\n\t\t\tif(buffDescription) {\r\n\t\t\t\tbuffDescription = `: ${buffDescription}`;\r\n\t\t\t}\r\n\r\n\t\t\tconst seconds = buffDuration > 0 ? `(${drawFractional(buffDuration / 1000, config)}s)`: '';\r\n\r\n\t\t\tconst list : (string|HTMLElement)[] = [newElm('div.fact', // class is just for styling\r\n\t\t\tgenerateBuffIcon(buff.icon, apply_count),\r\n\t\t\t\tnewElm('span', fromHTML(`${GW2Text2HTML(text) || buff.name_brief || buff.name} ${seconds}${buffDescription}`))\r\n\t\t\t)];\r\n\t\t\tlist.push(...details);\r\n\r\n\t\t\treturn list;\r\n\t\t},\r\n\t\tPrefixedBuffBrief : ({fact, buff}) => {\r\n\t\t\tlet prefix = APICache.storage.skills.get(fact.prefix)\r\n\t\t\tif(!prefix) console.error('[gw2-tooltips] [facts processor] prefix #', fact.prefix, ' is apparently missing in the cache');\r\n\t\t\tprefix = prefix || MissingBuff;\r\n\t\t\ticonSlug = prefix.icon || iconSlug\r\n\r\n\t\t\tif(!buff) console.error('[gw2-tooltips] [facts processor] buff #', fact.buff, ' is apparently missing in the cache');\r\n\t\t\tbuff = buff || MissingBuff; // in case we didn't get the buff we wanted from the api\r\n\r\n\t\t\tlet node = newElm('div.fact', // class is just for styling\r\n\t\t\t\tnewImg(buff.icon),\r\n\t\t\t\tnewElm('span', `${GW2Text2HTML(fact.text) || buff.name_brief || buff.name}`)\r\n\t\t\t);\r\n\r\n\t\t\treturn [node]\r\n\t\t},\r\n\t\tRange : ({fact: {min, max}}) => {\r\n\t\t\treturn [`Range: ${min ? `${min} - ${max}` : max}`];\r\n\t\t},\r\n\t\tStunBreak : () => {\r\n\t\t\treturn [\"Breaks Stun\"];\r\n\t\t},\r\n\t}\r\n\r\n\tconst buff = APICache.storage.skills.get((fact as API.BuffFact).buff || 0)\r\n\tconst data : HandlerParams = { fact, buff, weaponStrength: weapon_strength }\r\n\tconst [firstLine, ...remainingDetail] = factInflators[fact.type](data as any)\r\n\tconst wrapper = newElm('div.fact')\r\n\tif(fact.requires_trait) {\r\n\t\twrapper.classList.add('gw2-color-traited-fact')\r\n\t}\r\n\r\n\tlet defianceBreak = 0;\r\n\tif(fact.defiance_break) {\r\n\t\tdefianceBreak = fact.defiance_break * (buffDuration || 1000) / 1000;\r\n\t\tconst breakDetail = (buffDuration != undefined && buffDuration != 1000) ? ` (${fact.defiance_break}/s)` : '';\r\n\t\tremainingDetail.push(newElm('span.detail.gw2-color-defiance-fact', `Defiance Break: ${withUpToNDigits(defianceBreak, 2)}${breakDetail}`))\r\n\t}\r\n\r\n\tif(fact.requires_trait) {\r\n\t\t//NOTE(Rennorb): If the trait is manually set on the object then we don't have it cached, so we just use the id if we don't have a name.\r\n\t\tconst trait_names = joinWordList(fact.requires_trait.map(id => `'<span class=\"gw2-color-traited-fact\">${APICache.storage.traits.get(id)?.name || id}</span>'`))\r\n\t\tremainingDetail.unshift(fromHTML(`<span class=\"detail\">${fact.skip_next ? 'overridden' : 'exists'} because of trait${fact.requires_trait.length == 1 ? '' : 's'} ${trait_names}</span>`));\r\n\t}\r\n\r\n\twrapper.append(generateBuffIcon(iconSlug, buffStackSize))\r\n\twrapper.append(newElm('div',\r\n\t\tnewElm('span', typeof firstLine == 'string' && firstLine.includes('<') ? fromHTML(firstLine) : firstLine), //parsing is expensive, don't just always do it\r\n\t\t...remainingDetail.map(d => typeof d == 'string' ? newElm('span.detail', d) : d))\r\n\t\t);\r\n\r\n\treturn { wrapper, defiance_break: defianceBreak }\r\n}\r\n\r\nexport function generateBuffIcon(icon : Parameters<typeof newImg>[0], stackSize = 1) : HTMLElement {\r\n\tconst img = newImg(icon);\r\n\tif(stackSize == 1) {\r\n\t\treturn img;\r\n\t}\r\n\telse {\r\n\t\tconst wrap = newElm('span.buff-ico', img);\r\n\t\twrap.setAttribute('count', String(stackSize));\r\n\t\treturn wrap;\r\n\t}\r\n}\r\n\r\nimport { newElm, newImg, drawFractional, GW2Text2HTML, withUpToNDigits, mapLocale, Uncapitalize, joinWordList, fromHTML } from './TUtilsV2';\r\nimport APICache from './APICache';\r\nimport { ICONS, config, getHealth } from './TooltipsV2';\r\n","export function allUpgradeCounts(contexts : Context[], scope : ScopeElement, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\tconst elements = scope.getElementsByTagName('gw2object');\r\n\tfor(const pair of contexts.entries()) {\r\n\t\tconst elsInCorrectCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) == pair[0]);\r\n\t\tif(elsInCorrectCtx.length)\r\n\t\t\t_upgradeCounts(...pair, elsInCorrectCtx, mode);\r\n\t}\r\n\t//TODO(Rennorb): rethink this or at least make it uniform\r\n\tconst elsWithWrongCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) >= contexts.length);\r\n\tif(elsWithWrongCtx.length) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] Some targets in scope \", scope, \" have the wrong context: \", elsWithWrongCtx);\r\n\t}\r\n}\r\nexport function specificUpgradeCounts(contextIndex : number, targetContext : Context, scope : ScopeElement, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\t_upgradeCounts(contextIndex, targetContext, scope.getElementsByTagName('gw2object'), mode);\r\n}\r\nfunction _upgradeCounts(contextIndex : number, targetContext : Context, elements : Iterable<Element>, mode : CollectMode) {\r\n\tconst counts : Character['upgradeCounts'] = {};\r\n\r\n\tfor(const element of elements) {\r\n\t\tlet id;\r\n\t\tif(element.getAttribute('type') !== 'item' || !(id = +String(element.getAttribute('objid')))) continue;\r\n\r\n\t\tconst item = APICache.storage.items.get(id);\r\n\t\tif(!item || !('subtype' in item) || (!['Rune', 'Infusion'].includes(item.subtype))) continue;\r\n\r\n\t\tlet amountToAdd = 1;\r\n\r\n\t\tif(item.subtype == \"Infusion\") {\r\n\t\t\tif(!(amountToAdd = +String(element.getAttribute('count')))) { // modern version just has the item count as attribute\r\n\r\n\t\t\t\tif(config.legacyCompatibility) {\r\n\t\t\t\t\tamountToAdd = _legacy_getInfusionCount(element)!;\r\n\t\t\t\t\tif(!amountToAdd) continue;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(!amountToAdd) {\r\n\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Could not figure how many infusions to add for sourceElement \", element, \". Will not assume anything and just ignore the stack.\");\r\n\t\t\t\t\t\tcontinue\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(targetContext.gameMode == \"Pvp\" && item.subtype == 'Rune') {\r\n\t\t\tamountToAdd = 6;\r\n\t\t}\r\n\r\n\t\tcounts[item.id] = (counts[item.id] || 0) + amountToAdd;\r\n\t}\r\n\r\n\tswitch(mode) {\r\n\t\tcase CollectMode.IgnoreGlobal: targetContext.character.upgradeCounts = counts; break\r\n\t\tcase CollectMode.Append: targetContext.character.upgradeCounts = Object.assign(targetContext.character.upgradeCounts, counts); break;\r\n\r\n\t\tcase CollectMode.PrioritizeGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign(counts, window.GW2TooltipsContext[contextIndex].character?.upgradeCounts);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign(counts, window.GW2TooltipsContext.character?.upgradeCounts);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.upgradeCounts = counts;\r\n\t\t\t}\r\n\t\t} break\r\n\r\n\t\tcase CollectMode.OverwriteGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign({}, window.GW2TooltipsContext[contextIndex].character?.upgradeCounts, counts);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.upgradeCounts = Object.assign({}, window.GW2TooltipsContext.character?.upgradeCounts, counts);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.upgradeCounts = counts;\r\n\t\t\t}\r\n\t\t} break\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb) @correctness @incomplete: +x to all stats not working right now\r\nexport function allStatSources(contexts : Context[], scope : ScopeElement, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\tconst elements = scope.getElementsByTagName('gw2object');\r\n\tfor(const pair of contexts.entries()) {\r\n\t\tconst elsInCorrectCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) == pair[0]);\r\n\t\tif(elsInCorrectCtx.length)\r\n\t\t\t_statSources(...pair, elsInCorrectCtx, mode);\r\n\t}\r\n\tconst elsWithWrongCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) >= contexts.length);\r\n\tif(elsWithWrongCtx.length) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] Some targets in scope \", scope, \" have the wrong context: \", elsWithWrongCtx);\r\n\t}\r\n}\r\nexport function specificStatSources(contextIndex : number, targetContext : Context, scope : ScopeElement, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\t_statSources(contextIndex, targetContext, scope.getElementsByTagName('gw2object'), mode);\r\n}\r\nfunction _statSources(contextIndex : number, targetContext : Context, elements : Iterable<Element>, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\tconst sources : Context['character']['statSources'] = {\r\n\t\tpower          : [],\r\n\t\ttoughness      : [],\r\n\t\tvitality       : [],\r\n\t\tprecision      : [],\r\n\t\tferocity       : [],\r\n\t\tconditionDmg   : [],\r\n\t\texpertise      : [],\r\n\t\tconcentration  : [],\r\n\t\thealing        : [],\r\n\t\tagonyResistance: [],\r\n\t\tdamage         : [],\r\n\t\tlifeForce      : [],\r\n\t\thealth         : [],\r\n\t\thealEffectiveness: [],\r\n\t\tstun           : [],\r\n\t};\r\n\r\n\t//NOTE(Rennorb): Cant really use the existing upgrade counts since we want to add tiers individually.\r\n\t//TODO(Rennorb): MAybe we can? Maybe we should?\r\n\tlet upgrades = {} as { [k : number] : number };\r\n\r\n\tfor(const element of elements) {\r\n\t\tlet id, type = element.getAttribute('type');\r\n\t\tif(!(id = +String(element.getAttribute('objid')))) continue;\r\n\r\n\t\tlet amountToAdd = 1;\r\n\t\tlet tiersToProcess, item : API.Item | undefined;\r\n\t\tif(type == 'item') {\r\n\t\t\titem = APICache.storage.items.get(id);\r\n\t\t\tif(!item || !('subtype' in item)) continue;\r\n\r\n\t\t\tif(item.type === 'UpgradeComponent' || item.type === 'Consumable') {\r\n\t\t\t\tif(item.subtype === 'Rune' && item.flags.includes('Pvp')) {\r\n\t\t\t\t\tamountToAdd = 6;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//NOTE(Rennorb): We count additional runes, but ignore those over the sensible amount.\r\n\t\t\t\t//NOTE(Rennorb): For pvp runes we get the wrong tier number here, it doesn't matter tho because we need to treat it differently anyways.\r\n\t\t\t\t// Since pvp builds only have one rune we need to add all tiers from just one item.\r\n\t\t\t\t// We still want to increase the upgrade count to do the warnings if we find more than expected.\r\n\t\t\t\tconst tierNumber = upgrades[item.id] = (upgrades[item.id] || 0) + amountToAdd;\r\n\r\n\t\t\t\tif(item.subtype === 'Rune') {\r\n\t\t\t\t\tif(tierNumber > 6) {\r\n\t\t\t\t\t\t//NOTE(Rennorb): Only complain if we are manually counting runes.\r\n\t\t\t\t\t\t//TODO(Rennorb) @correctness: Is this the right way to do it? should we just complain when runes are specified but we find one that isn't?\r\n\t\t\t\t\t\tif(!targetContext.character.upgradeCounts[item.id])\r\n\t\t\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Found more than 6 runes of the same type. Here is the 7th rune element: \", element);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t//NOTE(Rennorb): Since pvp builds only have one rune we need to add all tiers from just one item.\r\n\t\t\t\t\tif(item.flags.includes('Pvp'))\r\n\t\t\t\t\t\ttiersToProcess = item.tiers;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\ttiersToProcess = [item.tiers[tierNumber - 1]];\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif(item.subtype == 'Infusion' || item.subtype == 'Enrichment') {\r\n\t\t\t\t\t\tif(!(amountToAdd = +String(element.getAttribute('count')))) { // modern version just has the item count as attribute\r\n\r\n\t\t\t\t\t\t\tif(config.legacyCompatibility) {\r\n\t\t\t\t\t\t\t\tamountToAdd = _legacy_getInfusionCount(element)!;\r\n\t\t\t\t\t\t\t\tif(!amountToAdd) continue;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif(!amountToAdd) {\r\n\t\t\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Could not figure how many infusions to add for sourceElement \", element, \". Will not assume anything and just ignore the stack.\");\r\n\t\t\t\t\t\t\t\t\tcontinue\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if(item.subtype === 'Sigil' && tierNumber > 1) {\r\n\t\t\t\t\t\t//NOTE(Rennorb): We only process one sigil, since sigils are unique, but we start complaining at the third identical one since there might be the same sigil twice for different sets.\r\n\t\t\t\t\t\t//TODO(Rennorb) @correctness: how to handle asymmetric sets? Right now we would assume all unique sigils are active at once, so if you do [A, B] [B, C] then A, B, C would be considered active.\r\n\t\t\t\t\t\tif(tierNumber > 2)\r\n\t\t\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Found more than 2 sigils of the same type. Here is the 3th sigil element: \", element);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\ttiersToProcess = item.tiers; //should only ever be one anyways\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if(type == 'pvp/amulet') {\r\n\t\t\titem = APICache.storage['pvp/amulets'].get(id);\r\n\t\t\tif(!item) continue;\r\n\t\t\t\r\n\t\t\ttiersToProcess = item.tiers; //should only ever be one anyways\r\n\t\t}\r\n\r\n\t\tif(tiersToProcess) for(const tier of tiersToProcess) {\r\n\t\t\tif(tier.modifiers) for(const mod of tier.modifiers!) {\r\n\t\t\t\tif(!mod.target_attribute_or_buff || (mod.mode && mod.mode !== targetContext.gameMode) || (mod.trait_req && !targetContext.character.traits.includes(mod.trait_req))) continue; //TODO(Rennorb): probably extract this into a fn similar to the other resolver\r\n\r\n\t\t\t\t(typeof mod.target_attribute_or_buff !== 'number'\r\n\t\t\t\t\t? sources[Uncapitalize(mod.target_attribute_or_buff)] //TODO(Rennorb) @cleanup: another reason to fix naming\r\n\t\t\t\t\t: (sources[mod.target_attribute_or_buff] || (sources[mod.target_attribute_or_buff] = []))\r\n\t\t\t\t).push({ modifier: mod, source: item!.name, count: amountToAdd }) //TODO(Rennorb): item name resolution\r\n\r\n\t\t\t\t//@debug\r\n\t\t\t\t//TODO(Rennorb) @bug: see NaN @ rune of the monk\r\n\t\t\t\tif(typeof mod.target_attribute_or_buff === 'number') {\r\n\t\t\t\t\tconst buff = APICache.storage.skills.get(mod.target_attribute_or_buff);\r\n\t\t\t\t\tif(mod.flags.includes('FormatPercent'))\r\n\t\t\t\t\t\tconsole.log(`[gw2-tooltips] [collect] [ctx #${contextIndex}] [@unstable] ${item!.name}: Percent ${buff?.name} ${mod.base_amount > 0 ? '+' : ''}${mod.base_amount}%`);\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.log(`[gw2-tooltips] [collect] [ctx #${contextIndex}] [@unstable] ${item!.name}: Flat ${buff?.name} ${mod.base_amount > 0 ? '+' : ''}${mod.base_amount}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//TODO(Rennorb) @cleanup: move this out?\r\n\tswitch(mode) {\r\n\t\tcase CollectMode.IgnoreGlobal: targetContext.character.statSources = sources; break\r\n\t\tcase CollectMode.Append: targetContext.character.statSources = Object.assign(targetContext.character.statSources, sources); break;\r\n\r\n\t\tcase CollectMode.PrioritizeGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign(sources, window.GW2TooltipsContext[contextIndex].character?.statSources);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign(sources, window.GW2TooltipsContext.character?.statSources);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.statSources = sources;\r\n\t\t\t}\r\n\t\t} break\r\n\r\n\t\tcase CollectMode.OverwriteGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign({}, window.GW2TooltipsContext[contextIndex].character?.statSources, sources);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\ttargetContext.character.statSources = Object.assign({}, window.GW2TooltipsContext.character?.statSources, sources);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.statSources = sources;\r\n\t\t\t}\r\n\t\t} break\r\n\t}\r\n\r\n\r\n\t// now we set the new stats\r\n\t{\r\n\t\tlet baseStats;\r\n\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\tbaseStats = Object.assign({}, window.GW2TooltipsContext[contextIndex].character?.stats, DEFAULT_CONTEXT.character.stats);\r\n\t\t}\r\n\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\tbaseStats = Object.assign({}, window.GW2TooltipsContext.character?.stats, DEFAULT_CONTEXT.character.stats);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tbaseStats = Object.assign({}, DEFAULT_CONTEXT.character.stats);\r\n\t\t}\r\n\r\n\t\ttargetContext.character.stats = baseStats;\r\n\r\n\t\t//TODO(Rennorb) @correctnes: 'for every x healing power' is not treated correctly by this approach.\r\n\t\t//NOTE(Rennorb): Force the key to be keyof stats. Ts dost understand the guard here\r\n\t\tfor(const [attrib, sources] of Object.entries(targetContext.character.statSources) as [keyof Stats, StatSource[]][]) {\r\n\t\t\tif(!isNaN(+attrib)) continue; //discard direct boon mods\r\n\r\n\t\t\tfor(const { modifier, source, count } of sources.filter(s => !s.modifier.flags.includes('FormatPercent'))) {\r\n\t\t\t\tconst mod = calculateModifier(modifier, targetContext.character) * count\r\n\t\t\t\ttargetContext.character.stats[attrib] += mod;\r\n\t\t\t\tconsole.log(`[gw2-tooltips] [collect] [ctx #${contextIndex}] ${source}${count > 1 ? (' x '+count) : ''}: Flat ${attrib} ${mod > 0 ? '+' : ''}${mod} => ${targetContext.character.stats[attrib]}`)\r\n\t\t\t}\r\n\t\t\tfor(const { modifier, source, count } of sources.filter(s => s.modifier.flags.includes('FormatPercent'))) {\r\n\t\t\t\tconst mod = calculateModifier(modifier, targetContext.character); //TODO(Rennorb) @correctness: fractional percent\r\n\t\t\t\tconst value = targetContext.character.stats[attrib] * mod / 100 * count; //TODO(Rennorb) @correctness\r\n\t\t\t\ttargetContext.character.stats[attrib] += value;\r\n\t\t\t\tconsole.log(`[gw2-tooltips] [collect] [ctx #${contextIndex}] ${source}${count > 1 ? (' x '+count) : ''}: Percent ${attrib} ${mod > 0 ? '+' : ''}${mod}% (${value}) => ${targetContext.character.stats[attrib]}`)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction _legacy_getInfusionCount(element : Element) : number | undefined {\r\n\t//NOTE(Rennorb): unfortunately this is a bit complicated as the count is next to the actual object, but within a stacked wrapper. so its\r\n\t// <gw2obj />\r\n\t// ... repeated for multiple infusions\r\n\t// <div.gw2-build-equipment-info>\r\n\t//   <span.item-name.noembed><strong.amount>{amount}x</strong>{name}</span>\r\n\t//   ... repeated for multiple infusions\r\n\tconst ownIndex = Array.prototype.indexOf.call(element.parentElement!.children, element);\r\n\tconst amountEl = element.parentElement!.getElementsByClassName('amount')[ownIndex];\r\n\tif(!amountEl){\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] `legacyCompatibility` is active, but no amount element for infusion \", element, \" could be found. Will not assume anything and just ignore the stack.\");\r\n\t\treturn;\r\n\t}\r\n\tconst amountToAdd = +String(amountEl.textContent?.match(/\\d+/)?.[0]);\r\n\tif(!amountToAdd) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] [legacyCompatibility] Amount element \", amountEl, \" for infusion element \", element, \" did not contain any readable amount. Will not assume anything and just ignore the stack.\");\r\n\t\treturn;\r\n\t}\r\n\tif(amountToAdd < 1 || amountToAdd > 20) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] [legacyCompatibility] Amount element \", amountEl, \" for infusion element \", element, \" did got interpreted as x\", amountToAdd, \" which is outside of the range of sensible values (amount in [1...20]). Will not assume anything and just ignore the stack.\");\r\n\t\treturn;\r\n\t}\r\n\r\n\treturn amountToAdd;\r\n}\r\n\r\nexport function allTraits(contexts : Context[], scope : ScopeElement, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\tconst elements = scope.querySelectorAll('gw2object[type=specialization]:not(.gw2objectembed)');\r\n\tfor(const pair of contexts.entries()) {\r\n\t\tconst elsInCorrectCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) == pair[0]);\r\n\t\tif(elsInCorrectCtx.length)\r\n\t\t\t_traits(...pair, elsInCorrectCtx, mode);\r\n\t}\r\n\tconst elsWithWrongCtx = Array.from(elements).filter(e => (+String(e.getAttribute('contextSet')) || 0) >= contexts.length);\r\n\tif(elsWithWrongCtx.length) {\r\n\t\tconsole.warn(\"[gw2-tooltips] [collect] Some targets in scope \", scope, \" have the wrong context: \", elsWithWrongCtx);\r\n\t}\r\n}\r\nexport function specificTraits(contextIndex : number, targetContext : Context, scope : ScopeElement, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\t_traits(contextIndex, targetContext, scope.getElementsByTagName('gw2object'), mode);\r\n}\r\nfunction _traits(contextIndex : number, targetContext : Context, elements : Iterable<Element>, mode : CollectMode = CollectMode.PrioritizeGlobal) {\r\n\tconst traits : number[] = [];\r\n\tfor(const specialization of elements) {\r\n\t\tconst selectedPositions = String(specialization.getAttribute('selected_traits')).split(',').map(i => +i).filter(i => !isNaN(i) && 0 <= i && i <= 2);\r\n\t\tif(selectedPositions.length != 3) {\r\n\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Specialization object \", specialization, \" does not have its 'selected_traits' (properly) set. Add the attribute as `selected_traits=\\\"0,2,1\\\"` where the numbers are 0-2 indicating top, middle or bottom selection. Will not assume anything and just ignore the element.\");\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tfor(const [x, y] of selectedPositions.entries()) {\r\n\t\t\t// The expected structure is:\r\n\t\t\t// <spec>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t// </>\r\n\t\t\t{\r\n\t\t\t\tconst traitEl = specialization.children[1 + x * 2].children[y];\r\n\t\t\t\tlet id;\r\n\t\t\t\tif(!traitEl || !(id = +String(traitEl.getAttribute('objid')))) {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Trait object \", traitEl, \" is selected but does not exist or does not have an objid set. Add the attribute as `objid=\\\"1234\\\"`. Will not assume anything and just ignore the element.\");\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\ttraits.push(id);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//now abuse the iterator to also add minors\r\n\t\t\t{\r\n\t\t\t\tconst traitEl = specialization.children[x * 2];\r\n\t\t\t\tlet id;\r\n\t\t\t\tif(!(id = +String(traitEl.getAttribute('objid')))) {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] Minor trait object \", traitEl, \" does not have an objid set. Add the attribute as `objid=\\\"1234\\\"`. Will not assume anything and just ignore the element.\");\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\ttraits.push(id);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//TODO(Rennorb) @cleanup: move this out?\r\n\tswitch(mode) {\r\n\t\tcase CollectMode.IgnoreGlobal:\r\n\t\t\t// It doest actually make sense to 'overwrite' here, so its just the same as IgnoreGlobal.\r\n\t\tcase CollectMode.OverwriteGlobal: targetContext.character.traits = traits; break\r\n\r\n\t\t// It doest actually make sense to 'append' here, so its just the same as PrioritizeGlobal.\r\n\t\tcase CollectMode.Append:\r\n\t\tcase CollectMode.PrioritizeGlobal: {\r\n\t\t\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\t\t\tconst set = new Set(window.GW2TooltipsContext[contextIndex].character?.traits);\r\n\t\t\t\ttraits.forEach(t => set.add(t));\r\n\t\t\t\ttargetContext.character.traits = Array.from(set);\r\n\t\t\t}\r\n\t\t\telse if(window.GW2TooltipsContext) {\r\n\t\t\t\tconst set = new Set(window.GW2TooltipsContext.character?.traits);\r\n\t\t\t\ttraits.forEach(t => set.add(t));\r\n\t\t\t\ttargetContext.character.traits = Array.from(set);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttargetContext.character.traits = traits;\r\n\t\t\t}\r\n\t\t} break\r\n\t}\r\n}\r\n\r\nexport function traitEffects(contexts : Context[]) {\r\n\tfor(const context of contexts) {\r\n\t\tfor(const traitId of context.character.traits) {\r\n\t\t\tconst trait = APICache.storage.traits.get(traitId);\r\n\t\t\tif(!trait) {\r\n\t\t\t\tconsole.error(`[gw2-tooltips] [collect] Trait #${traitId} is apparently missing in the cache.`);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tconst addModifiers = (modifiers : API.Modifier[]) => {\r\n\t\t\t\tfor(const mod of modifiers) {\r\n\t\t\t\t\tif(!mod.target_attribute_or_buff || (mod.mode && mod.mode !== context.gameMode) || (mod.trait_req && !context.character.traits.includes(mod.trait_req))) continue; //TODO(Rennorb): probably extract this into a fn similar to the other resolver\r\n\r\n\t\t\t\t\t(typeof mod.target_attribute_or_buff === 'number'\r\n\t\t\t\t\t\t? (context.character.statSources[mod.target_attribute_or_buff] || (context.character.statSources[mod.target_attribute_or_buff] = []))\r\n\t\t\t\t\t\t: context.character.statSources[Uncapitalize(mod.target_attribute_or_buff)]\r\n\t\t\t\t\t).push({source: `trait '<span class=\"gw2-color-traited-fact\">${trait.name}</span>'`, modifier: mod, count: 1});\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tif(trait.modifiers) addModifiers(trait.modifiers);\r\n\r\n\t\t\tconst contextBoundInfo = resolveTraitsAndOverrides(trait, context);\r\n\t\t\tif(contextBoundInfo.facts) for(const fact of contextBoundInfo.facts) {\r\n\t\t\t\tif(!('buff' in fact)) continue;\r\n\t\t\t\t\r\n\t\t\t\tconst buff = APICache.storage.skills.get(fact.buff);\r\n\t\t\t\tif(!buff) {\r\n\t\t\t\t\tconsole.error(`[gw2-tooltips] [collect] Trait #${fact.buff} is apparently missing in the cache.`);\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(buff.modifiers) addModifiers(buff.modifiers);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst enum CollectMode {\r\n\tIgnoreGlobal,\r\n\tPrioritizeGlobal,\r\n\tOverwriteGlobal,\r\n\tAppend,\r\n}\r\n\r\nimport { Uncapitalize } from \"./TUtilsV2\";\r\nimport APICache from \"./APICache\";\r\nimport { resolveTraitsAndOverrides, DEFAULT_CONTEXT, config } from './TooltipsV2';\r\nimport { calculateModifier } from \"./FactsProcessor\";\r\n","export function inflateGenericIcon(gw2Object : HTMLElement, data : { name : string, icon? : Parameters<typeof newImg>[0] }) {\r\n\tif(gw2Object.childElementCount > 0) return; // most scenarios will have the server prefill objects as best as it can.\r\n\r\n\tconst wikiLink = newElm('a', newImg(data.icon, undefined, data.name));\r\n\twikiLink.href = 'https://wiki-en.guildwars2.com/wiki/Special:Search/' + GW2Text2HTML(data.name).replaceAll(/\\[.*?\\]/g, ''); //remove plural forms ([s] and similar)\r\n\twikiLink.target = '_blank';\r\n\tif(gw2Object.classList.contains('gw2objectembed') && !gw2Object.classList.contains('icononly')) {\r\n\t\t//TODO(Rennorb) @correctness: this should probably take into account the plural form\r\n\t\tconst cleanName = GW2Text2HTML(data.name).replaceAll(/\\[.*?\\]/g, ''); //remove plural forms ([s] and similar)\r\n\t\twikiLink.append(cleanName);\r\n\t}\r\n\tgw2Object.append(wikiLink);\r\n}\r\n\r\nexport function inflateSkill(gw2Object : HTMLElement, skill : API.Skill) {\r\n\tconst contextSet = +String(gw2Object.getAttribute('contextSet')) || 0;\r\n\tconst context_ = specializeContextFromInlineAttribs(context[contextSet], gw2Object);\r\n\r\n\t//NOTE(Rennorb): doing this here might not be the best idea, as this wil prevent us form hot swapping traits.\r\n\t// The issue is that this is the place where the icon gets selected and inflated, so its somewhat required to change the skill before this point.\r\n\t// Maybe this is still the best place to do this and for cases were we need hot swapping (e.g. build editor) we just have to manually re-process skills after swapping traits.\r\n\t// Maybe we should move the original id to another attribute for savekeeping so we can revert it later on if we need to?\r\n\tif(config.adjustTraitedSkillIds) {\r\n\t\tconst replacementSkill = findTraitedOverride(skill, context_);\r\n\t\tif(replacementSkill) {\r\n\t\t\tgw2Object.setAttribute('objid', String(replacementSkill.id));\r\n\t\t\tskill = replacementSkill;\r\n\t\t}\r\n\t}\r\n\t\r\n\tinflateGenericIcon(gw2Object, skill);\r\n}\r\n\r\nexport function inflateItem(gw2Object : HTMLElement, item : API.Item) {\r\n\tif(gw2Object.childElementCount > 0) return; // most scenarios will have the server prefill objects as best as it can.\r\n\r\n\tconst stackSize = +String(gw2Object.getAttribute('count')) || 1;\r\n\tconst context_ = context[+String(gw2Object.getAttribute('contextSet')) || 0];\r\n\r\n\tconst wikiLink = newElm('a', newImg(item.icon, undefined, item.name));\r\n\twikiLink.href = 'https://wiki-en.guildwars2.com/wiki/Special:Search/' + GW2Text2HTML(item.name).replaceAll(/\\[.*?\\]/g, ''); //remove plural forms ([s] and similar)\r\n\twikiLink.target = '_blank';\r\n\tif(gw2Object.classList.contains('gw2objectembed')) wikiLink.append(formatItemName(item, context_, undefined, undefined, stackSize));\r\n\tgw2Object.append(wikiLink);\r\n}\r\n\r\nexport function inflateSpecialization(gw2Object : HTMLElement, spec: API.Specialization) {\r\n\tif(gw2Object.classList.contains('gw2objectembed')) {\r\n\t\tinflateGenericIcon(gw2Object, spec);\r\n\t}\r\n\telse {\r\n\t\tgw2Object.style.backgroundImage = `url(${spec.background})`;\r\n\t\tgw2Object.dataset.label = spec.name;\r\n\r\n\t\t//TODO(Rennorb) @cleanup @compat: this is kinda dumb. we could just mark the selected traits, as we need to do that anyways for css. \r\n\t\t// Issue is backwards compat so yea, might not be able to get rid of it completely.\r\n\t\tconst selectedPositions = String(gw2Object.getAttribute('selected_traits')).split(',').map(i => +i).filter(i => !isNaN(i) && 0 <= i && i <= 2);\r\n\t\tif(selectedPositions.length != 3) {\r\n\t\t\tconsole.warn(\"[gw2-tooltips] [inflator] Specialization object \", gw2Object, \" does not have its 'selected_traits' (properly) set. Add the attribute as `selected_traits=\\\"0,2,1\\\"` where the numbers are 0-2 indicating top, middle or bottom selection.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tfor(const [x, y] of selectedPositions.entries()) {\r\n\t\t\t// The expected structure is:\r\n\t\t\t// <spec>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t//  <minor />\r\n\t\t\t//  <wrapper><major /><major /><major /></>\r\n\t\t\t// </>\r\n\t\t\tconst column = gw2Object.children[1 + x * 2];\r\n\t\t\tif(!column) {\r\n\t\t\t\tconsole.warn(\"[gw2-tooltips] [inflator] Cannot mark selected trait object in column #\", x, \" for specialization object \", gw2Object,  \" because the column doesn't seem to exist. Either mark the specialization object as inline or add the missing column.\");\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tfor(const [i, traitEl] of Array.prototype.entries.call(column.children)) {\r\n\t\t\t\ttraitEl.classList.toggle('trait_unselected', i !== y);\r\n\t\t\t}\r\n\t\t\t//TODO(Rennorb): can probably merge trait collection into here since its basically the same code\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function _legacy_transformEffectToSkillObject(gw2Object : HTMLElement, error_store : Set<string>) : number {\r\n\tconst name = String(gw2Object.getAttribute('objId'));\r\n\tlet id = ({\r\n\t\tblight                  : 62653,\r\n\t\tbloodstone_blessed      : 34917,\r\n\t\tblue_pylon_power        : 31317, //maybe wrong (vale guardian)\r\n\t\tchill                   : 722,\r\n\t\tquickness               : 1187,\r\n\t\tchilled                 : 722,\r\n\t\tfear                    : 896,\r\n\t\talacrity                : 30328,\r\n\t\tprotection              : 717,\r\n\t\tvigor                   : 726,\r\n\t\tbarrier                 : 0, //TODO\r\n\t\tfury                    : 725,\r\n\t\tstability               : 1122,\r\n\t\tstunbreak               : 0, //TODO\r\n\t\taegis                   : 743,\r\n\t\tmight                   : 740,\r\n\t\tregeneration            : 16538,\r\n\t\timmobilize              : 22501,\r\n\t\tslow                    : 26766,\r\n\t\tresistance              : 26980,\r\n\t\tchampion_of_the_legions : 20845, //maybe wrong (rock fest thing?)\r\n\t\tcompromised             : 35096,\r\n\t\tcrowd_favor             : 36173, //maybe wrong (marionette)\r\n\t\tcurse_of_frailty        : 53723, //maybe wrong (pirate fractal)\r\n\t\tdark_aura               : 39978,\r\n\t\tdebilitated             : 0, //TODO ko\r\n\t\tdebilitating_void       : 0, //TODO ankah\r\n\t\tdefense_up              : 28482,\r\n\t\tderangement             : 34965,\r\n\t\telemental_empowerment   : 62733,\r\n\t\tempowering_auras        : 62939,\r\n\t\tequalization_matrix     : 66586, //maybe wrong (ko)\r\n\t\texposed                 : 28778, //maybe wrong\r\n\t\texpose_weakness         : 26660, //maybe wrong\r\n\t\textreme_vulnerability   : 65662,\r\n\t\tfixated                 : 47434, //maybe wrong\r\n\t\t//gems_big                : ,\r\n\t\t//gold_gold_big           : ,\r\n\t\tgrowing_rage_ashym      : 3362, //maybe wrong (urban battleground)\r\n\t\t//h                       : ,\r\n\t\tignite                  : 16259,\r\n\t\tintervention            : 35061,\r\n\t\tinvulnerability         : 56227,\r\n\t\tnecrosis                : 47414,\r\n\t\tnot_sticking_together   : 54378,\r\n\t\tnova                    : 39193, //there is also the upgraded version with aegis\r\n\t\tooze_pheromone          : 21538,\r\n\t\tphoton_saturation       : 0, //TODO ah cm\r\n\t\tpositive_flow           : 66665,\r\n\t\tpower_of_the_void       : 0, //TODO xjj\r\n\t\t//q                       : ,\r\n\t\treinforced_armor        : 9283,\r\n\t\trelentless_fire         : 62805,\r\n\t\tretaliation_ashym       : 24646, //maybe wrong\r\n\t\tsentinel_retribution    : 16350,\r\n\t\tshattering_ice          : 62909,\r\n\t\tshell_shocked           : 33361,\r\n\t\tspectral_darkness       : 31498,\r\n\t\tsticking_together       : 54604,\r\n\t\tsynchronized_vitality   : 63840, //maybe wrong(ko)\r\n\t\tunnatural_signet        : 38224,\r\n\t\tuse_soul_binder         : 55630,\r\n\t\tvoid_empowerment        : 68083,\r\n\t\txeras_embrace           : 34979,\r\n\t} as any)[name]\r\n\r\n\tif(!id) {\r\n\t\t//NOTE(Rennorb): these don't actually exist and need to be synthesized.\r\n\t\tconst hardCoded = ({\r\n\t\t\tbarrier: {\r\n\t\t\t\tid: 1,\r\n\t\t\t\tname: 'Barrier',\r\n\t\t\t\ticon: ICONS.BARRIER,\r\n\t\t\t\tdescription: \"Creates a health barrier that takes damage prior to the health bar. Barrier disappears 5s after being applied. Applying a barrier while one is already active will add to it, but the previously-existing barrier will still disappear 5s after it was originally applied. The amount of barrier generated is based on the source's healing power, and is capped at 50% of the recipient's maximum health.\",\r\n\t\t\t\tdescription_brief: \"Creates a health barrier that takes damage prior to the health bar.\",\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t},\r\n\t\t\tstunbreak: {\r\n\t\t\t\tid: 2,\r\n\t\t\t\tname: 'Stun Break',\r\n\t\t\t\tdescription: 'Cancel control effects such as stuns.',\r\n\t\t\t\ticon: ICONS.STUN_BREAK,\r\n\t\t\t\tcategories: [], palettes: [],\r\n\t\t\t}\r\n\t\t} as {[k : string] : API.Skill})[name];\r\n\r\n\t\tif(hardCoded) {\r\n\t\t\tid = hardCoded.id;\r\n\t\t\t//TODO(Rennorb) @cleanup: could probably move this out\r\n\t\t\tAPICache.storage.skills.set(id, hardCoded);\r\n\t\t}\r\n\t}\r\n\r\n\tif(id) {\r\n\t\tgw2Object.setAttribute('type', 'skill');\r\n\t\tgw2Object.setAttribute('objId', String(id));\r\n\t\treturn id;\r\n\t}\r\n\telse {\r\n\t\tgw2Object.innerText = name;\r\n\t\tgw2Object.title = `Failed to translate effect '${name}'.`;\r\n\t\tgw2Object.style.cursor = \"help\";\r\n\t\tgw2Object.classList.add('error');\r\n\t\terror_store.add(name);\r\n\t\treturn 0;\r\n\t}\r\n}\r\n\r\nexport function inferItemUpgrades(wrappers : Iterable<Element>) {\r\n\tconst remainingInfusionsByContext = context.map(ctx => {\r\n\t\tconst counts : Character['upgradeCounts'] = {};\r\n\t\tfor(const [id, c] of Object.entries(ctx.character.upgradeCounts)) {\r\n\t\t\tlet item;\r\n\t\t\tif((item = APICache.storage.items.get(+id)) && 'subtype' in item && item.subtype == 'Infusion')\r\n\t\t\t\tcounts[+id] = c;\r\n\t\t}\r\n\t\treturn counts;\r\n\t});\r\n\tconst enrichmentByContext = context.map(ctx => {\r\n\t\tfor(const [id, c] of Object.entries(ctx.character.upgradeCounts)) {\r\n\t\t\tlet item;\r\n\t\t\tif((item = APICache.storage.items.get(+id)) && 'subtype' in item && item.subtype == 'Enrichment')\r\n\t\t\t\treturn id;\r\n\t\t}\r\n\t})\r\n\r\n\tfor(const wrapper of wrappers) {\r\n\tif(wrapper.childElementCount < 2) continue;\r\n\t\tconst [itemEl, ...upgradeEls] = wrapper.children;\r\n\t\tif(itemEl.getAttribute('type') !== 'item') continue;\r\n\r\n\t\tconst itemCtx = +String(itemEl.getAttribute('contextSet')) || 0 ;\r\n\r\n\t\tconst upgradeIds = upgradeEls.filter(u =>\r\n\t\t\t\tu.getAttribute('type') === 'item' && u.getAttribute('objid')\r\n\t\t\t\t&& (+String(itemEl.getAttribute('contextSet')) || 0) === itemCtx\r\n\t\t\t)\r\n\t\t\t.map(u => u.getAttribute('objid'));\r\n\r\n\t\t{\r\n\t\t\tlet id, item;\r\n\t\t\tif((id = +String(itemEl.getAttribute('objid'))) && (item = APICache.storage.items.get(id)) && 'slots' in item) {\r\n\t\t\t\tfor(const slot of item.slots) {\r\n\t\t\t\t\tif(slot == 'Infusion') {\r\n\t\t\t\t\t\tconst remainingInfusions = remainingInfusionsByContext[itemCtx] as { [k : string] : number };\r\n\t\t\t\t\t\tfor(const infusionId of Object.keys(remainingInfusions)) {\r\n\t\t\t\t\t\t\tupgradeIds.push(infusionId);\r\n\t\t\t\t\t\t\tif(--remainingInfusions[infusionId] < 1) {\r\n\t\t\t\t\t\t\t\tdelete remainingInfusions[infusionId];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if(slot == 'Enrichment') {\r\n\t\t\t\t\t\tconst enrichment = enrichmentByContext[itemCtx];\r\n\t\t\t\t\t\tif(enrichment) upgradeIds.push(enrichment);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst attrString = upgradeIds.join(',');\r\n\t\tif(attrString) itemEl.setAttribute('slotted', attrString);\r\n\t}\r\n}\r\n\r\nimport APICache from \"./APICache\";\r\nimport { GW2Text2HTML, newElm, newImg } from \"./TUtilsV2\";\r\nimport { ICONS, config, context, findTraitedOverride, formatItemName, specializeContextFromInlineAttribs } from \"./TooltipsV2\";\r\n","//TODO(Rennorb) @issues:\r\n//TODO(Rennorb): Provide a clean way to construct custom tooltips. Currently with the old version we manipulate the cache before the hook function gets called, which really isn't the the best.\r\n//TODO(Rennorb): Option to show whole skill-chain (maybe on button hold)?\r\n//TODO(Rennorb): Stop using these jank custom tags. There is no reason to do so and its technically not legal per html spec.\r\n//TODO(Rennorb) @fixme: impale: the impale buff doesn't have a name, only shows duration\r\n//TODO(Rennorb): Figure out how to handle boon descriptions. Have a toggle between 'realistic as in game' and 'full information'\r\n//TODO(Rennorb): Link minion skills to minion summon skill.\r\n//TODO(Rennorb): specs, pets, and amulets endpoints.\r\n//TODO(Rennorb): Defiance break on single effect tooltips.\r\n//TODO(Rennorb): Change anything percent related to use fractions instead of integers (0.2 instead of 20).\r\n// The only thing this is good for is to make drawing the facts easier. Since we do quite a few calculations this swap would reduce conversions quite a bit.\r\n//TODO(Rennorb): Note the specialization a trait belongs to on the trait tooltip (probably instead of the slot).\r\n//TODO(Rennorb) @correctness: Split up incoming / outgoing effects. Mostly relevant for healing.\r\n//TODO(Rennorb) @correctness: Change the lookup to first try to figure out the palette and then go from there. this is the way to move forward as this is the future-proof way to list skills.\r\n//TODO(Rennorb) @correctness: implement processing for trait / skill buffs to properly show certain flip skills and chains aswell as properly do trait overrides for skills\r\n//TODO(Rennorb) @fixme: crash on pvp amulet hover\r\n\r\n//TODO(Rennorb): (maybe) add specific hs output command that produces files outside of the repo to preserve them inside of the parent.\r\n\r\nlet tooltip : HTMLElement\r\nlet lastTooltipTarget : HTMLElement | undefined\r\n\r\nlet cyclePos    : number = 0\r\nlet lastMouseX  : number\r\nlet lastMouseY  : number\r\n\r\n//TODO(Rennorb) @rename\r\nexport const context : Context[] = []; //@debug\r\nexport let config    : Config = null!;\r\n\r\n//TODO(Rennorb) @cleanup: get rid of this\r\nfunction _constructor() {\r\n\t//TODO(Rennorb): Validate config. there are a few places this partially happens but its hard to keep track. Should just happen in one place.\r\n\tif(window.GW2TooltipsContext instanceof Array) {\r\n\t\tfor(const partialContext of window.GW2TooltipsContext)\r\n\t\t\tcontext.push(createCompleteContext(partialContext))\r\n\t}\r\n\telse if(window.GW2TooltipsContext) {\r\n\t\tcontext.push(createCompleteContext(window.GW2TooltipsContext))\r\n\t}\r\n\telse{\r\n\t\tcontext.push(createCompleteContext({}))\r\n\t}\r\n\r\n\tconfig = Object.assign({}, DEFAULT_CONFIG, window.GW2TooltipsConfig)\r\n\tif(config.apiImpl) APICache.apiImpl = config.apiImpl(APIs);\r\n\r\n\ttooltip = newElm('div.tooltipWrapper')\r\n\ttooltip.style.display = 'none';\r\n\tdocument.body.appendChild(tooltip)\r\n\r\n\tconst isMobile = /android|webos|iphone|ipad|ipod|blackberry|bb|playbook|mobile|windows phone|kindle|silk|opera mini/.test(navigator.userAgent.toLowerCase())\r\n\tdocument.addEventListener('mousemove', event => {\r\n\t\tif(isMobile && (Math.abs(event.pageX - lastMouseX) + Math.abs(event.pageY - lastMouseY) > 20)) {\r\n\t\t\ttooltip.style.display = 'none';\r\n\t\t}\r\n\r\n\t\tlastMouseX = event.pageX\r\n\t\tlastMouseY = event.pageY\r\n\r\n\t\tif(tooltip.style.display != 'none')\r\n\t\t\tpositionTooltip()\r\n\t})\r\n\tdocument.addEventListener('contextmenu', event => {\r\n\t\tconst node = findSelfOrParent(event.target as Element, 'gw2object') as HTMLElement;\r\n\t\tif(!node) return;\r\n\r\n\t\t//NOTE(Rennorb): the style check is to prevent an initial cycle on mobile\r\n\t\tif(node.classList.contains('cycler') && tooltip.style.display != 'none') {\r\n\t\t\tevent.preventDefault()\r\n\r\n\t\t\tcyclePos = (cyclePos + 1) % tooltip.childElementCount\r\n\t\t\tdisplayCorrectChainTooltip(Array.from(tooltip.children as HTMLCollectionOf<HTMLElement>), cyclePos)\r\n\t\t\tpositionTooltip()\r\n\t\t}\r\n\t\tif(isMobile && tooltip.style.display == 'none') {\r\n\t\t\tevent.preventDefault()\r\n\t\t\tshowTooltipFor(node);\r\n\t\t\tpositionTooltip()\r\n\t\t}\r\n\t})\r\n\r\n\t//TODO(Rennorb): this sint very clean,  would like a better solution tbh\r\n\tlet touch : Touch;\r\n\tconst scrollHandler = (event : WheelEvent | TouchEvent | { detail : number, preventDefault: VoidFunction }) => {\r\n\t\tif(tooltip.style.display == 'none') return;\r\n\t\tconst activeTT = tooltip.children[cyclePos];\r\n\t\tif(activeTT.scrollHeight == activeTT.clientHeight) return;\r\n\r\n\t\tevent.preventDefault()\r\n\t\tconst deltaY = (event as WheelEvent).deltaY || event.detail || (event as TouchEvent).touches[0].clientY - touch.clientY;\r\n\t\tactiveTT.scrollBy(0, deltaY);\r\n\t}\r\n\tconst passive = 'onwheel' in window ? { passive: false } : false;\r\n\t\r\n\twindow.addEventListener('DOMMouseScroll', scrollHandler as any, false); // older FF\r\n\twindow.addEventListener('wheel', scrollHandler, passive)\r\n\twindow.addEventListener('touchstart', event => {\r\n\t\ttouch = event.touches[0];\r\n\t})\r\n\twindow.addEventListener('touchmove', scrollHandler, passive)\r\n\r\n\t//TODO(Rennorb) @ui\r\n\twindow.addEventListener('keydown', e => {\r\n\t\tif(e.ctrlKey && e.altKey) {\r\n\t\t\tif(e.key == 'd') {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tconfig.showFactComputationDetail = !config.showFactComputationDetail;\r\n\t\t\t\tconsole.log(`[gw2-tooltips] [cfg] showFactComputationDetail is now ${config.showFactComputationDetail}`);\r\n\t\t\t\tif(lastTooltipTarget && tooltip.style.display != 'none') {\r\n\t\t\t\t\tshowTooltipFor(lastTooltipTarget, cyclePos); // visibleIndex = cyclePos: keep the same sub-tooltip active\r\n\t\t\t\t\tpositionTooltip();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if(e.key == 't') {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tconfig.showPreciseAbilityTimings = !config.showPreciseAbilityTimings;\r\n\t\t\t\tconsole.log(`[gw2-tooltips] [cfg] showPreciseAbilityTimings is now ${config.showPreciseAbilityTimings}`);\r\n\t\t\t\tif(lastTooltipTarget && tooltip.style.display != 'none') {\r\n\t\t\t\t\tshowTooltipFor(lastTooltipTarget, cyclePos); // visibleIndex = cyclePos: keep the same sub-tooltip active\r\n\t\t\t\t\tpositionTooltip();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction displayCorrectChainTooltip(tooltips: HTMLElement[], tooltipIndex: number) {\r\n\tfor(let index = 0; index < tooltips.length; index++) {\r\n\t\ttooltips[index].classList.toggle('active', index === tooltipIndex);\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb); If the tooltip doesn't fit on screen its probably because we have may and they don't fit even if collapsed.\r\n// In that case we want to fit the currently active one on screen instead of the whole list.\r\nfunction positionTooltip() {\r\n\tconst wpadminbar = document.getElementById('wpadminbar'); //TODO(Rennorb) @hardcoded: this accounts for the wordpress bar that might exist.\r\n\tconst topBarHeight = wpadminbar ? wpadminbar.offsetHeight : 0;\r\n\r\n\t//using actual css margins in css is pain\r\n\tconst marginX = 22;\r\n\tconst marginY = 13;\r\n\t//some space form the cursor\r\n\tconst offsetX = 6;\r\n\tconst offsetY = 6;\r\n\r\n\tlet tooltipXpos = lastMouseX + offsetX;\r\n\tif(tooltipXpos + tooltip.offsetWidth + marginX > document.documentElement.clientWidth) {\r\n\t\ttooltipXpos = document.documentElement.clientWidth - (tooltip.offsetWidth + marginX);\r\n\t}\r\n\tlet tooltipYpos = lastMouseY - offsetY - tooltip.offsetHeight;\r\n\tif(tooltipYpos - marginY < document.documentElement.scrollTop) {\r\n\t\ttooltipYpos = topBarHeight + marginY + document.documentElement.scrollTop;\r\n\t}\r\n\r\n\ttooltip.style.transform = `translate(${tooltipXpos}px, ${tooltipYpos}px)`;\r\n}\r\n\r\nexport function hookDocument(scope : ScopeElement, _unused? : any) : Promise<void[]> {\r\n\t//NOTE(Rennorb): need to use an array since there might be multiple occurrences of the same id in a given scope\r\n\tconst objectsToGet : ObjectsToFetch = {\r\n\t\tskills         : new Map<number, HTMLElement[] | undefined>(),\r\n\t\ttraits         : new Map<number, HTMLElement[] | undefined>(),\r\n\t\titems          : new Map<number, HTMLElement[] | undefined>(),\r\n\t\tspecializations: new Map<number, HTMLElement[] | undefined>(),\r\n\t\tpets           : new Map<number, HTMLElement[] | undefined>(),\r\n\t\t'pvp/amulets'  : new Map<number, HTMLElement[] | undefined>(),\r\n\t}\r\n\tconst statsToGet = new Set<number>();\r\n\tconst _legacy_effectErrorStore = new Set<string>();\r\n\r\n\tfor(const gw2Object of scope.getElementsByTagName('gw2object') as HTMLCollectionOf<HTMLElement>) {\r\n\t\tconst stats = +String(gw2Object.getAttribute('stats'))\r\n\t\tif(!isNaN(stats)) statsToGet.add(stats);\r\n\r\n\t\tlet objId = +String(gw2Object.getAttribute('objId'))\r\n\t\t//TODO(Rennorb) @cleanup @compat: this is literally just for naming 'convenience'.\r\n\t\t// Figure out if we can just get rid of the +'s' or if that poses an issue with backwards compat\r\n\t\tlet type = (gw2Object.getAttribute('type') || 'skill') + 's'\r\n\r\n\t\tif(config.legacyCompatibility) {\r\n\t\t\t//NOTE(Rennorb): weapon swaps are completely synthesized\r\n\t\t\tif(type === 'effects') {\r\n\t\t\t\ttype = 'skills';\r\n\t\t\t\tobjId = _legacy_transformEffectToSkillObject(gw2Object, _legacy_effectErrorStore);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(isNaN(objId) || !(type in objectsToGet)) continue;\r\n\r\n\t\tconst elementsWithThisId = objectsToGet[type as keyof typeof objectsToGet].get(objId);\r\n\t\tif(elementsWithThisId) elementsWithThisId.push(gw2Object)\r\n\t\telse objectsToGet[type as keyof typeof objectsToGet].set(objId, [gw2Object])\r\n\r\n\t\tgw2Object.addEventListener('mouseenter', (e) => showTooltipFor(e.target as HTMLElement));\r\n\t\tgw2Object.addEventListener('mouseleave', () => tooltip.style.display = 'none');\r\n\t}\r\n\r\n\tif(_legacy_effectErrorStore.size) {\r\n\t\tconsole.error(\"[gw2-tooltips] [legacy-compat] Some effects could not be translated into skills: \", Array.from(_legacy_effectErrorStore));\r\n\t}\r\n\r\n\tif(statsToGet.size > 0) APICache.ensureExistence('itemstats', statsToGet.values());\r\n\r\n\treturn Promise.all(Object.entries(objectsToGet).map(async ([key, values]) => {\r\n\t\tif(values.size == 0) return;\r\n\r\n\t\tlet inflator;\r\n\t\tswitch(key) {\r\n\t\t\tcase 'skills'         : inflator = inflateSkill;          break;\r\n\t\t\tcase 'items'          : inflator = inflateItem;           break;\r\n\t\t\tcase 'specializations': inflator = inflateSpecialization; break;\r\n\t\t\tdefault               : inflator = inflateGenericIcon;    break;\r\n\t\t}\r\n\t\tconst cache = APICache.storage[key];\r\n\r\n\t\tawait APICache.ensureExistence(key, values.keys())\r\n\r\n\t\tfor(const [id, objects] of values) {\r\n\t\t\tconst data = cache.get(id);\r\n\t\t\tif(!objects || !data) continue;\r\n\r\n\t\t\tfor(const gw2Object of objects)\r\n\t\t\t\tinflator(gw2Object, data as any);\r\n\t\t}\r\n\t}))\r\n}\r\n\r\nfunction showTooltipFor(gw2Object : HTMLElement, visibleIndex = 0) {\r\n\tconst type = ((gw2Object.getAttribute('type') || 'skill') + 's') as `${LegacyCompat.ObjectType}s`;\r\n\tconst objId = +String(gw2Object.getAttribute('objId'))\r\n\tlet   context_ = context[+String(gw2Object.getAttribute('contextSet')) || 0];\r\n\tconst stackSize = +String(gw2Object.getAttribute('count')) || undefined;\r\n\r\n\tif(type == 'specializations' || type == 'effects') return; //TODO(Rennorb) @completeness: inline objs\r\n\tif(type == 'pets') return; //TODO(Rennorb) @completeness\r\n\r\n\tlastTooltipTarget = gw2Object;\r\n\r\n\tconst data = APICache.storage[type].get(objId);\r\n\tif(data) {\r\n\t\tcyclePos = visibleIndex;\r\n\t\tif(type == 'items' || type == \"pvp/amulets\") {\r\n\t\t\tconst statId = +String(gw2Object.getAttribute('stats')) || undefined;\r\n\t\t\ttooltip.replaceChildren(generateItemTooltip(data as API.Item, context_, gw2Object, statId, stackSize));\r\n\t\t}\r\n\t\telse {\r\n\t\t\tcontext_ = specializeContextFromInlineAttribs(context_, gw2Object);\r\n\t\t\ttooltip.replaceChildren(...generateToolTipList(data as Exclude<typeof data, API.Item>, gw2Object, context_));\r\n\t\t}\r\n\t\ttooltip.style.display = ''; //empty value resets actual value to use stylesheet\r\n\t}\r\n}\r\n\r\n//TODO(Rennorb): this is neither complete, nor reliable\r\nfunction getSlotName(skill: API.Skill) : string | undefined {\r\n\tlet skillSlot\r\n\tfor(const palette of skill.palettes) {\r\n\t\tfor(const slot of palette.slots) {\r\n\t\t\tswitch (palette.type) {\r\n\t\t\t\tcase 'Equipment':\r\n\t\t\t\tcase 'Bundle':\r\n\t\t\t\t\t//NOTE(Rennorb): mech skills are part pet part equipment skills...\r\n\t\t\t\t\t//TODO(Rennorb): Figure out a good way to get the actual slot name for that. Also look at actual pets.\r\n\t\t\t\t\tif(palette.weapon_type !== 'None' || palette.type == 'Bundle') {\r\n\t\t\t\t\t\t//TODO(Rennorb) @cleanup: move this to the api side\r\n\t\t\t\t\t\tskillSlot = slot.slot.replace(/(Offhand|Main)(\\d)/, (_, hand, digit) => {\r\n\t\t\t\t\t\t\tif(hand == 'Offhand') {\r\n\t\t\t\t\t\t\t\tdigit = digit === '1' ? '4' : '5'\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\treturn `${mapLocale(palette.weapon_type)} ${digit}`\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'Standard':\r\n\t\t\t\t\tif(slot.slot === 'Standard') {\r\n\t\t\t\t\t\tskillSlot = 'Utility'\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\tcase 'Heal':\r\n\t\t\t\tcase 'Toolbelt':\r\n\t\t\t\tcase 'Elite':\r\n\t\t\t\t\t\tskillSlot = palette.type;\r\n\t\t\t\t\tbreak\r\n\r\n\t\t\t\t\tcase 'Pet':\r\n\t\t\t\tcase 'Profession':\r\n\t\t\t\t\tskillSlot = slot.slot\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase 'Monster':\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tconsole.error(`[gw2-tooltips] [tooltip engine] unknown palette type '${palette.type}' for skill '${skill.name}'`)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn skillSlot\r\n}\r\n\r\n// TODO(Rennorb) @cleanup: split this into the inflator system aswell. its getting to convoluted already\r\nfunction generateToolTip(apiObject : SupportedTTTypes, context : Context) : HTMLElement {\r\n\tconst headerElements = [newElm('teb', GW2Text2HTML(apiObject.name))];\r\n\theaderElements.push(newElm('div.flexbox-fill')); // split, now the right side\r\n\r\n\tconst currentContextInformation = resolveTraitsAndOverrides(apiObject, context);\r\n\r\n\t// TODO(mithos): add no underwater check\r\n\tif(0) {\r\n\t\theaderElements.push(newImg(ICONS.NO_UNDERWATER, 'iconsmall'));\r\n\t}\r\n\r\n\tif(currentContextInformation.activation) {\r\n\t\tconst value = drawFractional(currentContextInformation.activation / 1000, config);\r\n\t\tif (value != '0') { //in case we rounded down a fractional value just above 0\r\n\t\t\theaderElements.push(newElm('ter',\r\n\t\t\t\tvalue,\r\n\t\t\t\tnewImg(ICONS.ACTIVATION, 'iconsmall')\r\n\t\t\t));\r\n\t\t}\r\n\t}\r\n\r\n\tif(currentContextInformation.resource_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(currentContextInformation.resource_cost),\r\n\t\t\t//TODO(Rennorb) @correctness: see reaper shroud\r\n\t\t\tnewImg(context.character.profession == 'Revenant' ? ICONS.RESOURCE_REV : ICONS.RESOURCE_THIEF, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tif(currentContextInformation.endurance_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\tString(Math.round(currentContextInformation.endurance_cost)),\r\n\t\tnewImg(ICONS.ENDURANCE_COST, 'iconsmall')\r\n\t\t));\t\t\r\n\t}\r\n\r\n\tif(currentContextInformation.upkeep_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(currentContextInformation.upkeep_cost),\r\n\t\t\tnewImg(ICONS.UPKEEP_COST, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tif(currentContextInformation.recharge) {\r\n\t\tconst value = drawFractional(currentContextInformation.recharge / 1000, config);\r\n\t\tif (value != '0') {\r\n\t\t\theaderElements.push(newElm('ter',\r\n\t\t\t\tvalue,\r\n\t\t\t\tnewImg(ICONS.RECHARGE, 'iconsmall')\r\n\t\t\t));\r\n\t\t}\r\n\t}\r\n\r\n\tif(currentContextInformation.supply_cost) {\r\n\t\theaderElements.push(newElm('ter',\r\n\t\t\tString(currentContextInformation.supply_cost),\r\n\t\t\tnewImg(ICONS.SUPPLY_COST, 'iconsmall')\r\n\t\t));\r\n\t}\r\n\r\n\tconst secondHeaderRow = [];\r\n\t{\r\n\t\t//TODO(Rennorb): slots stuff might not be doable serverside since the server is missing context. this is at least a case of @cleanup\r\n\t\tlet slotName = ('slot' in apiObject && apiObject.slot) || ('palettes' in apiObject && getSlotName(apiObject));\r\n\t\tif(slotName) secondHeaderRow.push(newElm('tes', `( ${slotName} )`));\r\n\t}\r\n\r\n\tsecondHeaderRow.push(newElm('div.flexbox-fill')); // split, now the right side\r\n\r\n\tif('override_groups' in apiObject && apiObject.override_groups) {\r\n\t\tconst baseContext = new Set<GameMode>(['Pve', 'Pvp', 'Wvw']);\r\n\t\tfor(const override of apiObject.override_groups) {\r\n\t\t\tfor(const context of override.context) {\r\n\t\t\t\tbaseContext.delete(context as GameMode);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst splits = [Array.from(baseContext), ...apiObject.override_groups.map(o => o.context)]\r\n\r\n\t\tconst splits_html : string[] = [];\r\n\t\tfor(const mode of ['Pve', 'Pvp', 'Wvw'] as GameMode[]) { //loop to keep sorting vaguely correct\r\n\t\t\tlet split;\r\n\t\t\tfor(let i = 0; i < splits.length; i++) {\r\n\t\t\t\tif(splits[i].includes(mode)) {\r\n\t\t\t\t\tsplit = splits.splice(i, 1)[0];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(!split) continue;\r\n\r\n\t\t\tconst text = split.join('/');\r\n\t\t\tif(split.includes(context.gameMode))\r\n\t\t\t\tsplits_html.push(`<span style=\"color: var(--gw2-tt-color-text-accent) !important;\">${text}</span>`);\r\n\t\t\telse\r\n\t\t\t\tsplits_html.push(text);\r\n\t\t}\r\n\r\n\t\tsecondHeaderRow.push(newElm('tes', '( ', fromHTML(splits_html.join(' | ')), ' )'));\r\n\t}\r\n\r\n\tconst parts : HTMLElement[] = [newElm('tet', ...headerElements)];\r\n\tif(secondHeaderRow.length > 1) parts.push(newElm('tet.detail', ...secondHeaderRow));\r\n\r\n\tif('description' in apiObject && apiObject.description) {\r\n\t\tconst description = document.createElement('ted')\r\n\t\tdescription.style.marginTop = '.5em'; //TODO(Rennorb) @cleanup\r\n\t\tdescription.style.marginBottom = '.5em';\r\n\t\tdescription.innerHTML = `<teh>${GW2Text2HTML(apiObject.description)}</teh>`\r\n\t\tparts.push(description)\r\n\t}\r\n\r\n\tif(currentContextInformation.facts) {\r\n\t\t//NOTE(Rennorb): 690.5 is the midpoint weapon strength for slot skills (except bundles).\r\n\t\t//TODO(Rennorb) @hardcoded @correctness: This value is hardcoded for usage with traits as they currently don't have any pointer that would provide weapon strength information.\r\n\t\t// This will probably fail in some cases where damage facts on traits reference bundle skills (e.g. kits).\r\n\t\tlet weaponStrength = 690.5;\r\n\t\tif('palettes' in apiObject && apiObject.palettes.length) {\r\n\t\t\tconst criteria = context.character.profession\r\n\t\t\t\t? ((s : API.Slot) => s.profession === context.character.profession)\r\n\t\t\t\t: ((s : API.Slot) => s.profession !== 'None');\r\n\t\t\tconst relevantPalette = apiObject.palettes.find(p => p.slots.some(criteria));\r\n\r\n\t\t\tif(relevantPalette) {\r\n\t\t\t\tweaponStrength = getWeaponStrength(relevantPalette)\r\n\t\t\t}\r\n\t\t}\r\n\t\tparts.push(...generateFacts(currentContextInformation.facts, weaponStrength, context))\r\n\t}\r\n\r\n\tconst tooltip = newElm('div.tooltip', ...parts)\r\n\ttooltip.dataset.id = String(apiObject.id)\r\n\r\n\treturn tooltip;\r\n}\r\n\r\nexport function resolveTraitsAndOverrides(apiObject : SupportedTTTypes & { facts? : API.Fact[], override_groups? : API.ContextInformation['override_groups'] }, context : Context) : API.ContextInformation {\r\n\tlet override = apiObject.override_groups?.find(g => g.context.includes(context.gameMode));\r\n\tlet result = Object.assign({}, apiObject, override);\r\n\tif(apiObject.facts && override && override.facts) {\r\n\t\tresult.facts = apiObject.facts.slice(); //clone the array\r\n\t\tfor(const fact of override.facts) {\r\n\t\t\tif(fact.requires_trait?.some(t => !context.character.traits.includes(t))) continue;\r\n\r\n\t\t\tif(fact.insert_before !== undefined) result.facts.splice(fact.insert_before, 0, fact);\r\n\t\t\telse result.facts.push(fact);\r\n\t\t}\r\n\t}\r\n\r\n\tif(result.facts) {\r\n\t\tconst finalFacts = [];\r\n\t\tfor(let i = 0; i < result.facts.length; i++) {\r\n\t\t\tconst fact = result.facts[i];\r\n\r\n\t\t\tif(fact.requires_trait?.some(t => !context.character.traits.includes(t))) continue;\r\n\r\n\t\t\tfinalFacts.push(fact);\r\n\t\t\t\r\n\t\t\tif(fact.skip_next) i++;\r\n\t\t}\r\n\r\n\t\tresult.facts = finalFacts;\r\n\t}\r\n\r\n\treturn result;\r\n}\r\n\r\n//TODO(Rennorb) @correctness: this does not take traits into consideration\r\nexport function getHealth(character : Character) : number {\r\n\t//TODO(Rennorb): level scaling\r\n\tconst baseHealth = !character.profession\r\n\t\t? 1000 //TODO(Rennorb): none?\r\n\t\t: ({\r\n\t\t\t\tGuardian     : 1645,\r\n\t\t\t\tThief        : 1645,\r\n\t\t\t\tElementalist : 1645,\r\n\t\t\t\tEngineer     : 5922,\r\n\t\t\t\tRanger       : 5922,\r\n\t\t\t\tMesmer       : 5922,\r\n\t\t\t\tRevenant     : 5922,\r\n\t\t\t\tNecromancer  : 9212,\r\n\t\t\t\tWarrior      : 9212,\r\n\t\t\t} as { [k in Profession] : number })[character.profession];\r\n\r\n\treturn baseHealth + character.stats.vitality * 10;\r\n}\r\n\r\nfunction getWeaponStrength({ weapon_type, type : palette_type } : API.Palette) : number {\r\n\tif(weapon_type === 'None') {\r\n\t\tif(palette_type === 'Bundle') {\r\n\t\t\treturn 922.5\r\n\t\t}\r\n\r\n\t\t//NOTE(Rennorb): The default value. Im not 100% sure if this is correct in all cases.\r\n\t\treturn 690.5\r\n\t}\r\n\telse {\r\n\t\treturn {\r\n\t\t\tBundleLarge: 0,\r\n\t\t\tStandard   : 690.5,\r\n\t\t\tFocus      : 900,\r\n\t\t\tShield     : 900,\r\n\t\t\tTorch      : 900,\r\n\t\t\tWarhorn    : 900,\r\n\t\t\tGreatsword : 1100,\r\n\t\t\tHammer     : 1100,\r\n\t\t\tStaff      : 1100,\r\n\t\t\tBowLong    : 1050,\r\n\t\t\tRifle      : 1150,\r\n\t\t\tBowShort   : 1000,\r\n\t\t\tAxe        : 1000,\r\n\t\t\tSword      : 1000,\r\n\t\t\tDagger     : 1000,\r\n\t\t\tPistol     : 1000,\r\n\t\t\tScepter    : 1000,\r\n\t\t\tMace       : 1000,\r\n\t\t\tSpear      : 1000,\r\n\t\t\tSpeargun   : 1000,\r\n\t\t\tTrident    : 1000,\r\n\t\t}[weapon_type];\r\n\t}\r\n}\r\n\r\nfunction generateToolTipList(initialAPIObject : SupportedTTTypes, gw2Object: HTMLElement, context : Context) : HTMLElement[] {\r\n\tconst objectChain : SupportedTTTypes[] = []\r\n\tconst validPaletteTypes = ['Bundle', 'Heal', 'Elite', 'Profession', 'Standard', 'Equipment']\r\n\r\n\tconst addObjectsToChain = (currentObj : SupportedTTTypes) => {\r\n\t\tlet hasChain = false;\r\n\t\tif('palettes' in currentObj) {\r\n\t\t\t//TODO(Rennorb): cleanup is this neccesary? Since the root element already gets replaced automatically, It would be if we have skills where some skill in the chain needs to be replaced. \r\n\t\t\tif(config.adjustTraitedSkillIds) {\r\n\t\t\t\tconst replacementSkill = findTraitedOverride(currentObj, context);\r\n\t\t\t\tif(replacementSkill) currentObj = replacementSkill;\r\n\t\t\t}\r\n\t\t\tobjectChain.push(currentObj);\r\n\r\n\t\t\tfor(const palette of currentObj.palettes) {\r\n\t\t\t\tfor(const slot of palette.slots) {\r\n\t\t\t\t\tif(slot.next_chain && slot.profession !== 'None') {\r\n\t\t\t\t\t\tconst nextSkillInChain = APICache.storage.skills.get(slot.next_chain);\r\n\t\t\t\t\t\tif(nextSkillInChain) {\r\n\t\t\t\t\t\t\thasChain = true;\r\n\t\t\t\t\t\t\taddObjectsToChain(nextSkillInChain)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tobjectChain.push(currentObj)\r\n\t\t}\r\n\r\n\t\t//TODO(Rennorb): Apparently sub_skills (`related_skills`) is of very questionable correctness and seems to only be used internally.\r\n\t\t// Using it in this way might produce unexpected results.\r\n\t\t//NOTE(Rennorb): Checking for the skill chain here since it usually produces duplicated entries if one is present and the skill chain is more authoritative.\r\n\t\t//NOTE(Rennorb): `related_skills` is also used for traits.\r\n\t\tif(!hasChain && 'related_skills' in currentObj) {\r\n\t\t\tfor(const subSkillId of currentObj.related_skills!) {\r\n\t\t\t\tconst subSkillInChain = APICache.storage.skills.get(subSkillId);\r\n\t\t\t\tconst type = gw2Object.getAttribute('type') || 'skill';\r\n\t\t\t\tif(subSkillInChain && ((type == 'trait') || subSkillInChain.palettes.some(palette => validPaletteTypes.includes(palette.type)))) {\r\n\t\t\t\t\tobjectChain.push(subSkillInChain)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddObjectsToChain(initialAPIObject)\r\n\r\n\tconst tooltipChain = objectChain.map(obj => generateToolTip(obj, context));\r\n\ttooltip.append(...tooltipChain)\r\n\r\n\tif(tooltipChain.length > 1) {\r\n\t\tgw2Object.classList.add('cycler')\r\n\t\tgw2Object.title = 'Right-click to cycle through tooltips'\r\n\r\n\t\t// is already set to 0 if this is a new one\r\n\t\t//TODO(Rennorb): should we actually reset this every time?\r\n\t\tdisplayCorrectChainTooltip(tooltipChain, cyclePos)\r\n\t}\r\n\telse {\r\n\t\ttooltipChain[0].classList.add('active'); // single tooltip is always expanded\r\n\t}\r\n\r\n\treturn tooltipChain\r\n}\r\n\r\nexport function findTraitedOverride(skill : API.Skill, context : Context) : API.Skill | undefined {\r\n\tfor(const palette of skill.palettes) {\r\n\t\tfor(const slot of palette.slots) {\r\n\t\t\tif(slot.traited_alternatives) {\r\n\t\t\t\t//TODO(Rennorb): use buffs here\r\n\t\t\t\tconst pair = slot.traited_alternatives.find(([a, _]) => context.character.traits.includes(a));\r\n\t\t\t\tif(!pair) return;\r\n\r\n\t\t\t\tconst [traitId, altId] = pair;\r\n\t\t\t\tif(altId == skill.id) return;\r\n\r\n\t\t\t\tconst replacementSkill = APICache.storage.skills.get(altId);\r\n\t\t\t\tif(!replacementSkill) {\r\n\t\t\t\t\tconsole.error(`[gw2-tooltips] Corrected skill #${altId} is missing in the cache.`);\r\n\t\t\t\t\treturn undefined;\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.info(`[gw2-tooltips] Corrected skill #${skill.id} (${skill.name}) to #${replacementSkill.id} (${replacementSkill.name}) because the trait #${traitId} (${APICache.storage.traits.get(traitId)?.name || '<not cached>'}) is active.`);\r\n\t\t\t\t\t//TODO(Rennorb): Add indicator on the skill that its been replaced by a trait.\r\n\t\t\t\t\treturn replacementSkill;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction generateItemTooltip(item : API.Item, context : Context, target : HTMLElement, statSetId? : number, stackSize = 1) : HTMLElement {\r\n\tlet statSet : API.AttributeSet | undefined = undefined;\r\n\tif(item.type == \"Armor\" || item.type == \"Trinket\" || item.type == \"Weapon\") {\r\n\t\tstatSetId = statSetId || item.attribute_set;\r\n\t\tif(statSetId === undefined) console.warn(`[gw2-tooltips] [tooltip engine] Hovering on item without specified or innate stats. Specify the stats by adding 'stats=\"<stat_set_id>\" to the html element.' `);\r\n\t\telse {\r\n\t\t\tstatSet = APICache.storage.itemstats.get(statSetId);\r\n\t\t\tif(!statSet) console.error(`[gw2-tooltips] [tooltip engine] itemstat #${statSetId} is missing in cache.`);\r\n\t\t\telse {\r\n\t\t\t\t//TODO(Rennorb): should this happen at injection time?\r\n\t\t\t\tif(config.adjustIncorrectStatIds && statSet.similar_sets) {\r\n\t\t\t\t\tconst correctSetId = statSet.similar_sets[item.subtype];\r\n\t\t\t\t\tif(correctSetId !== undefined) {\r\n\t\t\t\t\t\tconsole.info(`[gw2-tooltips] [tooltip engine] Corrected itemstat #${statSetId} to #${correctSetId} because the target is of type ${item.subtype}.`);\r\n\t\t\t\t\t\tconst newSet = APICache.storage.itemstats.get(correctSetId);\r\n\t\t\t\t\t\tif(!newSet) console.error(`[gw2-tooltips] [tooltip engine] Corrected itemstat #${correctSetId} is missing in the cache.`);\r\n\t\t\t\t\t\telse statSet = newSet;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tlet slottedItems : (API.ItemBase & API.ItemUpgradeComponent)[] | undefined;\r\n\tif('slots' in item) {\r\n\t\tslottedItems = target.getAttribute('slotted')?.split(',')\r\n\t\t\t.map(id => APICache.storage.items.get(+String(id) || 0))\r\n\t\t\t.filter(i => i && 'subtype' in i) as (API.ItemBase & API.ItemUpgradeComponent)[];\r\n\t}\r\n\r\n\tconst countPrefix = stackSize > 1 ? stackSize + ' ' : '';\r\n\tconst upgradeNameSource = slottedItems?.find(i => !['Infusion', 'Enrichment'].includes(i.subtype)) || slottedItems?.[0];\r\n\tconst name = countPrefix + formatItemName(item, context, statSet, upgradeNameSource, stackSize);\r\n\tconst parts = [newElm('tet', newImg(item.icon),  newElm('teb.gw2-color-rarity-'+item.rarity.toLowerCase(), name), newElm('div.flexbox-fill'))];\r\n\r\n\tif('defense' in item && item.defense) {\r\n\t\tconst defense = (typeof item.defense  == \"number\")\r\n\t\t\t? item.defense\r\n\t\t\t: LUT_DEFENSE[Math.min(100, (item.defense[0] + context.character.level))] * item.defense[1];\r\n\r\n\t\tparts.push(newElm('te', newElm('tem', 'Defense: ', newElm('span.gw2-color-stat-green', String(defense)))));\r\n\t}\r\n\r\n\tif('power' in item) {\r\n\t\tlet power;\r\n\t\tif('mul' in item.power) {\r\n\t\t\tlet minRarity : keyof typeof LUT_RARITY = 'Common';\r\n\t\t\tif(['PlayerLevelScaleRarity', 'ItemScale4'].includes(item.power.scaling!)) {\r\n\t\t\t\t//NOTE(Rennorb) @hardcoded: these thresholds are apparently from a config\r\n\t\t\t\tif(context.character.level >= 14) minRarity = 'Uncommon'; // content:Configuration?guid=Wu52xQQYEUWiDdyKv+jf2Q==\r\n\t\t\t\telse if(context.character.level >= 30) minRarity = 'Rare'; // content:Configuration?guid=AX9BmdFkNkuyIpWOz58kmA==\r\n\t\t\t\telse if(context.character.level >= 60) minRarity = 'Exotic'; // content:Configuration?guid=X6vQWpTe2Ui+LPdJTv560g==\r\n\t\t\t\telse if(context.character.level >= 80) minRarity = 'Legendary'; // content:Configuration?guid=W2O5W4HAPEy3GJFfaSt4mQ==\r\n\t\t\t}\r\n\t\t\tlet index = Math.max(LUT_RARITY[item.rarity], LUT_RARITY[minRarity]);\r\n\t\t\tif(!item.power.scaling) //no scaling means ItemLevel scaling\r\n\t\t\t\tindex += item.level;\r\n\t\t\telse { //any of the other three\r\n\t\t\t\tindex += context.character.level;\r\n\t\t\t}\r\n\r\n\t\t\tconst avg = (context.character.isPlayer ? LUT_POWER_PLAYER : LUT_POWER_MONSTER)[Math.min(100, index)] * item.power.mul;\r\n\t\t\tconst spread = avg * item.power.spread;\r\n\t\t\tpower = [Math.ceil(avg - spread), Math.ceil(avg + spread)];\r\n\t\t}\r\n\t\telse {\r\n\t\t\tpower = item.power;\r\n\t\t}\r\n\r\n\t\tparts.push(newElm('te', newElm('tem', 'Weapon Strength: ', newElm('span.gw2-color-stat-green', `${power[0]} - ${power[1]}`))));\r\n\t}\r\n\r\n\tif('tiers' in item) {\r\n\t\tparts.push(generateUpgradeItemGroup(item, context));\r\n\t}\r\n\r\n\tif(statSet && 'attribute_base' in item) {\r\n\t\tparts.push(...statSet.attributes.map(({attribute, base_value, scaling}) => {\r\n\t\t\tconst computedValue = Math.round(base_value + item.attribute_base! * scaling);\r\n\t\t\t//TODO(Rennorb) @cleanup: just return correct names from the api. \r\n\t\t\treturn newElm('te', newElm('tem.gw2-color-stat-green', `+${computedValue} ${mapLocale(attribute)}`));\r\n\t\t}));\r\n\t}\r\n\r\n\tif('slots' in item) {\r\n\t\tparts.push(newElm('div.group.slots', ...item.slots.map(s => {\r\n\t\t\tlet slottedItemIdx = -1;\r\n\t\t\tif(slottedItems) {\r\n\t\t\t\tswitch(s) {\r\n\t\t\t\t\tcase 'Upgrade'   : slottedItemIdx = slottedItems.findIndex(i => ['Rune', 'Sigil', 'Gem'].includes(i.subtype)); break;\r\n\t\t\t\t\tcase 'Infusion'  : slottedItemIdx = slottedItems.findIndex(i => i.subtype == 'Infusion'); break;\r\n\t\t\t\t\tcase 'Enrichment': slottedItemIdx = slottedItems.findIndex(i => i.subtype == 'Enrichment'); break;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(slottedItemIdx > -1) {\r\n\t\t\t\tconst slottedItem = slottedItems!.splice(slottedItemIdx, 1)[0];\r\n\t\t\t\tconst group = generateUpgradeItemGroup(slottedItem, context);\r\n\t\t\t\tconst name = formatItemName(slottedItem, context, statSet);\r\n\t\t\t\tgroup.prepend(newElm('tet', newImg(slottedItem.icon, 'iconsmall'),  newElm('teb.gw2-color-rarity-'+slottedItem.rarity, name), newElm('div.flexbox-fill')));\r\n\t\t\t\treturn group;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\treturn newElm('te',\r\n\t\t\t\t\tnewImg(ICONS['SLOT_'+s as keyof typeof ICONS], 'iconsmall'), `Empty ${s} Slot`\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t})));\r\n\t}\r\n\r\n\tconst metaInfo = newElm('div.group');\r\n\tif(item.type == \"Armor\" || item.type == \"Weapon\" || item.type == \"Trinket\") {\r\n\t\t//NOTE(Rennorb): PvP amulets only show the stats, they aren't real 'items'.\r\n\t\tif(item.subtype != 'Amulet' || !item.flags.includes('Pvp')) {\r\n\t\t\tmetaInfo.append(newElm('span.gw2-color-rarity-'+item.rarity, item.rarity));\r\n\t\t\tif('weight' in item) metaInfo.append(newElm('span', item.weight));\r\n\t\t\tmetaInfo.append(newElm('span', `${item.type}: ${item.subtype}`));\r\n\t\t\tif(item.type == \"Weapon\" && isTwoHanded(item.subtype)) metaInfo.append(newElm('span.gw2-color-rarity-Junk', `(Two-Handed)`));\r\n\t\t\tif(item.required_level) metaInfo.append(newElm('span', 'Required Level: '+item.required_level));\r\n\t\t}\r\n\t}\r\n\tif(item.description) metaInfo.append(newElm('span', fromHTML(GW2Text2HTML(item.description))));\r\n\r\n\tif(!item.flags.includes('Pvp')) { //NOTE(Rennorb): pvp items (runes / sigils) don't show these\r\n\t\tif(item.flags.includes('Unique')) metaInfo.append(newElm('span', 'Unique'));\r\n\t\tif(item.flags.includes('AccountBound')) metaInfo.append(newElm('span', 'Account Bound'));\r\n\t\tif(item.flags.includes('SoulBindOnUse')) metaInfo.append(newElm('span', 'Soulbound on Use'));\r\n\t\telse if(item.flags.includes('SoulBindOnAcquire')) metaInfo.append(newElm('span', 'Soulbound on Acquire'));\r\n\t}\r\n\r\n\tif(!item.flags.includes('NoSalvage')) {\r\n\t\tconst salvageOptions = [item.type == 'Consumable' && item.subtype == 'Food'\r\n\t\t\t? 'Compost'\r\n\t\t\t: item.rarity == 'Ascended' ? 'Ascended' : 'Standard'\r\n\t\t];\r\n\t\tif(item.flags_ex.includes('SalvageResearch')) salvageOptions.push('Research');\r\n\t\tif(salvageOptions.length) metaInfo.append(newElm('span', 'Salvage: '+salvageOptions.join(', ')));\r\n\t}\r\n\r\n\tif(item.vendor_value) {\r\n\t\tlet inner = ['Vendor Value: ', formatCoins(item.vendor_value * stackSize)];\r\n\t\tif(stackSize > 1)\r\n\t\t\tinner.push(' (', formatCoins(item.vendor_value), ` x ${stackSize})`);\r\n\t\tmetaInfo.append(newElm('span', ...inner));\r\n\t}\r\n\r\n\tparts.push(metaInfo);\r\n\r\n\tconst tooltip = newElm('div.tooltip.item.active', ...parts);\r\n\ttooltip.dataset.id = String(item.id);\r\n\treturn tooltip;\r\n}\r\n\r\nfunction generateUpgradeItemGroup(item : API.ItemUpgradeComponent | API.ItemConsumable | API.ItemAmulet, context : Context) : HTMLElement {\r\n\tconst group = newElm('div.group');\r\n\tfor(const [i, tier] of item.tiers.entries()) {\r\n\t\tlet tier_wrap = newElm('te');\r\n\t\tif(tier.description) tier_wrap.append(newElm('span', fromHTML(GW2Text2HTML(tier.description))));\r\n\r\n\t\t//NOTE(Rennorb): facts seem to exist, but almost universally be wrong.\r\n\t\telse if(tier.facts) {\r\n\t\t\tfor(const fact of tier.facts) {\r\n\t\t\t\tconst { wrapper } = generateFact(fact, null as any, context);\r\n\t\t\t\tif(wrapper) tier_wrap.append(wrapper);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\telse if(tier.modifiers) {\r\n\t\t\ttier_wrap.style.flexDirection = \"column\";\r\n\t\t\tfor(const modifier of tier.modifiers) {\r\n\t\t\t\t//TODO(Rennorb) @cleanup: unify this wth the buf fact processing\r\n\t\t\t\tlet modifierValue = calculateModifier(modifier, context.character);\r\n\r\n\t\t\t\tlet text;\r\n\t\t\t\tif(modifier.flags.includes('FormatPercent')) {\r\n\t\t\t\t\ttext = `+${Math.round(modifierValue)}% ${mapLocale(modifier.description as any)}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttext = `+${Math.round(modifierValue)} ${mapLocale(modifier.description as any)}`;\r\n\t\t\t\t}\r\n\t\t\t\ttier_wrap.append(newElm('te', text));\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tconst w = newElm('te', tier_wrap);\r\n\t\tif(item.subtype == \"Rune\") {\r\n\t\t\tconst colorClass = i < (context.character.upgradeCounts[item.id] || 0) ? '.gw2-color-stat-green' : '';\r\n\t\t\tw.prepend(newElm('span'+colorClass, `(${i + 1})`));\r\n\t\t}\r\n\t\tgroup.append(w);\r\n\t}\r\n\r\n\treturn group;\r\n}\r\n\r\nfunction calculateConditionDuration(level : number, expertise : number) {\r\n\treturn expertise / (LUT_CRITICAL_DEFENSE[level] * (15 / LUT_CRITICAL_DEFENSE[80]));\r\n}\r\n\r\nfunction calculateBoonDuration(level : number, concentration : number) {\r\n\treturn concentration / (LUT_CRITICAL_DEFENSE[level] * (15 / LUT_CRITICAL_DEFENSE[80]));\r\n}\r\n\r\n//TODO(Rennorb): have another look at the suffix. might still be missing in the export\r\nexport function formatItemName(item : API.Item, context : Context, statSet? : API.AttributeSet, upgradeComponent? : any, stackSize = 1) : string {\r\n\tlet name;\r\n\tif(item.type == 'TraitGuide') {\r\n\t\tname = item.trait;\r\n\t}\r\n\telse {\r\n\t\tname = item.name;\r\n\t}\r\n\r\n\tlet arg1, arg2, arg3, arg4;\r\n\targ1 = arg2 = arg3 = arg4 = '';\r\n\r\n\tif(!item.flags.includes('HidePrefix' as any)) { //TODO(Rennorb) @correctness: this flag comes from skindef and is currently not properly exported\r\n\t\tif(statSet && statSet.name) {\r\n\t\t\targ1 = statSet.name;\r\n\t\t\targ2 = \" \";\r\n\t\t}\r\n\t}\r\n\r\n\tif(!item.flags.includes('HideSuffix')) {\r\n\t\tif(upgradeComponent && upgradeComponent.suffix) {\r\n\t\t\targ4 = upgradeComponent.suffix;\r\n\t\t\targ3 = \" \";\r\n\t\t}\r\n\t}\r\n\r\n\tname = name.replace('%str1%', arg1).replace('%str2%', arg2).replace('%str3%', arg3).replace('%str4%', arg4);\r\n\r\n\tif(!item.flags.includes('Pve') && (item.flags.includes('Pvp') || item.flags.includes('PvpLobby')))\r\n\t\tname += \" (PvP)\";\r\n\r\n\treturn name.replaceAll('[s]', stackSize > 1 ? 's' : '')\r\n\t\t.replaceAll(/(\\S+)\\[pl:\"(.+?)\"]/g, stackSize > 1 ? '$2' : '$1')\r\n\t\t.replaceAll(/(\\S+)\\[f:\"(.+?)\"]/g, context.character.sex == \"Female\" ? '$2' : '$1')\r\n\t\t.replaceAll('[lbracket]', '[').replaceAll('[rbracket]', ']')\r\n\t\t.replaceAll('[null]', '')\r\n}\r\n\r\n//TODO(Rennorb): @docs\r\nexport function specializeContextFromInlineAttribs(context : Context, gw2Object : HTMLElement) : Context {\r\n\tlet traitOverrides;\r\n\tif(gw2Object.getAttribute('type') === 'skill' && (traitOverrides = gw2Object.getAttribute('with-traits'))) {\r\n\t\tcontext = structuredClone(context);\r\n\t\tconst invalid : string[] = [];\r\n\t\tcontext.character.traits = traitOverrides.split(',').map(t => {\r\n\t\t\tconst v = +t;\r\n\t\t\tif(!v) invalid.push(t);\r\n\t\t\treturn v;\r\n\t\t}).filter(t => t);\r\n\t\tif(invalid.length) console.warn(\"[gw2-tooltips] [tooltip engine] Inline trait-override for element \", gw2Object, \" has misformed overrides: \", invalid)\r\n\t}\r\n\treturn context;\r\n}\r\n\r\nfunction formatCoins(amount : number) : HTMLElement {\r\n\tconst parts = [String(Math.floor(amount % 100)), newImg(ICONS.COIN_COPPER, 'iconsmall', '')];\r\n\tif(amount > 99) parts.unshift(String(Math.floor((amount / 100) % 100)), newImg(ICONS.COIN_SILVER, 'iconsmall', ''));\r\n\tif(amount > 9999) parts.unshift(String(Math.floor(amount / 1_00_00)), newImg(ICONS.COIN_GOLD, 'iconsmall', ''));\r\n\treturn newElm('span', ...parts);\r\n}\r\n\r\nfunction isTwoHanded(type : API.WeaponDetailType) {\r\n\tswitch(type) {\r\n\t\tcase 'Axe'         : return false;\r\n\t\tcase 'Dagger'      : return false;\r\n\t\tcase 'Mace'        : return false;\r\n\t\tcase 'Pistol'      : return false;\r\n\t\tcase 'Scepter'     : return false;\r\n\t\tcase 'Focus'       : return false;\r\n\t\tcase 'Sword'       : return false;\r\n\t\tcase 'BowShort'    : return false;\r\n\t\tcase 'Torch'       : return false;\r\n\t\tcase 'Shield'      : return false;\r\n\t\tcase 'Warhorn'     : return false;\r\n\t\tcase 'Toy'         : return false;\r\n\t\tcase 'ToyTwoHanded': return false;\r\n\t\tcase 'BundleSmall' : return false;\r\n\r\n\t\tcase 'Hammer'     : return true;\r\n\t\tcase 'BowLong'    : return true;\r\n\t\tcase 'Greatsword' : return true;\r\n\t\tcase 'Polearm'    : return true;\r\n\t\tcase 'Rifle'      : return true;\r\n\t\tcase 'Staff'      : return true;\r\n\t\tcase 'BundleLarge': return true;\r\n\t\tcase 'Spear'      : return true;\r\n\t\tcase 'Speargun'   : return true;\r\n\t\tcase 'Trident'    : return true;\r\n\t}\r\n}\r\n\r\nexport const DEFAULT_CONTEXT : Context = {\r\n\tgameMode           : 'Pve',\r\n\ttargetArmor        : 2597,\r\n\tcharacter: {\r\n\t\tlevel            : 80,\r\n\t\tisPlayer         : true,\r\n\t\tsex              : \"Male\",\r\n\t\ttraits           : [],\r\n\t\tstats: {\r\n\t\t\tpower          : 1000,\r\n\t\t\ttoughness      : 1000,\r\n\t\t\tvitality       : 1000,\r\n\t\t\tprecision      : 1000,\r\n\t\t\tferocity       : 0,\r\n\t\t\tconditionDmg   : 0,\r\n\t\t\texpertise      : 0,\r\n\t\t\tconcentration  : 0,\r\n\t\t\thealing        : 0,\r\n\t\t\tagonyResistance: 0,\r\n\t\t},\r\n\t\tstatSources: {\r\n\t\t\tpower          : [],\r\n\t\t\ttoughness      : [],\r\n\t\t\tvitality       : [],\r\n\t\t\tprecision      : [],\r\n\t\t\tferocity       : [],\r\n\t\t\tconditionDmg   : [],\r\n\t\t\texpertise      : [],\r\n\t\t\tconcentration  : [],\r\n\t\t\thealing        : [],\r\n\t\t\tagonyResistance: [],\r\n\t\t\tdamage         : [],\r\n\t\t\tlifeForce      : [],\r\n\t\t\thealth         : [],\r\n\t\t\thealEffectiveness: [],\r\n\t\t\tstun           : [],\r\n\t\t},\r\n\t\tupgradeCounts: {},\r\n\t},\r\n}\r\nfunction createCompleteContext(partialContext : PartialContext) : Context {\r\n\tif(partialContext.gameMode == \"Pvp\" && partialContext.character?.level && partialContext.character?.level != 80) {\r\n\t\tconsole.error('[gw2-tooltips] [init] supplied (partial) context has its gamemode set to pvp, but has a character level specified thats other than 80. In pvp you are always level 80. This will lead to unexpected results; Remove the explicit level or change the gamemode. The (partial) context in question is: ', partialContext);\r\n\t}\r\n\r\n\tconst stats = Object.assign({}, DEFAULT_CONTEXT.character.stats, partialContext.character?.stats);\r\n\tconst statSources = Object.assign({}, DEFAULT_CONTEXT.character.statSources, partialContext.character?.statSources);\r\n\tconst upgradeCounts = Object.assign({}, partialContext.character?.upgradeCounts);\r\n\tconst character = Object.assign({}, DEFAULT_CONTEXT.character, partialContext.character, { stats, statSources, upgradeCounts });\r\n\treturn Object.assign({}, DEFAULT_CONTEXT, partialContext, { character });\r\n}\r\n\r\nconst DEFAULT_CONFIG : Config = {\r\n\tautoInitialize                : true,\r\n\tautoCollectRuneCounts         : true,\r\n\tautoCollectStatSources        : true,\r\n\tautoCollectSelectedTraits     : true,\r\n\tadjustIncorrectStatIds        : true,\r\n\tadjustTraitedSkillIds         : true,\r\n\tautoInferEquipmentUpgrades    : true,\r\n\tlegacyCompatibility           : true,\r\n\tshowPreciseAbilityTimings     : false,\r\n\tshowFactComputationDetail     : false,\r\n}\r\n\r\nconst LUT_DEFENSE = [\r\n\t115, 120, 125, 129, 133, 137, 142, 146, 150, 154, 162, 168, 175, 182, 189, 196, 202, 209, 216, 223, 232, 240, 248, 257, 265, 274, 282, 290, 299, 307, 319, 330, 341, 352, 363, 374, 385, 396, 407, 418, 431, 443, 456, 469, 481, 494, 506, 519, 532, 544, 560, 575, 590, 606, 621, 636, 651, 666, 682, 697, 714, 731, 748, 764, 781, 798, 815, 832, 848, 865, 885, 905, 924, 943, 963, 982, 1002, 1021, 1040, 1060, 1081, 1102, 1123, 1144, 1165, 1186, 1207, 1228, 1249, 1270, 1291, 1312, 1333, 1354, 1375, 1396, 1417, 1438, 1459, 1480, 1501,\r\n];\r\n\r\nconst LUT_POWER_PLAYER = [\r\n\t170, 173, 176, 179, 182, 185, 188, 191, 194, 197, 202, 207, 212, 217, 222, 227, 232, 237, 242, 247, 253, 259, 265, 271, 277, 283, 289, 295, 301, 307, 315, 323, 331, 339, 347, 355, 363, 371, 379, 387, 396, 405, 414, 423, 432, 441, 450, 459, 468, 477, 488, 499, 510, 521, 532, 543, 554, 565, 576, 587, 599, 611, 623, 635, 647, 659, 671, 683, 695, 707, 721, 735, 749, 763, 777, 791, 805, 819, 833, 847, 862, 877, 892, 907, 922, 937, 952, 967, 982, 997, 1012, 1027, 1042, 1057, 1072, 1087, 1102, 1117, 1132, 1147, 1162,\r\n];\r\n\r\nconst LUT_POWER_MONSTER = [\r\n\t162, 179, 197, 214, 231, 249, 267, 286, 303, 322, 344, 367, 389, 394, 402, 412, 439, 454, 469, 483, 500, 517, 556, 575, 593, 612, 622, 632, 672, 684, 728, 744, 761, 778, 820, 839, 885, 905, 924, 943, 991, 1016, 1067, 1093, 1119, 1145, 1193, 1220, 1275, 1304, 1337, 1372, 1427, 1461, 1525, 1562, 1599, 1637, 1692, 1731, 1802, 1848, 1891, 1936, 1999, 2045, 2153, 2201, 2249, 2298, 2368, 2424, 2545, 2604, 2662, 2723, 2792, 2854, 2985, 3047, 3191, 3269, 3348, 3427, 3508, 3589, 3671, 3754, 3838, 3922, 4007, 4093, 4180, 4267, 4356, 4445, 4535, 4625, 4717, 4809, 4902,\r\n];\r\n\r\nconst LUT_RARITY = {\r\n\tJunk     : 0,\r\n\tBasic    : 0,\r\n\tCommon   : 1,\r\n\tUncommon : 2,\r\n\tRare     : 3,\r\n\tExotic   : 4,\r\n\tAscended : 4,\r\n\tLegendary: 4,\r\n};\r\n\r\nconst LUT_CRITICAL_DEFENSE = [\r\n\t1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3.0, 3.2, 3.4, 3.6, 3.8, 4.0, 4.2, 4.4, 4.6, 4.8, 5.0, 5.2, 5.4, 5.6, 5.8, 6.0, 6.2, 6.4, 6.6, 6.8, 7.0, 7.3, 7.6, 7.9, 8.2, 8.5, 8.8, 9.1, 9.4, 9.7, 10.0, 10.3, 10.6, 10.9, 11.2, 11.5, 11.8, 12.1, 12.4, 12.7, 13.0, 13.4, 13.8, 14.2, 14.6, 15.0, 15.4, 15.8, 16.2, 16.6, 17.0, 17.4, 17.8, 18.2, 18.6, 19.0, 19.4, 19.8, 20.2, 20.6, 21.0, 21.5, 22.0, 22.5, 23.0, 23.5, 24.0, 24.5, 25.0, 25.5, 26.0, 26.5, 27.0, 27.5, 28.0, 28.5, 29.0, 29.5, 30.0, 30.5, 31.0,\r\n];\r\n\r\nexport const ICONS = {\r\n\tCOIN_COPPER     : 156902,\r\n\tCOIN_SILVER     : 156907,\r\n\tCOIN_GOLD       : 156904,\r\n\t//NOTE(Rennorb): lower case to make it compatible with the enum\r\n\tSLOT_Upgrade    : 517197,\r\n\tSLOT_Infusion   : 517202,\r\n\tSLOT_Enrichment : 517204,\r\n\r\n\tRESOURCE_THIEF  : 156649,\r\n\tRESOURCE_REV    : 156647,\r\n\tUPKEEP_COST     : 156058,\r\n\tSUPPLY_COST     : 2111003,\r\n\tENDURANCE_COST  : 156649,\r\n\tNO_UNDERWATER   : 358417,\r\n\tRECHARGE        : 156651,\r\n\tACTIVATION      : 496252,\r\n\tRANGE           : 156666,\r\n\tDEFIANCE_BREAK  : 1938788,\r\n\tWEAPON_SWAP     : 156583,\r\n\tBARRIER         : 1770209,\r\n\tSTUN_BREAK      : 156654,\r\n}\r\n\r\ntype SupportedTTTypes = API.Skill | API.Trait | API.ItemAmulet; //TODO(Rennorb) @cleanup: once its finished\r\n\r\n\r\n_constructor();\r\nif(config.autoInitialize) {\r\n\tconst buildNodes = document.getElementsByClassName('gw2-build-wrapper');\r\n\tif(config.autoCollectSelectedTraits) {\r\n\t\tif(buildNodes.length) for(const target of buildNodes)\r\n\t\t\tCollect.allTraits(context, target)\r\n\t\telse {\r\n\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoCollectSelectedTraits` is active, but no element with class `gw2-build` could be found to use as source. Build information will not be collected as there is no way to tell which objects belong to the build definition and which ones are just in some arbitrary text.\");\r\n\t\t}\r\n\t}\r\n\r\n\thookDocument(document)\r\n\t\t.then(_ => {\r\n\t\t\t//TODO(Rennorb) @cleanup: those routines could probably be combined into one when both options are active\r\n\t\t\tif(config.autoCollectRuneCounts) {\r\n\t\t\t\t//TODO(Rennorb) @correctness: this might not work properly with multiple builds on one page\r\n\t\t\t\tif(buildNodes.length) for(const target of buildNodes)\r\n\t\t\t\t\tCollect.allUpgradeCounts(context, target)\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoCollectRuneCounts` is active, but no element with class `gw2-build` could be found to use as source. Upgrades will not be collected as there is no way to tell which upgrades belongs to the build and which ones are just in some arbitrary text.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoCollectStatSources) {\r\n\t\t\t\tif(buildNodes.length) for(const target of buildNodes)\r\n\t\t\t\t\tCollect.allStatSources(context, target)\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoCollectStatSources` is active, but no element with class `gw2-build` could be found to use as source. Build information will not be collected as there is no way to tell which objects belong to the build definition and which ones are just in some arbitrary text.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoCollectSelectedTraits) {\r\n\t\t\t\tCollect.traitEffects(context);\r\n\t\t\t}\r\n\r\n\t\t\tif(config.autoInferEquipmentUpgrades) {\r\n\t\t\t\tconst targets = document.querySelectorAll('.weapon, .armor, .trinket');\r\n\t\t\t\tif(targets.length)\r\n\t\t\t\t\tinferItemUpgrades(targets)\r\n\t\t\t\telse {\r\n\t\t\t\t\tconsole.warn(\"[gw2-tooltips] [collect] `config.autoInferEquipmentUpgrades` is active, but no wrapper elements element with class `'weapon`, `armor` or `trinket` could be found to use as source. No elements will be updated\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n}\r\n\r\nimport { newElm, newImg, GW2Text2HTML, mapLocale, drawFractional, fromHTML, findSelfOrParent } from './TUtilsV2';\r\nimport * as APIs from './API';\r\nimport APICache from './APICache';\r\nimport { calculateModifier, generateFact, generateFacts } from './FactsProcessor';\r\nimport * as Collect from './Collect'; //TODO(Rennorb) @cleanup\r\nimport { _legacy_transformEffectToSkillObject, inferItemUpgrades, inflateGenericIcon, inflateItem, inflateSkill, inflateSpecialization } from './Inflators'\r\n\r\n"],"names":["newElm","spec","inner","tag","classes","split","el","document","createElement","length","classList","add","append","iconSource","missingImage","newImg","src","className","alt","img","includes","fromHTML","html","dummy","innerHTML","content","GW2Text2HTML","text","formatArgs","replace","replaceAll","_","i","Uncapitalize","str","charAt","toLowerCase","slice","withUpToNDigits","x","digits","toFixed","drawFractional","value","config","showPreciseAbilityTimings","sign","Math","abs","fraction","min","round","floor","mapLocale","type","HSAPI","constructor","baseUrl","this","bulkRequest","endpoint","ids","response","fetch","join","then","r","json","modifierTranslation","BoonDuration","ConditionDamage","ConditionDuration","CritDamage","transformed","obj","tier","modifiers","attribute_","adjustment","Object","entries","attributes","attribute","push","formula","base_amount","id","formula_param1","formula_param2","target_attribute_or_buff","description","flags","subtype","name","icon","flags_ex","tiers","rarity","level","required_level","vendor_value","hsApi","fallback","ex","console","warn","APICache","ensureExistence","initialIds","apiImpl","additionalIds","assign","skills","Set","items","traits","pets","specializations","itemstats","findNextRelevantEndpoint","size","currentEndpoint","storageSet","storage","request","Array","from","values","clear","info","unobtainable","filter","some","datum","has","set","collectConnectedIds","error","connectedIdsStorage","addFacts","facts","fact","buff","prefix","palette","palettes","slot","slots","profession","next_chain","related_skills","subSkill","override_groups","attribute_set","Map","window","MissingBuff","categories","calculateModifier","level_scaling","stats","power","conditionDmg","healing","healing_power","generateFact","weapon_strength","context","iconSlug","buffStackSize","buffDuration","duration","generateBuffDescription","valueMod","modsArray","description_brief","relevantModifiers","modifier","trait_req","character","mode","gameMode","modsMap","entry","get","attribute_conversion","apply_count","strValue","toString","applyMods","detailStack","durMod","durationAttr","buff_type","attribVal","showFactComputationDetail","durModStack","statSources","percentMod","source","count","mod","valueModStack","healEffectiveness","factInflators","AdjustByAttributeAndLevelHealing","attributeVal","target","attribute_multiplier","level_exponent","level_multiplier","hit_count","lines","_a","unshift","AttributeAdjust","range","Buff","buffDescription","seconds","name_brief","BuffBrief","Distance","distance","HealthAdjustHealing","multiplier","Number","Percent","percent","PercentDamage","PercentLifeForceAdjust","hpPool","getHealth","lifeForce","raw","PercentHealth","LifeForceAdjust","Damage","dmg_multiplier","weaponStrength","damage","targetArmor","critChance","precision","critDamage","ferocity","moreDmgFromCrit","times","Time","stun","time","ComboField","field_type","ComboFinisher","finisher_type","BuffConversion","NoData","PrefixedBuff","details","list","generateBuffIcon","PrefixedBuffBrief","Range","max","StunBreak","data","firstLine","remainingDetail","wrapper","requires_trait","defianceBreak","defiance_break","breakDetail","undefined","trait_names","words","quoteWords","map","w","last","joinWordList","skip_next","d","stackSize","wrap","setAttribute","String","allUpgradeCounts","contexts","scope","elements","getElementsByTagName","pair","elsInCorrectCtx","e","getAttribute","_upgradeCounts","elsWithWrongCtx","contextIndex","targetContext","counts","element","item","amountToAdd","legacyCompatibility","_legacy_getInfusionCount","upgradeCounts","GW2TooltipsContext","_b","_c","allStatSources","_statSources","sources","toughness","vitality","expertise","concentration","agonyResistance","health","upgrades","tiersToProcess","tierNumber","log","baseStats","_e","DEFAULT_CONTEXT","_f","attrib","isNaN","s","ownIndex","prototype","indexOf","call","parentElement","children","amountEl","getElementsByClassName","textContent","match","allTraits","querySelectorAll","_traits","specialization","selectedPositions","y","traitEl","forEach","t","inflateGenericIcon","gw2Object","childElementCount","wikiLink","href","contains","cleanName","inflateSkill","skill","contextSet","context_","specializeContextFromInlineAttribs","adjustTraitedSkillIds","replacementSkill","findTraitedOverride","inflateItem","formatItemName","inflateSpecialization","style","backgroundImage","background","dataset","label","column","toggle","_legacy_transformEffectToSkillObject","error_store","blight","bloodstone_blessed","blue_pylon_power","chill","quickness","chilled","fear","alacrity","protection","vigor","barrier","fury","stability","stunbreak","aegis","might","regeneration","immobilize","slow","resistance","champion_of_the_legions","compromised","crowd_favor","curse_of_frailty","dark_aura","debilitated","debilitating_void","defense_up","derangement","elemental_empowerment","empowering_auras","equalization_matrix","exposed","expose_weakness","extreme_vulnerability","fixated","growing_rage_ashym","ignite","intervention","invulnerability","necrosis","not_sticking_together","nova","ooze_pheromone","photon_saturation","positive_flow","power_of_the_void","reinforced_armor","relentless_fire","retaliation_ashym","sentinel_retribution","shattering_ice","shell_shocked","spectral_darkness","sticking_together","synchronized_vitality","unnatural_signet","use_soul_binder","void_empowerment","xeras_embrace","hardCoded","ICONS","BARRIER","STUN_BREAK","innerText","title","cursor","tooltip","lastTooltipTarget","lastMouseX","lastMouseY","cyclePos","displayCorrectChainTooltip","tooltips","tooltipIndex","index","positionTooltip","wpadminbar","getElementById","topBarHeight","offsetHeight","tooltipXpos","offsetWidth","documentElement","clientWidth","tooltipYpos","scrollTop","transform","hookDocument","_unused","objectsToGet","statsToGet","_legacy_effectErrorStore","objId","elementsWithThisId","addEventListener","showTooltipFor","display","Promise","all","async","key","inflator","cache","keys","objects","visibleIndex","statId","replaceChildren","statSetId","statSet","slottedItems","adjustIncorrectStatIds","similar_sets","correctSetId","newSet","countPrefix","upgradeNameSource","find","parts","defense","LUT_DEFENSE","minRarity","scaling","LUT_RARITY","avg","isPlayer","LUT_POWER_PLAYER","LUT_POWER_MONSTER","mul","spread","ceil","generateUpgradeItemGroup","base_value","attribute_base","slottedItemIdx","findIndex","slottedItem","splice","group","prepend","metaInfo","weight","isTwoHanded","salvageOptions","formatCoins","generateItemTooltip","initialAPIObject","objectChain","validPaletteTypes","addObjectsToChain","currentObj","hasChain","nextSkillInChain","subSkillId","subSkillInChain","tooltipChain","apiObject","headerElements","currentContextInformation","resolveTraitsAndOverrides","activation","ACTIVATION","resource_cost","RESOURCE_REV","RESOURCE_THIEF","endurance_cost","ENDURANCE_COST","upkeep_cost","UPKEEP_COST","recharge","RECHARGE","supply_cost","SUPPLY_COST","secondHeaderRow","slotName","skillSlot","weapon_type","hand","digit","getSlotName","baseContext","override","delete","splits","o","splits_html","marginTop","marginBottom","criteria","relevantPalette","p","palette_type","BundleLarge","Standard","Focus","Shield","Torch","Warhorn","Greatsword","Hammer","Staff","BowLong","Rifle","BowShort","Axe","Sword","Dagger","Pistol","Scepter","Mace","Spear","Speargun","Trident","getWeaponStrength","totalDefianceBreak","factWraps","sort","a","b","order","defianceWrap","DEFIANCE_BREAK","generateFacts","generateToolTip","generateToolTipList","g","result","insert_before","finalFacts","Guardian","Thief","Elementalist","Engineer","Ranger","Mesmer","Revenant","Necromancer","Warrior","traited_alternatives","traitId","altId","tier_wrap","flexDirection","modifierValue","colorClass","upgradeComponent","arg1","arg2","arg3","arg4","trait","suffix","sex","traitOverrides","structuredClone","invalid","v","amount","COIN_COPPER","COIN_SILVER","COIN_GOLD","createCompleteContext","partialContext","_d","DEFAULT_CONFIG","autoInitialize","autoCollectRuneCounts","autoCollectStatSources","autoCollectSelectedTraits","autoInferEquipmentUpgrades","Junk","Basic","Common","Uncommon","Rare","Exotic","Ascended","Legendary","SLOT_Upgrade","SLOT_Infusion","SLOT_Enrichment","NO_UNDERWATER","RANGE","WEAPON_SWAP","GW2TooltipsConfig","APIs","body","appendChild","isMobile","test","navigator","userAgent","touch","event","pageX","pageY","node","self","selector","depth","current","matches","findSelfOrParent","preventDefault","scrollHandler","activeTT","scrollHeight","clientHeight","deltaY","detail","touches","clientY","scrollBy","passive","ctrlKey","altKey","_constructor","buildNodes","Collect.allTraits","Collect.allUpgradeCounts","Collect.allStatSources","addModifiers","contextBoundInfo","Collect.traitEffects","targets","wrappers","remainingInfusionsByContext","ctx","c","enrichmentByContext","itemEl","upgradeEls","itemCtx","upgradeIds","u","remainingInfusions","infusionId","enrichment","attrString","inferItemUpgrades"],"mappings":"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"}